# ๐ฑโก ูุตู Spot ู Futures ูู ุงููุญูุธุฉ ูุงูุฅุญุตุงุฆูุงุช

## โ ุงูุชุญุฏูุซุงุช ุงูููุชููุฉ

### 1. ูุงุนุฏุฉ ุงูุจูุงูุงุช - ุฏุนู Spot/Futures ูููุตู
**ุงูููู:** `users/database.py`

#### ๐ ุงูุฏูุงู ุงูุฌุฏูุฏุฉ:

##### ุฃ) `get_portfolio_evolution()` - ูุญุณููุฉ
```python
get_portfolio_evolution(user_id, account_type, days, market_type=None)
```
- **market_type=None**: ูุนุฑุถ ุงูุฑุตูุฏ ุงูุฅุฌูุงูู
- **market_type='spot'**: ูุนุฑุถ ุฑุตูุฏ Spot ููุท
- **market_type='futures'**: ูุนุฑุถ ุฑุตูุฏ Futures ููุท

##### ุจ) `get_portfolio_evolution_by_market()` - ุฌุฏูุฏุฉ
```python
get_portfolio_evolution_by_market(user_id, account_type, market_type, days)
```
- ุชุฌูุจ ุชุทูุฑ ุงููุญูุธุฉ ูุณูู ูุญุฏุฏ (Spot ุฃู Futures)
- ุชุณุชุฎุฏู ุงูุญููู `spot_balance` ู `futures_balance` ูู ุฌุฏูู `portfolio_snapshots`

---

### 2. ูุธุงู ุงูุฅุญุตุงุฆูุงุช ุงููุชูุฏู - ุฏุนู Spot/Futures
**ุงูููู:** `systems/advanced_statistics.py`

#### ๐ ุงูุฏูุงู ุงููุญุฏูุซุฉ:

##### ุฃ) `calculate_trade_statistics()` - ูุญุณููุฉ
```python
calculate_trade_statistics(user_id, account_type, days, market_type=None)
```
- ูุถูู ููุชุฑ `market_type` ุฅูู `filters` ุนูุฏ ุงูุงุณุชุนูุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ูุญุณุจ ุงูุฅุญุตุงุฆูุงุช ูุณูู ูุญุฏุฏ ุฃู ูููู

##### ุจ) `format_statistics_message()` - ูุญุณููุฉ
```python
format_statistics_message(user_id, account_type, days, market_type=None)
```
**ูุนุฑุถ:**
```
๐ฎ ุญุณุงุจ ุชุฌุฑูุจู | ๐ฑ SPOT
๐ ADVANCED STATISTICS (30 ููู)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ ุฃุฏุงุก ุงููุญูุธุฉ:
โข ุงูุนุงุฆุฏ ุงูุฅุฌูุงูู: +234.56 USDT (+2.35%)
โข ุฃุนูู ุฑุตูุฏ: 10,234.56 USDT
...

๐ผ ุฅุญุตุงุฆูุงุช ุงูุตููุงุช:
โข ุฅุฌูุงูู ุงูุตููุงุช: 15 (Spot ููุท)
โข ูุนุฏู ุงูููุฒ: 66.7%
...
```

**ุงูุฃุฒุฑุงุฑ ุงูุฌุฏูุฏุฉ:**
```
[๐ ุงููู] [๐ฑ Spot] [โก Futures]
[๐ 7ุฏ] [๐ 30ุฏ] [๐ 90ุฏ]
[๐ ุชุทูุฑ ุงููุญูุธุฉ] [๐ ุชุญุฏูุซ]
[๐ ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ]
```

##### ุฌ) `format_portfolio_evolution_message()` - ูุญุณููุฉ
```python
format_portfolio_evolution_message(user_id, account_type, days, market_type=None)
```
**ูุนุฑุถ:**
```
๐ฎ ุญุณุงุจ ุชุฌุฑูุจู | โก FUTURES
๐ PORTFOLIO EVOLUTION (30 ููู)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ Max: 5,234.56
โโฑโฑโโฒโฑโฑโโโฑโฑโฑโฑโโฒโฒโโโฑโฑโฑ
๐ Min: 4,876.54

๐ฐ ุงูุฑุตูุฏ:
โข ุงูุจุฏุงูุฉ: 5,000.00 USDT
โข ุงูุญุงูู: 5,234.56 USDT
โข ุงูุชุบูุฑ: +234.56 USDT (+4.69%) ๐ข

๐ ุงูุงุชุฌุงู: ุตุงุนุฏ

๐ ุงููุชุฑุฉ:
โข ูู: 2025-01-01
โข ุฅูู: 2025-01-30
โข ุนุฏุฏ ุงูุฃูุงู: 30

๐ ุขุฎุฑ 5 ุฃูุงู:
โข 2025-01-26: 5,100.23 USDT
โข 2025-01-27: 5,150.45 USDT
โข 2025-01-28: 5,200.67 USDT
โข 2025-01-29: 5,180.89 USDT
โข 2025-01-30: 5,234.56 USDT
```

**ุงูุฃุฒุฑุงุฑ ุงูุฌุฏูุฏุฉ:**
```
[๐ ุงููู] [๐ฑ Spot] [โก Futures]
[๐ 7ุฏ] [๐ 30ุฏ] [๐ 90ุฏ]
[๐ 365ุฏ]
[๐ ุงูุฅุญุตุงุฆูุงุช] [๐ ุชุญุฏูุซ]
[๐ ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ]
```

---

### 3. ุงูุชูุงูู ูุน ุงูุจูุช - ูุนุงูุฌุงุช Callback ูุญุณููุฉ
**ุงูููู:** `bybit_trading_bot.py`

#### ๐ ุงููุนุงูุฌุงุช ุงููุญุฏูุซุฉ:

##### ุฃ) ูุนุงูุฌ `stats_` - ูุญุณูู
```python
if data.startswith("stats_"):
    parts = data.split("_")
    account_type = parts[1]
    days = int(parts[2])
    market_type = parts[3] if len(parts) >= 4 else None  # ๐ ุฏุนู market_type
```

**ุฃูุซูุฉ ุนูู callback_data:**
- `stats_demo_30` โ ุฅุญุตุงุฆูุงุช ุชุฌุฑูุจูุฉุ 30 ูููุ ุงููู
- `stats_demo_30_spot` โ ุฅุญุตุงุฆูุงุช ุชุฌุฑูุจูุฉุ 30 ูููุ Spot ููุท
- `stats_real_7_futures` โ ุฅุญุตุงุฆูุงุช ุญููููุฉุ 7 ุฃูุงูุ Futures ููุท

##### ุจ) ูุนุงูุฌ `portfolio_evolution_` - ูุญุณูู
```python
if data.startswith("portfolio_evolution_"):
    parts = data.replace("portfolio_evolution_", "").split("_")
    account_type = parts[0]
    days = int(parts[1])
    market_type = parts[2] if len(parts) >= 3 else None  # ๐ ุฏุนู market_type
```

**ุฃูุซูุฉ ุนูู callback_data:**
- `portfolio_evolution_demo_30` โ ูุญูุธุฉ ุชุฌุฑูุจูุฉุ 30 ูููุ ุงููู
- `portfolio_evolution_demo_30_spot` โ ูุญูุธุฉ ุชุฌุฑูุจูุฉุ 30 ูููุ Spot ููุท
- `portfolio_evolution_real_90_futures` โ ูุญูุธุฉ ุญููููุฉุ 90 ูููุ Futures ููุท

---

## ๐ฏ ููููุฉ ุงูุงุณุชุฎุฏุงู

### 1. ุนุฑุถ ุงููุญูุธุฉ ูุน ูุตู Spot/Futures:
```
/portfolio
```

**ุงูุฎุทูุงุช:**
1. ูุนุฑุถ ุงููุญูุธุฉ ุงูุฅุฌูุงููุฉ (Spot + Futures)
2. ุงุถุบุท ุนูู **๐ฑ Spot** ูุนุฑุถ ุฑุตูุฏ Spot ููุท
3. ุงุถุบุท ุนูู **โก Futures** ูุนุฑุถ ุฑุตูุฏ Futures ููุท
4. ุงุถุบุท ุนูู **๐ ุงููู** ููุนูุฏุฉ ููุนุฑุถ ุงูุฅุฌูุงูู

### 2. ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช ูุน ูุตู Spot/Futures:
```
/statistics
```

**ุงูุฎุทูุงุช:**
1. ูุนุฑุถ ุงูุฅุญุตุงุฆูุงุช ุงูุฅุฌูุงููุฉ (ุฌููุน ุงูุตููุงุช)
2. ุงุถุบุท ุนูู **๐ฑ Spot** ูุนุฑุถ ุฅุญุตุงุฆูุงุช Spot ููุท
3. ุงุถุบุท ุนูู **โก Futures** ูุนุฑุถ ุฅุญุตุงุฆูุงุช Futures ููุท
4. ุงุถุบุท ุนูู **๐ ุงููู** ููุนูุฏุฉ ููุนุฑุถ ุงูุฅุฌูุงูู

### 3. ุงูุชุจุฏูู ุจูู ุงููุชุฑุงุช ุงูุฒูููุฉ:
- **๐ 7ุฏ**: ุขุฎุฑ 7 ุฃูุงู
- **๐ 30ุฏ**: ุขุฎุฑ 30 ููู
- **๐ 90ุฏ**: ุขุฎุฑ 90 ููู
- **๐ 365ุฏ**: ุขุฎุฑ ุณูุฉ (ูููุญูุธุฉ ููุท)

---

## ๐ ุงููุตู ุจูู Demo ู Real

### โ ุงูุญุณุงุจุงุช ุงูุชุฌุฑูุจูุฉ (Demo):
- **ูุตุฏุฑ ุงูุจูุงูุงุช:** ูุงุนุฏุฉ ุงูุจูุงูุงุช (`trading_bot.db`)
- **ุงูุฌุฏุงูู ุงููุณุชุฎุฏูุฉ:**
  - `orders` - ุงูุตููุงุช ุงูููุชูุญุฉ ูุงููุบููุฉ
  - `portfolio_snapshots` - ุงูููุทุงุช ุงูููููุฉ
  - `users` - ุจูุงูุงุช ุงููุณุชุฎุฏู ูุงูุฑุตูุฏ
- **ุงูุชุญุฏูุซ:** ูุชู ุญูุธ ูู ุตููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- **ุงูุฑุตูุฏ:** ููุญูุธ ูู `users.balance` ูููุญุฏูุซ ุจุนุฏ ูู ุตููุฉ

### โ ุงูุญุณุงุจุงุช ุงูุญููููุฉ (Real):
- **ูุตุฏุฑ ุงูุจูุงูุงุช:** API ุงูููุตุฉ (Bybit/Binance/Bitget)
- **ุงูุฌุฏุงูู ุงููุณุชุฎุฏูุฉ:**
  - `orders` - ูุณุฎุฉ ูุญููุฉ ููุตููุงุช (ููุณุฌู)
  - `portfolio_snapshots` - ุงูููุทุงุช ุงูููููุฉ
- **ุงูุชุญุฏูุซ:** ูุชู ุฌูุจ ุงูุจูุงูุงุช ูุจุงุดุฑุฉ ูู API
- **ุงูุฑุตูุฏ:** ููุฌูุจ ูู API ุงูููุตุฉ

---

## ๐ ุขููุฉ ุงูุญูุธ ูุงูุฌูุจ

### 1. ุญูุธ ุงูููุทุงุช ุงูููููุฉ:
```python
# ูุชู ุงุณุชุฏุนุงุคูุง ุชููุงุฆูุงู ุนูุฏ ุนุฑุถ ุงููุญูุธุฉ ุฃู ุงูุฅุญุตุงุฆูุงุช
advanced_stats.save_daily_snapshot(user_id, account_type)
```

**ุงูุจูุงูุงุช ุงููุญููุธุฉ:**
- `balance`: ุงูุฑุตูุฏ ุงูุฅุฌูุงูู
- `spot_balance`: ุฑุตูุฏ Spot
- `futures_balance`: ุฑุตูุฏ Futures
- `total_pnl`: ุฅุฌูุงูู ุงูุฑุจุญ/ุงูุฎุณุงุฑุฉ
- `open_positions_count`: ุนุฏุฏ ุงูุตููุงุช ุงูููุชูุญุฉ
- `closed_trades_count`: ุนุฏุฏ ุงูุตููุงุช ุงููุบููุฉ
- `winning_trades`: ุนุฏุฏ ุงูุตููุงุช ุงูุฑุงุจุญุฉ
- `losing_trades`: ุนุฏุฏ ุงูุตููุงุช ุงูุฎุงุณุฑุฉ
- `total_volume`: ุญุฌู ุงูุชุฏุงูู

### 2. ุฌูุจ ุงูุจูุงูุงุช ุญุณุจ ููุน ุงูุญุณุงุจ:

#### ุฃ) Demo Account:
```python
# ุฌูุจ ุงูุตููุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
trades = db_manager.get_user_trade_history(user_id, {
    'status': 'CLOSED',
    'account_type': 'demo',
    'market_type': 'spot'  # ุฃู 'futures' ุฃู None ูููู
})

# ุฌูุจ ุชุทูุฑ ุงููุญูุธุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
snapshots = db_manager.get_portfolio_evolution_by_market(
    user_id, 'demo', 'spot', days=30
)
```

#### ุจ) Real Account:
```python
# ุฌูุจ ุงูุตููุงุช ูู API
from api.bybit_api import real_account_manager
api_client = real_account_manager.get_account(user_id)
positions = api_client.get_open_positions('linear')  # Futures
# ุฃู
positions = api_client.get_open_positions('spot')  # Spot

# ุฌูุจ ุชุทูุฑ ุงููุญูุธุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุงูููุทุงุช ุงููุญููุธุฉ)
snapshots = db_manager.get_portfolio_evolution_by_market(
    user_id, 'real', 'futures', days=30
)
```

---

## ๐ ุฃูุซูุฉ ุนูู ุงูุงุณุชุฎุฏุงู

### ูุซุงู 1: ุนุฑุถ ูุญูุธุฉ Spot ุงูุชุฌุฑูุจูุฉ ูุขุฎุฑ 7 ุฃูุงู
```
1. /portfolio
2. ุงุถุบุท ุนูู [๐ฑ Spot]
3. ุงุถุบุท ุนูู [๐ 7ุฏ]
```
**ุงููุชูุฌุฉ:**
- ูุนุฑุถ ุฑุณู ุจูุงูู ูุชุทูุฑ ุฑุตูุฏ Spot ููุท
- ูุนุฑุถ ุงูุฑุตูุฏ ุงูุญุงูู ูู Spot
- ูุนุฑุถ ุงูุชุบูุฑ ุฎูุงู ุขุฎุฑ 7 ุฃูุงู

### ูุซุงู 2: ุนุฑุถ ุฅุญุตุงุฆูุงุช Futures ุงูุญููููุฉ ูุขุฎุฑ 90 ููู
```
1. /statistics
2. ุงุถุบุท ุนูู [โก Futures]
3. ุงุถุบุท ุนูู [๐ 90ุฏ]
```
**ุงููุชูุฌุฉ:**
- ูุนุฑุถ ุฅุญุตุงุฆูุงุช ุตููุงุช Futures ููุท
- ูุนุฑุถ ูุนุฏู ุงูููุฒุ Profit Factorุ ุฅูุฎ
- ูุนุฑุถ ุฃูุถู/ุฃุณูุฃ ุตููุฉ ูู Futures

### ูุซุงู 3: ุงูููุงุฑูุฉ ุจูู Spot ู Futures
```
1. /portfolio
2. ุงุถุบุท ุนูู [๐ฑ Spot] โ ุดุงูุฏ ุฑุตูุฏ Spot
3. ุงุถุบุท ุนูู [โก Futures] โ ุดุงูุฏ ุฑุตูุฏ Futures
4. ุงุถุบุท ุนูู [๐ ุงููู] โ ุดุงูุฏ ุงูุฑุตูุฏ ุงูุฅุฌูุงูู
```

---

## ๐ ุงูุชุฑุงุจุท ุงููุงูู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช

### โ ุฌููุน ุงูุจูุงูุงุช ูุญููุธุฉ:
1. **ุงูุตููุงุช** โ `orders` (ูุน `market_type`)
2. **ุงูููุทุงุช ุงูููููุฉ** โ `portfolio_snapshots` (ูุน `spot_balance` ู `futures_balance`)
3. **ุฅุนุฏุงุฏุงุช ุงููุณุชุฎุฏู** โ `user_settings` (ูุน `market_type`)
4. **ุจูุงูุงุช ุงููุณุชุฎุฏู** โ `users` (ูุน `balance`)

### ๐ ุงูุชุญุฏูุซ ุงูุชููุงุฆู:
- ูุชู ุญูุธ ููุทุฉ ููููุฉ ูุงุญุฏุฉ (INSERT OR REPLACE)
- ูุชู ุชุญุฏูุซ `spot_balance` ู `futures_balance` ุชููุงุฆูุงู
- ุงูุจูุงูุงุช ุฏุงุฆูุฉ ููุง ุชูููุฏ ุนูุฏ ุฅุนุงุฏุฉ ุงูุชุดุบูู

### ๐๏ธ ุฅุนุงุฏุฉ ุงูุชุนููู:
- ุนูุฏ "ุฅุนุงุฏุฉ ุชุนููู ูู ุงููุดุฑูุน"
- ูุชู ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุจูุง ูููุง ุงูููุทุงุช
- ูุชู ุฅุนุงุฏุฉ ุฅูุดุงุก ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ุงูุตูุฑ

---

## ๐ ุงูุฎูุงุตุฉ

ุชู ุชุทููุฑ ูุธุงู ูุชูุฏู ููุตู Spot ู Futures ูุดูู:

โ **ูุงุนุฏุฉ ุจูุงูุงุช ูุญุณููุฉ** ูุน ุฏุนู `spot_balance` ู `futures_balance`
โ **ุฏูุงู ุฌุฏูุฏุฉ** ูุฌูุจ ุงูุจูุงูุงุช ุญุณุจ ููุน ุงูุณูู
โ **ุฅุญุตุงุฆูุงุช ูููุตูุฉ** ูู Spot ู Futures
โ **ุฑุณูู ุจูุงููุฉ ูููุตูุฉ** ูุชุทูุฑ ูู ุณูู
โ **ุฃุฒุฑุงุฑ ุชูุงุนููุฉ** ููุชุจุฏูู ุจูู Spot/Futures/ุงููู
โ **ูุตู ูุงูู** ุจูู Demo (ูู DB) ู Real (ูู API)
โ **ุชุฑุงุจุท ูุงูู** ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช
โ **ุญูุธ ุชููุงุฆู** ููุจูุงูุงุช

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุงูููุทุงุช ุงูููููุฉ** ุชูุญูุธ ูุน `spot_balance` ู `futures_balance` ูููุตููู
2. **ุงูููุงุชุฑ** ุชุนูู ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุณุฑูุนุฉ ููุนุงูุฉ)
3. **ุงูุจูุงูุงุช ุงูุญููููุฉ** ุชูุฌูุจ ูู API ูููู ุงูููุทุงุช ุชูุญูุธ ูู DB
4. **ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ** ุชูุฌูุจ ุจุงููุงูู ูู DB
5. **ุงูุชุจุฏูู** ุจูู Spot/Futures ููุฑู ูุจุฏูู ุชุฃุฎูุฑ

---

**๐ฏ ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู ุจุงููุงูู ูุน ูุตู ุชุงู ุจูู Spot ู Futures!**

