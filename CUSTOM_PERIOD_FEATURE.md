# ميزة اختيار الفترة الزمنية المخصصة للإحصائيات

## 📋 نظرة عامة
تم إضافة ميزة جديدة تسمح للمستخدمين باختيار فترة زمنية مخصصة لعرض إحصائيات حساباتهم، بدلاً من الفترة الافتراضية (30 يوم).

## ✨ المميزات الجديدة

### 1. خيارات سريعة للفترات الشائعة
- 7 أيام
- 14 يوم
- 30 يوم (افتراضي)
- 60 يوم
- 90 يوم
- 180 يوم
- 365 يوم (سنة كاملة)

### 2. إدخال مخصص
- يمكن للمستخدم إدخال أي عدد من الأيام
- الحد الأدنى: 1 يوم
- الحد الأقصى: 3650 يوم (10 سنوات)
- أمثلة: 20، 234، 500

## 🎯 كيفية الاستخدام

### الخطوة 1: الوصول إلى قائمة "حسابي"
1. افتح البوت
2. اضغط على زر "💼 حسابي"

### الخطوة 2: تغيير الفترة الزمنية
1. اضغط على زر "📅 تغيير الفترة الزمنية"
2. اختر من الخيارات السريعة أو اضغط "✏️ إدخال مخصص"

### الخطوة 3: الإدخال المخصص (اختياري)
1. إذا اخترت "إدخال مخصص"
2. أدخل عدد الأيام (مثال: 20 أو 234)
3. سيتم عرض الإحصائيات للفترة المحددة

## 🔧 التغييرات التقنية

### ملف: `bybit_trading_bot.py`

#### 1. دالة جديدة: `my_account_with_period`
```python
async def my_account_with_period(update: Update, context: ContextTypes.DEFAULT_TYPE, days: int = 30)
```
- تعرض نظرة عامة على الحساب مع فترة زمنية مخصصة
- تدعم `CallbackQuery` و `Message`
- تحسب الإحصائيات بناءً على الفترة المحددة

#### 2. معالجات Callback جديدة
- `change_stats_period`: عرض خيارات الفترة الزمنية
- `set_period_7`, `set_period_14`, إلخ: تعيين فترات محددة
- `set_period_custom`: طلب إدخال مخصص
- `refresh_my_account_{days}`: تحديث مع الفترة المحددة
- `view_portfolio_chart_{days}`: عرض تطور المحفظة للفترة المحددة
- `view_advanced_stats_{days}`: عرض إحصائيات متقدمة للفترة المحددة

#### 3. معالج إدخال نصي جديد
```python
elif state == "waiting_for_custom_period":
    # معالجة إدخال فترة زمنية مخصصة
    days = int(text)
    # التحقق من الصحة (1-3650)
    await my_account_with_period(update, context, days)
```

#### 4. تحديثات على الأزرار
- إضافة زر "📅 تغيير الفترة الزمنية" في قائمة "حسابي"
- تحديث أزرار "تطور المحفظة" و"إحصائيات متقدمة" لتمرير الفترة الزمنية

## 📊 البيانات المعروضة

### الرصيد والأموال
- الرصيد الكلي
- الرصيد المتاح
- الأموال المحجوزة في الصفقات
- الربح/الخسارة للفترة المحددة

### إحصائيات التداول (للفترة المحددة)
- عدد الصفقات المفتوحة
- إجمالي الصفقات المغلقة
- عدد الصفقات الرابحة ونسبتها
- عدد الصفقات الخاسرة
- أفضل صفقة
- أسوأ صفقة

## 🎨 واجهة المستخدم

### رسالة عرض الفترة الزمنية
```
📅 **اختر الفترة الزمنية للإحصائيات**

اختر من الفترات السريعة أو أدخل عدد أيام مخصص:

💡 **ملاحظة:** كلما زادت الفترة، زادت دقة التحليل
```

### رسالة الإدخال المخصص
```
✏️ **إدخال فترة زمنية مخصصة**

أدخل عدد الأيام التي تريد عرض إحصائياتها:

💡 **أمثلة:**
• 20 → آخر 20 يوم
• 234 → آخر 234 يوم
• 500 → آخر 500 يوم

⚠️ **ملاحظة:** الحد الأدنى 1 يوم، الحد الأقصى 3650 يوم (10 سنوات)
```

## ✅ التحقق من الصحة

### قواعد التحقق
1. **الحد الأدنى**: يجب أن يكون عدد الأيام >= 1
2. **الحد الأقصى**: يجب أن يكون عدد الأيام <= 3650
3. **نوع البيانات**: يجب أن يكون رقم صحيح (integer)

### رسائل الخطأ
- "❌ عدد الأيام يجب أن يكون على الأقل 1"
- "❌ عدد الأيام يجب أن لا يتجاوز 3650 يوم (10 سنوات)"
- "❌ يرجى إدخال رقم صحيح"

## 🔄 التكامل مع الأنظمة الموجودة

### تكامل مع `advanced_stats`
- `format_portfolio_evolution_message(user_id, account_type, days=days)`
- `format_statistics_message(user_id, account_type, days=days)`

### تكامل مع `db_manager`
- `get_user_trade_history(user_id, filters={'status': 'CLOSED', 'date_from': start_date})`

## 📝 ملاحظات مهمة

1. **الفترة الافتراضية**: 30 يوم (تُستخدم عند عدم تحديد فترة)
2. **حساب التاريخ**: يتم حساب تاريخ البداية باستخدام `datetime.now() - timedelta(days=days)`
3. **التوافق**: الأزرار القديمة ("تطور المحفظة"، "إحصائيات متقدمة") تستخدم الفترة الافتراضية 30 يوم
4. **الحالة المستمرة**: عند تحديد فترة، تبقى مفعلة حتى يتم تغييرها

## 🚀 أمثلة الاستخدام

### مثال 1: عرض آخر 20 يوم
```
المستخدم: يضغط "💼 حسابي"
المستخدم: يضغط "📅 تغيير الفترة الزمنية"
المستخدم: يضغط "✏️ إدخال مخصص"
المستخدم: يكتب "20"
البوت: يعرض إحصائيات آخر 20 يوم
```

### مثال 2: عرض آخر 234 يوم
```
المستخدم: يضغط "💼 حسابي"
المستخدم: يضغط "📅 تغيير الفترة الزمنية"
المستخدم: يضغط "✏️ إدخال مخصص"
المستخدم: يكتب "234"
البوت: يعرض إحصائيات آخر 234 يوم
```

### مثال 3: استخدام خيار سريع
```
المستخدم: يضغط "💼 حسابي"
المستخدم: يضغط "📅 تغيير الفترة الزمنية"
المستخدم: يضغط "90 يوم"
البوت: يعرض إحصائيات آخر 90 يوم
```

## 🎯 الفوائد

1. **مرونة أكبر**: المستخدم يتحكم في الفترة الزمنية
2. **تحليل أفضل**: إمكانية مقارنة فترات مختلفة
3. **سهولة الاستخدام**: خيارات سريعة + إدخال مخصص
4. **دقة عالية**: التحقق من صحة الإدخال
5. **تجربة محسنة**: واجهة واضحة وسهلة

## 🔍 اختبار الميزة

### سيناريوهات الاختبار
1. ✅ اختيار فترة سريعة (7، 14، 30، إلخ)
2. ✅ إدخال مخصص صحيح (20، 234، 500)
3. ✅ إدخال أقل من الحد الأدنى (0، -5)
4. ✅ إدخال أكبر من الحد الأقصى (4000، 10000)
5. ✅ إدخال غير صحيح (نص، رموز)
6. ✅ عرض تطور المحفظة مع الفترة المحددة
7. ✅ عرض إحصائيات متقدمة مع الفترة المحددة
8. ✅ تحديث البيانات مع الاحتفاظ بالفترة

## 📅 تاريخ الإضافة
- **التاريخ**: 30 أكتوبر 2025
- **الإصدار**: 2.0
- **الحالة**: ✅ مكتمل ومختبر

