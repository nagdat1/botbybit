#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Ù…Ø¹Ø§Ù„Ø¬ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Callback Errors Handler
ÙŠØ¹Ø§Ù„Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆÙŠØ¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ø¶Ø­Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
"""

import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes

logger = logging.getLogger(__name__)


class UnknownCommandHandler:
    """Ù…Ø¹Ø§Ù„Ø¬ Ù„Ù„Ø£ÙˆØ§Ù…Ø± ØºÙŠØ± Ø§Ù„Ù…Ø¹Ø±ÙˆÙØ©"""
    
    @staticmethod
    async def handle_unknown_callback(update: Update, context: ContextTypes.DEFAULT_TYPE, callback_data: str):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù…Ø± ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…"""
        query = update.callback_query
        user_id = update.effective_user.id if update.effective_user else None
        
        logger.warning(f"âš ï¸ Ø£Ù…Ø± ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…: {callback_data} Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}")
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙˆØ§Ø¶Ø­Ø©
        message = f"""
âš ï¸ **Ø£Ù…Ø± ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…**

âŒ `{callback_data}`

ğŸ“ **Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹**
ğŸ”§ Ù‚Ø¯ ÙŠÙƒÙˆÙ†:
â€¢ Ù…ÙŠØ²Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±
â€¢ ØªÙ… Ø¥Ø²Ø§Ù„ØªÙ‡Ø§ Ù…Ù† Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
â€¢ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø³ÙŠØ§Ù‚

ğŸ’¡ **ÙŠÙ…ÙƒÙ†Ùƒ:**
â€¢ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
â€¢ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
â€¢ ØªØ¬Ø±Ø¨Ø© Ø£ÙˆØ§Ù…Ø± Ø£Ø®Ø±Ù‰

ğŸ†˜ **Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©:**
Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ /start Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
"""
        
        keyboard = [
            [InlineKeyboardButton("ğŸ  Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", callback_data="main_menu")],
            [InlineKeyboardButton("âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", callback_data="settings")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        try:
            await query.edit_message_text(
                message,
                reply_markup=reply_markup,
                parse_mode='Markdown'
            )
        except Exception as e:
            logger.error(f"âŒ ÙØ´Ù„ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£: {e}")
            try:
                await query.answer("âš ï¸ Ø£Ù…Ø± ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…")
            except:
                pass


async def handle_callback_error(update: Update, context: ContextTypes.DEFAULT_TYPE, error: Exception, callback_data: str = ""):
    """Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„Ù€ callbacks"""
    logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© callback: {callback_data or update.callback_query.data if update.callback_query else 'unknown'}")
    logger.error(f"ğŸ“‹ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„ÙƒØ§Ù…Ù„: {str(error)}")
    logger.error(f"ğŸ“Š Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£: {type(error).__name__}")
    
    # Ø·Ø¨Ø§Ø¹Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£
    import traceback
    logger.error(f"ğŸ“ Traceback:\n{traceback.format_exc()}")
    
    query = update.callback_query
    user_id = update.effective_user.id if update.effective_user else None
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙˆØ§Ø¶Ø­Ø©
    error_type = type(error).__name__
    error_message = str(error)
    
    # Ø±Ø³Ø§Ø¦Ù„ Ø®Ø·Ø£ Ù…Ø®ØµØµØ© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£
    if "ImportError" in error_type or "ModuleNotFoundError" in error_type:
        user_message = """
âŒ **Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª**

âš ï¸ **Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:** Ø¹Ø·Ù„ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª

ğŸ”§ **Ø§Ù„Ø­Ù„:**
â€¢ ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ«Ø¨ÙŠØª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
â€¢ Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
â€¢ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø±
"""
    elif "ConnectionError" in error_type or "Timeout" in error_message:
        user_message = """
âŒ **Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„**

âš ï¸ **Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:** ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…

ğŸ”§ **Ø§Ù„Ø­Ù„:**
â€¢ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
â€¢ Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø«Ù… Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
â€¢ Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø±Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŒ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…
"""
    elif "KeyError" in error_type or "AttributeError" in error_type:
        user_message = """
âŒ **Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª**

âš ï¸ **Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:** Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©

ğŸ”§ **Ø§Ù„Ø­Ù„:**
â€¢ Ø­Ø§ÙˆÙ„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
â€¢ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
â€¢ Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
"""
    else:
        user_message = f"""
âŒ **Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹**

âš ï¸ **ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:**
`{error_type}: {error_message[:100]}`

ğŸ”§ **Ù…Ø§Ø°Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ÙØ¹Ù„Ù‡:**
â€¢ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„
â€¢ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
â€¢ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø±Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø©

ğŸ“ **Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯:** Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
"""
    
    keyboard = [
        [InlineKeyboardButton("ğŸ”„ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰", callback_data="settings")],
        [InlineKeyboardButton("ğŸ  Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", callback_data="main_menu")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    try:
        await query.edit_message_text(
            user_message,
            reply_markup=reply_markup,
            parse_mode='Markdown'
        )
    except Exception as e:
        logger.error(f"âŒ ÙØ´Ù„ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£: {e}")
        try:
            await query.answer("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£")
        except:
            pass


async def handle_general_error(update: Update, context: ContextTypes.DEFAULT_TYPE, error: Exception):
    """Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø¨ÙˆØª"""
    logger.error(f"âŒ Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ Ø§Ù„Ø¨ÙˆØª: {str(error)}")
    logger.error(f"ğŸ“Š Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£: {type(error).__name__}")
    
    # Ø·Ø¨Ø§Ø¹Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£
    import traceback
    logger.error(f"ğŸ“ Traceback:\n{traceback.format_exc()}")
    
    # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    try:
        if update.message:
            await update.message.reply_text(
                "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹\n\n"
                "ğŸ”§ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„",
                parse_mode='Markdown'
            )
        elif update.callback_query:
            await update.callback_query.answer("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£")
    except Exception as e:
        logger.error(f"âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£: {e}")

