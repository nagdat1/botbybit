# 📖 دليل استخدام نظام الإشارات المتقدم

## 🎯 أنواع الإشارات المدعومة

### 1️⃣ BUY - شراء Spot
**الوصف**: يفتح صفقة شراء في السوق الفوري

**مثال**:
```json
{
  "signal": "buy",
  "symbol": "BTCUSDT",
  "id": "TV_001"
}
```

**الحقول المطلوبة**:
- `signal`: نوع الإشارة (buy)
- `symbol`: رمز العملة (مثل: BTCUSDT)
- `id`: معرف فريد للإشارة

---

### 2️⃣ SELL - إغلاق Spot
**الوصف**: يغلق صفقة الشراء المفتوحة

**مثال**:
```json
{
  "signal": "sell",
  "symbol": "BTCUSDT",
  "id": "TV_002"
}
```

**الحقول المطلوبة**:
- `signal`: نوع الإشارة (sell)
- `symbol`: رمز العملة (مثل: BTCUSDT)
- `id`: معرف فريد للإشارة

---

### 3️⃣ LONG - صفقة شراء Futures
**الوصف**: يفتح صفقة شراء في العقود المستقبلية

**مثال**:
```json
{
  "signal": "long",
  "symbol": "BTCUSDT",
  "id": "TV_LONG_001"
}
```

**الحقول المطلوبة**:
- `signal`: نوع الإشارة (long)
- `symbol`: رمز العملة (مثل: BTCUSDT)
- `id`: معرف فريد للإشارة

**اختياري**:
- `take_profit`: سعر جني الأرباح
- `stop_loss`: سعر وقف الخسارة

---

### 4️⃣ CLOSE_LONG - إغلاق LONG
**الوصف**: يغلق صفقة LONG المفتوحة

**مثال**:
```json
{
  "signal": "close_long",
  "symbol": "BTCUSDT",
  "id": "TV_CLOSE_001"
}
```

**الحقول المطلوبة**:
- `signal`: نوع الإشارة (close_long)
- `symbol`: رمز العملة (مثل: BTCUSDT)
- `id`: معرف فريد للإشارة

---

### 5️⃣ SHORT - صفقة بيع Futures
**الوصف**: يفتح صفقة بيع في العقود المستقبلية

**مثال**:
```json
{
  "signal": "short",
  "symbol": "ETHUSDT",
  "id": "TV_SHORT_001"
}
```

**الحقول المطلوبة**:
- `signal`: نوع الإشارة (short)
- `symbol`: رمز العملة (مثل: ETHUSDT)
- `id`: معرف فريد للإشارة

**اختياري**:
- `take_profit`: سعر جني الأرباح
- `stop_loss`: سعر وقف الخسارة

---

### 6️⃣ CLOSE_SHORT - إغلاق SHORT
**الوصف**: يغلق صفقة SHORT المفتوحة

**مثال**:
```json
{
  "signal": "close_short",
  "symbol": "ETHUSDT",
  "id": "TV_CLOSE_002"
}
```

**الحقول المطلوبة**:
- `signal`: نوع الإشارة (close_short)
- `symbol`: رمز العملة (مثل: ETHUSDT)
- `id`: معرف فريد للإشارة

---

## ⚡ مميزات النظام

✅ **إشارات بسيطة جداً**
- فقط 3 حقول مطلوبة: signal, symbol, id
- لا حاجة لتحديد السعر - التنفيذ بسعر السوق

✅ **تتبع كل إشارة بمعرف فريد (ID)**
- كل إشارة لها معرف فريد لتتبعها
- منع تنفيذ إشارات مكررة بنفس المعرف

✅ **منع الإشارات المكررة تلقائياً**
- النظام يكتشف الإشارات المكررة ويتجاهلها
- يضمن عدم فتح صفقات مكررة

✅ **إغلاق تلقائي للصفقات**
- إشارات الإغلاق تبحث عن الصفقة المفتوحة تلقائياً
- يتم إغلاق أي صفقة مفتوحة للرمز المحدد

✅ **إشعارات مفصلة لكل عملية**
- إشعارات تيليجرام فورية لكل إشارة
- تفاصيل كاملة عن التنفيذ

✅ **دعم Spot و Futures معاً**
- تداول في السوق الفوري (Spot)
- تداول العقود المستقبلية (Futures)

---

## 📱 الإشعارات

ستتلقى إشعار تفصيلي لكل عملية يحتوي على:

- 🆔 **معرف الإشارة**: المعرف الفريد للإشارة
- 📊 **نوع الإشارة**: buy, sell, long, close_long, short, close_short
- 💱 **الرمز**: رمز العملة
- 📋 **رقم الأمر المنفذ**: Order ID من المنصة
- 💰 **السعر المنفذ**: السعر الفعلي للتنفيذ
- ✅ **حالة التنفيذ**: نجح أو فشل

---

## 🔄 سير العمل

### مثال عملي - صفقة LONG كاملة

#### 1. فتح صفقة LONG:
```json
{
  "signal": "long",
  "symbol": "BTCUSDT",
  "id": "TV_LONG_001",
  "take_profit": 47000,
  "stop_loss": 44000
}
```

**النتيجة**: 
- يفتح البوت صفقة شراء بالرافعة المالية
- التنفيذ بسعر السوق الحالي
- يضع أوامر TP/SL إذا كانت موجودة

#### 2. إغلاق صفقة LONG:
```json
{
  "signal": "close_long",
  "symbol": "BTCUSDT",
  "id": "TV_CLOSE_001"
}
```

**النتيجة**:
- يبحث البوت عن أي صفقة LONG مفتوحة لـ `BTCUSDT`
- يغلق الصفقة فوراً بسعر السوق
- يرسل إشعار بالنتيجة

---

### مثال عملي - صفقة SHORT كاملة

#### 1. فتح صفقة SHORT:
```json
{
  "signal": "short",
  "symbol": "ETHUSDT",
  "id": "TV_SHORT_001"
}
```

**النتيجة**: 
- يفتح البوت صفقة بيع بالرافعة المالية
- التنفيذ بسعر السوق الحالي

#### 2. إغلاق صفقة SHORT:
```json
{
  "signal": "close_short",
  "symbol": "ETHUSDT",
  "id": "TV_CLOSE_002"
}
```

**النتيجة**:
- يبحث البوت عن أي صفقة SHORT مفتوحة لـ `ETHUSDT`
- يغلق الصفقة فوراً بسعر السوق
- يرسل إشعار بالنتيجة

---

### مثال عملي - صفقة Spot

#### 1. شراء Spot:
```json
{
  "signal": "buy",
  "symbol": "BTCUSDT",
  "id": "TV_SPOT_001"
}
```

**النتيجة**: 
- يشتري البوت العملة في السوق الفوري
- التنفيذ بسعر السوق الحالي

#### 2. بيع Spot:
```json
{
  "signal": "sell",
  "symbol": "BTCUSDT",
  "id": "TV_SPOT_002"
}
```

**النتيجة**:
- يبيع البوت العملة المحتفظ بها
- يغلق الصفقة بسعر السوق
- يرسل إشعار بالنتيجة

---

## ⚠️ حالات خاصة

### 1. إشارة مكررة (نفس المعرف)
```json
{
  "signal": "buy",
  "symbol": "BTCUSDT",
  "id": "TV_001"
}
```

**إذا تم إرسال نفس المعرف مرة أخرى**:
- ❌ يتم تجاهل الإشارة
- 📱 إشعار: "إشارة مكررة - تم التجاهل"

---

### 2. إغلاق صفقة غير موجودة
```json
{
  "signal": "close_long",
  "symbol": "BTCUSDT",
  "id": "TV_CLOSE_001"
}
```

**إذا لم تكن هناك صفقة LONG مفتوحة لـ BTCUSDT**:
- ❌ لا توجد صفقة للإغلاق
- 📱 إشعار: "No open position found for BTCUSDT"

---

## 🔌 إعداد TradingView

### 1. إنشاء Alert في TradingView

1. افتح الرسم البياني في TradingView
2. اضغط على زر "Create Alert"
3. في قسم "Webhook URL"، ضع رابط الـ Webhook الخاص بك

### 2. كتابة رسالة Alert

في حقل "Message"، اكتب الإشارة بصيغة JSON:

**مثال لفتح صفقة LONG**:
```json
{
  "signal": "long",
  "symbol": "{{ticker}}",
  "id": "TV_{{timenow}}"
}
```

**مثال لإغلاق صفقة LONG**:
```json
{
  "signal": "close_long",
  "symbol": "{{ticker}}",
  "id": "TV_CLOSE_{{timenow}}"
}
```

### 3. متغيرات TradingView المفيدة

- `{{ticker}}`: رمز العملة (مثل: BTCUSDT)
- `{{timenow}}`: الوقت الحالي (للمعرف الفريد)
- `{{close}}`: سعر الإغلاق (اختياري)
- `{{volume}}`: حجم التداول (اختياري)

---

## 💡 نصائح مهمة

### 1. استخدام معرفات فريدة
```json
// ✅ جيد - استخدام الوقت للحصول على معرف فريد
{
  "id": "TV_{{timenow}}"
}

// ❌ خطأ - نفس المعرف في كل مرة
{
  "id": "TV_001"
}
```

### 2. البساطة
```json
// ✅ جيد - 3 حقول فقط
{
  "signal": "buy",
  "symbol": "BTCUSDT",
  "id": "TV_001"
}

// ❌ لا حاجة لإضافة price
{
  "signal": "buy",
  "symbol": "BTCUSDT",
  "price": 45000,  // غير مطلوب
  "id": "TV_001"
}
```

### 3. الإغلاق التلقائي
- البوت يبحث تلقائياً عن الصفقة المفتوحة للرمز المحدد
- لا حاجة لتحديد معرف الصفقة الأصلية
- يتم إغلاق أول صفقة مفتوحة يجدها

---

## 📊 سجل الإشارات

يتم حفظ جميع الإشارات في قاعدة البيانات مع التفاصيل التالية:

- 🆔 معرف الإشارة
- 👤 معرف المستخدم
- 📊 نوع الإشارة
- 💱 الرمز
- 🏪 نوع السوق (Spot/Futures)
- ⏰ وقت الاستلام
- ⏰ وقت التنفيذ
- 📋 رقم الأمر
- 💰 السعر المنفذ
- ✅ الحالة (received, executed, closed, failed)

---

## 🛠️ استكشاف الأخطاء

### خطأ: "Missing required field"
**السبب**: حقل إلزامي مفقود
**الحل**: تأكد من وجود `signal`, `symbol`, `id`

### خطأ: "No open position found"
**السبب**: لا توجد صفقة مفتوحة للرمز المحدد
**الحل**: تحقق من أن لديك صفقة مفتوحة للرمز قبل الإغلاق

### خطأ: "Duplicate signal"
**السبب**: تم إرسال إشارة بنفس المعرف مرة أخرى
**الحل**: استخدم معرفات فريدة لكل إشارة

---

## 📞 الدعم

إذا واجهت أي مشكلة:
1. تحقق من صيغة JSON
2. تأكد من وجود جميع الحقول المطلوبة (signal, symbol, id)
3. راجع سجل الإشارات في قاعدة البيانات
4. تحقق من الإشعارات في تيليجرام

---

**تم التحديث**: أكتوبر 2025
**الإصدار**: 3.0 - بدون price و original_id
