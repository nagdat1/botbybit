# 📖 دليل استخدام نظام الإشارات المتقدم

## 🎯 أنواع الإشارات المدعومة

### 1️⃣ BUY - شراء Spot
**الوصف**: يفتح صفقة شراء في السوق الفوري

**مثال**:
```json
{
  "signal": "buy",
  "symbol": "BTCUSDT",
  "price": 45000,
  "id": "TV_001"
}
```

**الحقول المطلوبة**:
- `signal`: نوع الإشارة (buy)
- `symbol`: رمز العملة (مثل: BTCUSDT)
- `price`: السعر المستهدف
- `id`: معرف فريد للإشارة

---

### 2️⃣ SELL - إغلاق Spot
**الوصف**: يغلق صفقة الشراء المفتوحة

**مثال**:
```json
{
  "signal": "sell",
  "symbol": "BTCUSDT",
  "price": 46000,
  "id": "TV_002"
}
```

**الحقول المطلوبة**:
- `signal`: نوع الإشارة (sell)
- `symbol`: رمز العملة (مثل: BTCUSDT)
- `price`: السعر المستهدف
- `id`: معرف فريد للإشارة

---

### 3️⃣ LONG - صفقة شراء Futures
**الوصف**: يفتح صفقة شراء في العقود المستقبلية

**مثال**:
```json
{
  "signal": "long",
  "symbol": "BTCUSDT",
  "price": 45000,
  "id": "TV_LONG_001"
}
```

**الحقول المطلوبة**:
- `signal`: نوع الإشارة (long)
- `symbol`: رمز العملة (مثل: BTCUSDT)
- `price`: السعر المستهدف
- `id`: معرف فريد للإشارة

**اختياري**:
- `take_profit`: سعر جني الأرباح
- `stop_loss`: سعر وقف الخسارة

---

### 4️⃣ CLOSE_LONG - إغلاق LONG
**الوصف**: يغلق صفقة LONG محددة

**⚠️ مهم**: يجب تضمين `original_id` للربط بالصفقة الأصلية

**مثال**:
```json
{
  "signal": "close_long",
  "symbol": "BTCUSDT",
  "price": 46000,
  "id": "TV_CLOSE_001",
  "original_id": "TV_LONG_001"
}
```

**الحقول المطلوبة**:
- `signal`: نوع الإشارة (close_long)
- `symbol`: رمز العملة (مثل: BTCUSDT)
- `price`: السعر المستهدف
- `id`: معرف فريد للإشارة
- `original_id`: معرف الإشارة الأصلية التي فتحت الصفقة

---

### 5️⃣ SHORT - صفقة بيع Futures
**الوصف**: يفتح صفقة بيع في العقود المستقبلية

**مثال**:
```json
{
  "signal": "short",
  "symbol": "ETHUSDT",
  "price": 2500,
  "id": "TV_SHORT_001"
}
```

**الحقول المطلوبة**:
- `signal`: نوع الإشارة (short)
- `symbol`: رمز العملة (مثل: ETHUSDT)
- `price`: السعر المستهدف
- `id`: معرف فريد للإشارة

**اختياري**:
- `take_profit`: سعر جني الأرباح
- `stop_loss`: سعر وقف الخسارة

---

### 6️⃣ CLOSE_SHORT - إغلاق SHORT
**الوصف**: يغلق صفقة SHORT محددة

**⚠️ مهم**: يجب تضمين `original_id` للربط بالصفقة الأصلية

**مثال**:
```json
{
  "signal": "close_short",
  "symbol": "ETHUSDT",
  "price": 2420,
  "id": "TV_CLOSE_002",
  "original_id": "TV_SHORT_001"
}
```

**الحقول المطلوبة**:
- `signal`: نوع الإشارة (close_short)
- `symbol`: رمز العملة (مثل: ETHUSDT)
- `price`: السعر المستهدف
- `id`: معرف فريد للإشارة
- `original_id`: معرف الإشارة الأصلية التي فتحت الصفقة

---

## ⚡ مميزات النظام

✅ **تتبع كل إشارة بمعرف فريد (ID)**
- كل إشارة لها معرف فريد لتتبعها
- منع تنفيذ إشارات مكررة بنفس المعرف

✅ **منع الإشارات المكررة تلقائياً**
- النظام يكتشف الإشارات المكررة ويتجاهلها
- يضمن عدم فتح صفقات مكررة

✅ **ربط صفقات الإغلاق بالفتح**
- إشارات الإغلاق ترتبط بالصفقات الأصلية عبر `original_id`
- يضمن إغلاق الصفقة الصحيحة

✅ **إشعارات مفصلة لكل عملية**
- إشعارات تيليجرام فورية لكل إشارة
- تفاصيل كاملة عن التنفيذ

✅ **دعم Spot و Futures معاً**
- تداول في السوق الفوري (Spot)
- تداول العقود المستقبلية (Futures)

---

## 📱 الإشعارات

ستتلقى إشعار تفصيلي لكل عملية يحتوي على:

- 🆔 **معرف الإشارة**: المعرف الفريد للإشارة
- 📊 **نوع الإشارة**: buy, sell, long, close_long, short, close_short
- 💱 **الرمز والسعر**: رمز العملة والسعر المنفذ
- 📋 **رقم الأمر المنفذ**: Order ID من المنصة
- ✅ **حالة التنفيذ**: نجح أو فشل

---

## 🔄 سير العمل

### مثال عملي - صفقة LONG كاملة

#### 1. فتح صفقة LONG:
```json
{
  "signal": "long",
  "symbol": "BTCUSDT",
  "price": 45000,
  "id": "TV_LONG_001",
  "take_profit": 47000,
  "stop_loss": 44000
}
```

**النتيجة**: 
- يفتح البوت صفقة شراء بالرافعة المالية
- يحفظ الصفقة مع المعرف `TV_LONG_001`
- يضع أوامر TP/SL إذا كانت موجودة

#### 2. إغلاق صفقة LONG:
```json
{
  "signal": "close_long",
  "symbol": "BTCUSDT",
  "price": 46000,
  "id": "TV_CLOSE_001",
  "original_id": "TV_LONG_001"
}
```

**النتيجة**:
- يبحث البوت عن الصفقة ذات المعرف `TV_LONG_001`
- يغلق الصفقة فوراً
- يرسل إشعار بالنتيجة

---

### مثال عملي - صفقة SHORT كاملة

#### 1. فتح صفقة SHORT:
```json
{
  "signal": "short",
  "symbol": "ETHUSDT",
  "price": 2500,
  "id": "TV_SHORT_001"
}
```

**النتيجة**: 
- يفتح البوت صفقة بيع بالرافعة المالية
- يحفظ الصفقة مع المعرف `TV_SHORT_001`

#### 2. إغلاق صفقة SHORT:
```json
{
  "signal": "close_short",
  "symbol": "ETHUSDT",
  "price": 2420,
  "id": "TV_CLOSE_002",
  "original_id": "TV_SHORT_001"
}
```

**النتيجة**:
- يبحث البوت عن الصفقة ذات المعرف `TV_SHORT_001`
- يغلق الصفقة فوراً
- يرسل إشعار بالنتيجة

---

### مثال عملي - صفقة Spot

#### 1. شراء Spot:
```json
{
  "signal": "buy",
  "symbol": "BTCUSDT",
  "price": 45000,
  "id": "TV_SPOT_001"
}
```

**النتيجة**: 
- يشتري البوت العملة في السوق الفوري
- يحفظ الصفقة مع المعرف `TV_SPOT_001`

#### 2. بيع Spot:
```json
{
  "signal": "sell",
  "symbol": "BTCUSDT",
  "price": 46000,
  "id": "TV_SPOT_002"
}
```

**النتيجة**:
- يبيع البوت العملة المحتفظ بها
- يغلق الصفقة
- يرسل إشعار بالنتيجة

---

## ⚠️ حالات خاصة

### 1. إشارة مكررة (نفس المعرف)
```json
{
  "signal": "buy",
  "symbol": "BTCUSDT",
  "price": 45000,
  "id": "TV_001"
}
```

**إذا تم إرسال نفس المعرف مرة أخرى**:
- ❌ يتم تجاهل الإشارة
- 📱 إشعار: "إشارة مكررة - تم التجاهل"

---

### 2. إغلاق بدون original_id
```json
{
  "signal": "close_long",
  "symbol": "BTCUSDT",
  "price": 46000,
  "id": "TV_CLOSE_001"
  // ❌ original_id مفقود
}
```

**النتيجة**:
- ❌ فشل التحقق من الإشارة
- 📱 إشعار: "Missing required field: original_id"

---

### 3. إغلاق صفقة غير موجودة
```json
{
  "signal": "close_long",
  "symbol": "BTCUSDT",
  "price": 46000,
  "id": "TV_CLOSE_001",
  "original_id": "TV_LONG_999"  // صفقة غير موجودة
}
```

**النتيجة**:
- ❌ لا توجد صفقة بهذا المعرف
- 📱 إشعار: "No open position found with original_id: TV_LONG_999"

---

## 🔌 إعداد TradingView

### 1. إنشاء Alert في TradingView

1. افتح الرسم البياني في TradingView
2. اضغط على زر "Create Alert"
3. في قسم "Webhook URL"، ضع رابط الـ Webhook الخاص بك

### 2. كتابة رسالة Alert

في حقل "Message"، اكتب الإشارة بصيغة JSON:

**مثال لفتح صفقة LONG**:
```json
{
  "signal": "long",
  "symbol": "{{ticker}}",
  "price": {{close}},
  "id": "TV_{{timenow}}"
}
```

**مثال لإغلاق صفقة LONG**:
```json
{
  "signal": "close_long",
  "symbol": "{{ticker}}",
  "price": {{close}},
  "id": "TV_CLOSE_{{timenow}}",
  "original_id": "TV_LONG_001"
}
```

### 3. متغيرات TradingView المفيدة

- `{{ticker}}`: رمز العملة (مثل: BTCUSDT)
- `{{close}}`: سعر الإغلاق
- `{{timenow}}`: الوقت الحالي (للمعرف الفريد)
- `{{volume}}`: حجم التداول

---

## 💡 نصائح مهمة

### 1. استخدام معرفات فريدة
```json
// ✅ جيد - استخدام الوقت للحصول على معرف فريد
{
  "id": "TV_{{timenow}}"
}

// ❌ خطأ - نفس المعرف في كل مرة
{
  "id": "TV_001"
}
```

### 2. ربط الإغلاق بالفتح
```json
// ✅ جيد - الإغلاق مرتبط بالفتح
// فتح
{"id": "TV_LONG_001"}
// إغلاق
{"id": "TV_CLOSE_001", "original_id": "TV_LONG_001"}

// ❌ خطأ - لا يوجد ربط
// فتح
{"id": "TV_LONG_001"}
// إغلاق
{"id": "TV_CLOSE_001", "original_id": "TV_LONG_999"}
```

### 3. السعر المستهدف
```json
// ✅ جيد - سعر واقعي
{
  "price": 45000
}

// ❌ خطأ - سعر غير صحيح
{
  "price": -100
}
```

---

## 📊 سجل الإشارات

يتم حفظ جميع الإشارات في قاعدة البيانات مع التفاصيل التالية:

- 🆔 معرف الإشارة
- 👤 معرف المستخدم
- 📊 نوع الإشارة
- 💱 الرمز
- 💰 السعر
- 🏪 نوع السوق (Spot/Futures)
- ⏰ وقت الاستلام
- ⏰ وقت التنفيذ
- 📋 رقم الأمر
- ✅ الحالة (received, executed, closed, failed)

---

## 🛠️ استكشاف الأخطاء

### خطأ: "Missing required field"
**السبب**: حقل إلزامي مفقود
**الحل**: تأكد من وجود `signal`, `symbol`, `price`, `id`

### خطأ: "Missing original_id"
**السبب**: إشارة إغلاق بدون `original_id`
**الحل**: أضف `original_id` في إشارات close_long و close_short

### خطأ: "No open position found"
**السبب**: لا توجد صفقة بالمعرف المطلوب
**الحل**: تحقق من أن `original_id` صحيح وأن الصفقة مفتوحة

### خطأ: "Duplicate signal"
**السبب**: تم إرسال إشارة بنفس المعرف مرة أخرى
**الحل**: استخدم معرفات فريدة لكل إشارة

---

## 📞 الدعم

إذا واجهت أي مشكلة:
1. تحقق من صيغة JSON
2. تأكد من وجود جميع الحقول المطلوبة
3. راجع سجل الإشارات في قاعدة البيانات
4. تحقق من الإشعارات في تيليجرام

---

**تم التحديث**: أكتوبر 2025
**الإصدار**: 2.0

