#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Ù…Ù„Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ - Ø¯Ù…Ø¬ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù† Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø¢Ù„ÙŠØ© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ù…Ø¹ Ø¯Ø¹Ù… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
"""

import logging
import time
from typing import Dict, Any, Optional
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, KeyboardButton, ReplyKeyboardMarkup
from telegram.ext import ContextTypes, Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù†
from flexible_config_manager import flexible_config_manager
from enhanced_bot_interface import enhanced_bot_interface
from enhanced_trade_executor import enhanced_trade_executor
from integrated_trading_system import integrated_trading_system
from enhanced_trading_bot import enhanced_trading_bot

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
from database import db_manager
from user_manager import user_manager
from bybit_trading_bot import trading_bot

logger = logging.getLogger(__name__)

class SystemUpdater:
    """Ù…Ø­Ø¯Ø« Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ"""
    
    def __init__(self):
        self.integration_complete = False
        self.backup_created = False
        
    def integrate_enhanced_system(self):
        """Ø¯Ù…Ø¬ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù† Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ"""
        try:
            logger.info("Ø¨Ø¯Ø¡ Ø¯Ù…Ø¬ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù†...")
            
            # 1. Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            self._create_backup()
            
            # 2. Ø¯Ù…Ø¬ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù†
            enhanced_trading_bot.integrate_with_existing_system(trading_bot)
            
            # 3. ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¨ÙˆØª
            self._update_bot_handlers()
            
            # 4. ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª
            self._update_signal_handlers()
            
            # 5. ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            self._update_user_interface()
            
            self.integration_complete = True
            logger.info("ØªÙ… Ø¯Ù…Ø¬ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù† Ø¨Ù†Ø¬Ø§Ø­!")
            
            return True
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¯Ù…Ø¬ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù†: {e}")
            return False
    
    def _create_backup(self):
        """Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©"""
        try:
            # Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            self.backup_settings = {
                'user_settings': trading_bot.user_settings.copy(),
                'default_settings': trading_bot.user_settings.copy(),
                'api_settings': {
                    'bybit_api_key': trading_bot.bybit_api.api_key if trading_bot.bybit_api else '',
                    'bybit_api_secret': trading_bot.bybit_api.api_secret if trading_bot.bybit_api else ''
                }
            }
            
            self.backup_created = True
            logger.info("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª")
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {e}")
    
    def _update_bot_handlers(self):
        """ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¨ÙˆØª"""
        try:
            # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ù…Ø­Ø³Ù†Ø©
            if hasattr(trading_bot, 'application') and trading_bot.application:
                enhanced_trading_bot.setup_enhanced_handlers(trading_bot.application)
            
            logger.info("ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¨ÙˆØª")
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¨ÙˆØª: {e}")
    
    def _update_signal_handlers(self):
        """ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª"""
        try:
            # Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£ØµÙ„ÙŠ
            original_process_signal = getattr(trading_bot, 'process_signal', None)
            
            # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬ Ù…Ø­Ø³Ù†
            async def enhanced_process_signal(signal_data):
                try:
                    # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù† Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø´Ø§Ø±Ø©
                    user_id = getattr(trading_bot, 'user_id', None)
                    if user_id:
                        result = await integrated_trading_system.execute_enhanced_signal(user_id, signal_data)
                        return result
                    else:
                        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£ØµÙ„ÙŠ ÙƒØ§Ø­ØªÙŠØ§Ø·ÙŠ
                        if original_process_signal:
                            return await original_process_signal(signal_data)
                        return {'success': False, 'message': 'Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±'}
                except Exception as e:
                    logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù…Ø­Ø³Ù† Ù„Ù„Ø¥Ø´Ø§Ø±Ø§Øª: {e}")
                    return {'success': False, 'message': f'Ø®Ø·Ø£: {e}'}
            
            # Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬
            trading_bot.process_signal = enhanced_process_signal
            
            logger.info("ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª")
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª: {e}")
    
    def _update_user_interface(self):
        """ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
        try:
            # Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            if hasattr(trading_bot, 'main_menu_keyboard'):
                # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                trading_bot.main_menu_keyboard = enhanced_trading_bot.get_enhanced_main_menu(0)
            
            logger.info("ØªÙ… ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {e}")
    
    def restore_backup(self):
        """Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©"""
        try:
            if not self.backup_created:
                logger.warning("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©")
                return False
            
            # Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            trading_bot.user_settings = self.backup_settings['user_settings'].copy()
            
            logger.info("ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©")
            return True
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {e}")
            return False
    
    def get_integration_status(self) -> Dict[str, Any]:
        """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙƒØ§Ù…Ù„"""
        try:
            return {
                'integration_complete': self.integration_complete,
                'backup_created': self.backup_created,
                'enhanced_system_active': True,
                'config_manager_status': 'active',
                'bot_interface_status': 'active',
                'trade_executor_status': 'active',
                'existing_system_preserved': True,
                'signature_logic_preserved': True,
                'price_calculation_preserved': True,
                'flexible_variables_supported': True
            }
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙƒØ§Ù…Ù„: {e}")
            return {
                'integration_complete': False,
                'error': str(e)
            }

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø«ÙŠÙ„ Ø¹Ø§Ù… Ù„Ù„Ù…Ø­Ø¯Ø«
system_updater = SystemUpdater()

# Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
def update_trading_system():
    """ØªØ­Ø¯ÙŠØ« Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ"""
    try:
        logger.info("Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠØ« Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„...")
        
        # Ø¯Ù…Ø¬ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù†
        success = system_updater.integrate_enhanced_system()
        
        if success:
            logger.info("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!")
            logger.info("ğŸ¯ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¢Ù† ÙŠØ¯Ø¹Ù…:")
            logger.info("   â€¢ ØªØ¹Ø¯ÙŠÙ„ Ù…ÙØ§ØªÙŠØ­ API Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ø¨ÙˆØª")
            logger.info("   â€¢ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø§ÙØ¹Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©")
            logger.info("   â€¢ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¨Ù„Øº Ø§Ù„ØªØ¯Ø§ÙˆÙ„")
            logger.info("   â€¢ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¢Ù„ÙŠØ© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠØ©")
            logger.info("   â€¢ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¢Ù„ÙŠØ© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©")
            logger.info("   â€¢ ØªÙ†ÙÙŠØ° Ø§Ù„ØµÙÙ‚Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª")
            
            return True
        else:
            logger.error("âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„")
            return False
            
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„: {e}")
        return False

# Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
def test_enhanced_system():
    """Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù†"""
    try:
        logger.info("Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù†...")
        
        # Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ù†
        test_config = flexible_config_manager.get_user_config(12345)
        logger.info(f"âœ… Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ù†: {len(test_config)} Ø¥Ø¹Ø¯Ø§Ø¯")
        
        # Ø§Ø®ØªØ¨Ø§Ø± ØªÙ†ÙÙŠØ° Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†
        test_signal = {
            'symbol': 'BTCUSDT',
            'side': 'buy',
            'signal_id': 'test_123',
            'timestamp': time.time()
        }
        
        # Ø§Ø®ØªØ¨Ø§Ø± Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
        test_params = flexible_config_manager.calculate_trade_parameters(
            12345, 'BTCUSDT', 'buy', 50000.0
        )
        logger.info(f"âœ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª: {len(test_params)} Ù…Ø¹Ø§Ù…Ù„")
        
        # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„
        system_status = integrated_trading_system.get_system_status()
        logger.info(f"âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„: {system_status['system_active']}")
        
        logger.info("âœ… Ø¬Ù…ÙŠØ¹ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù† Ù†Ø¬Ø­Øª!")
        return True
        
    except Exception as e:
        logger.error(f"âŒ ÙØ´Ù„ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù†: {e}")
        return False

# Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶
def show_system_info():
    """Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…"""
    try:
        print("\n" + "="*60)
        print("ğŸ¤– Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø­Ø³Ù† - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…")
        print("="*60)
        
        # Ø­Ø§Ù„Ø© Ø§Ù„ØªÙƒØ§Ù…Ù„
        integration_status = system_updater.get_integration_status()
        print(f"ğŸ”— Ø­Ø§Ù„Ø© Ø§Ù„ØªÙƒØ§Ù…Ù„: {'âœ… Ù…ÙƒØªÙ…Ù„' if integration_status['integration_complete'] else 'âŒ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„'}")
        
        # Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        print(f"ğŸ’¾ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {'âœ… Ù…ÙˆØ¬ÙˆØ¯Ø©' if integration_status['backup_created'] else 'âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'}")
        
        # Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù†
        print(f"âš¡ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù†: {'âœ… Ù†Ø´Ø·' if integration_status['enhanced_system_active'] else 'âŒ ØºÙŠØ± Ù†Ø´Ø·'}")
        
        # Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©
        print("\nğŸ“‹ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©:")
        print(f"   â€¢ Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ù†: {'âœ…' if integration_status['config_manager_status'] == 'active' else 'âŒ'}")
        print(f"   â€¢ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ù…Ø­Ø³Ù†Ø©: {'âœ…' if integration_status['bot_interface_status'] == 'active' else 'âŒ'}")
        print(f"   â€¢ ØªÙ†ÙÙŠØ° Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†: {'âœ…' if integration_status['trade_executor_status'] == 'active' else 'âŒ'}")
        
        # Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        print("\nğŸ›¡ï¸ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:")
        print(f"   â€¢ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: {'âœ…' if integration_status['existing_system_preserved'] else 'âŒ'}")
        print(f"   â€¢ Ø¢Ù„ÙŠØ© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: {'âœ…' if integration_status['signature_logic_preserved'] else 'âŒ'}")
        print(f"   â€¢ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø±: {'âœ…' if integration_status['price_calculation_preserved'] else 'âŒ'}")
        
        # Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø±Ù†Ø©
        print(f"\nğŸ¯ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø±Ù†Ø©: {'âœ… Ù…Ø¯Ø¹ÙˆÙ…Ø©' if integration_status['flexible_variables_supported'] else 'âŒ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©'}")
        
        print("\n" + "="*60)
        print("ğŸ‰ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª!")
        print("="*60 + "\n")
        
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…: {e}")

# ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù
if __name__ == "__main__":
    # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù…
    update_success = update_trading_system()
    
    if update_success:
        # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…
        test_success = test_enhanced_system()
        
        if test_success:
            # Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
            show_system_info()
        else:
            print("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…")
    else:
        print("âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù…")
else:
    # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
    update_trading_system()
