#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Ø¨ÙˆØª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠ Ø¹Ù„Ù‰ Bybit
Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ ÙŠØ¯Ø¹Ù… Ø¨ÙŠØ¦Ø§Øª Ù…Ù†ÙØµÙ„Ø© Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© Ø´Ø§Ù…Ù„Ø©
"""

import logging
import asyncio
import threading
import time
from datetime import datetime
from typing import Dict, List, Optional, Any

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application, CommandHandler, MessageHandler, CallbackQueryHandler, 
    ContextTypes, filters
)

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ±Ø©
from database import db_manager
from user_manager import user_manager
from api_manager import api_manager
from order_manager import order_manager
from ui_manager import ui_manager
from commands import command_handler
from bot_controller import bot_controller
from security_manager import security_manager

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
from config import TELEGRAM_TOKEN, ADMIN_USER_ID, LOGGING_SETTINGS

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=getattr(logging, LOGGING_SETTINGS['log_level']),
    handlers=[
        logging.FileHandler(LOGGING_SETTINGS['log_file'], encoding='utf-8'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

class SmartTradingBot:
    """Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠ"""
    
    def __init__(self):
        self.application = None
        self.is_running = False
        self.start_time = None
        
        # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª
        self.stats = {
            'total_users': 0,
            'active_users': 0,
            'total_orders': 0,
            'messages_processed': 0,
            'uptime': 0
        }
    
    async def initialize(self):
        """ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙˆØª"""
        try:
            logger.info("Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø°ÙƒÙŠ...")
            
            # ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            db_manager.init_database()
            
            # Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ù…Ø§Ù†
            security_manager.start_security_monitoring()
            
            # Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
            bot_controller.start_monitoring()
            
            # Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
            order_manager.start_price_monitoring()
            
            logger.info("ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙˆØª Ø¨Ù†Ø¬Ø§Ø­")
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙˆØª: {e}")
            raise
    
    async def start(self):
        """Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª"""
        try:
            await self.initialize()
            
            # Ø¥Ù†Ø´Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ Telegram
            self.application = Application.builder().token(TELEGRAM_TOKEN).build()
            
            # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª
            self._setup_handlers()
            
            # Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            self.is_running = True
            self.start_time = datetime.now()
            
            logger.info("Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø°ÙƒÙŠ...")
            await self.application.run_polling(
                allowed_updates=['message', 'callback_query'],
                drop_pending_updates=True
            )
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª: {e}")
            raise
    
    def _setup_handlers(self):
        """Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«"""
        try:
            # Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£ÙˆØ§Ù…Ø±
            self.application.add_handler(CommandHandler("start", self._handle_start))
            self.application.add_handler(CommandHandler("balance", self._handle_balance))
            self.application.add_handler(CommandHandler("buy", self._handle_buy))
            self.application.add_handler(CommandHandler("sell", self._handle_sell))
            self.application.add_handler(CommandHandler("help", self._handle_help))
            
            # Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ©
            self.application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, self._handle_text))
            
            # Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            self.application.add_handler(CallbackQueryHandler(self._handle_callback))
            
            # Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            self.application.add_error_handler(self._handle_error)
            
            logger.info("ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«")
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª: {e}")
            raise
    
    async def _handle_start(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù…Ø± /start"""
        try:
            user_id = update.effective_user.id
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†
            authenticated, message = security_manager.authenticate_user(user_id, "start")
            if not authenticated:
                await update.message.reply_text(f"âŒ {message}")
                return
            
            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ù…Ø±
            await command_handler.handle_start(update, context)
            
            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            self.stats['messages_processed'] += 1
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© /start: {e}")
            await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª")
    
    async def _handle_balance(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù…Ø± /balance"""
        try:
            user_id = update.effective_user.id
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†
            authenticated, message = security_manager.authenticate_user(user_id, "balance")
            if not authenticated:
                await update.message.reply_text(f"âŒ {message}")
                return
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„
            if not security_manager.validate_user_access(user_id, "user_data"):
                await update.message.reply_text("âŒ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª")
                return
            
            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ù…Ø±
            await command_handler.handle_balance(update, context)
            
            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            self.stats['messages_processed'] += 1
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© /balance: {e}")
            await update.message.reply_text("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±ØµÙŠØ¯")
    
    async def _handle_buy(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù…Ø± /buy"""
        try:
            user_id = update.effective_user.id
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†
            authenticated, message = security_manager.authenticate_user(user_id, "buy")
            if not authenticated:
                await update.message.reply_text(f"âŒ {message}")
                return
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¯Ø§ÙˆÙ„
            if not security_manager.validate_user_access(user_id, "trading"):
                await update.message.reply_text("âŒ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ØªØ¯Ø§ÙˆÙ„")
                return
            
            # ÙƒØ´Ù Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡
            if context.args:
                symbol = context.args[0].upper()
                quantity = float(context.args[1]) if len(context.args) > 1 else 0
                
                suspicious = security_manager.detect_suspicious_activity(
                    user_id, "unusual_trading", {
                        'symbol': symbol,
                        'amount': quantity,
                        'action': 'buy'
                    }
                )
                
                if suspicious:
                    await update.message.reply_text("âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø³Ø¨Ø¨ Ù†Ø´Ø§Ø· Ù…Ø´Ø¨ÙˆÙ‡")
                    return
            
            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ù…Ø±
            await command_handler.handle_buy(update, context)
            
            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            self.stats['messages_processed'] += 1
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© /buy: {e}")
            await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙ†ÙÙŠØ° Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡")
    
    async def _handle_sell(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù…Ø± /sell"""
        try:
            user_id = update.effective_user.id
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†
            authenticated, message = security_manager.authenticate_user(user_id, "sell")
            if not authenticated:
                await update.message.reply_text(f"âŒ {message}")
                return
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¯Ø§ÙˆÙ„
            if not security_manager.validate_user_access(user_id, "trading"):
                await update.message.reply_text("âŒ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ØªØ¯Ø§ÙˆÙ„")
                return
            
            # ÙƒØ´Ù Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡
            if context.args:
                symbol = context.args[0].upper()
                quantity = float(context.args[1]) if len(context.args) > 1 else 0
                
                suspicious = security_manager.detect_suspicious_activity(
                    user_id, "unusual_trading", {
                        'symbol': symbol,
                        'amount': quantity,
                        'action': 'sell'
                    }
                )
                
                if suspicious:
                    await update.message.reply_text("âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø³Ø¨Ø¨ Ù†Ø´Ø§Ø· Ù…Ø´Ø¨ÙˆÙ‡")
                    return
            
            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ù…Ø±
            await command_handler.handle_sell(update, context)
            
            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            self.stats['messages_processed'] += 1
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© /sell: {e}")
            await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙ†ÙÙŠØ° Ø£Ù…Ø± Ø§Ù„Ø¨ÙŠØ¹")
    
    async def _handle_help(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù…Ø± /help"""
        try:
            user_id = update.effective_user.id
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†
            authenticated, message = security_manager.authenticate_user(user_id, "help")
            if not authenticated:
                await update.message.reply_text(f"âŒ {message}")
                return
            
            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ù…Ø±
            await command_handler.handle_help(update, context)
            
            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            self.stats['messages_processed'] += 1
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© /help: {e}")
            await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©")
    
    async def _handle_text(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ©"""
        try:
            user_id = update.effective_user.id
            text = update.message.text
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†
            authenticated, message = security_manager.authenticate_user(user_id, "text_message")
            if not authenticated:
                await update.message.reply_text(f"âŒ {message}")
                return
            
            # ÙƒØ´Ù Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡
            suspicious = security_manager.detect_suspicious_activity(
                user_id, "rapid_requests", {'message_length': len(text)}
            )
            
            if suspicious:
                await update.message.reply_text("âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø³Ø¨Ø¨ Ù†Ø´Ø§Ø· Ù…Ø´Ø¨ÙˆÙ‡")
                return
            
            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Øµ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            await self._process_text_message(update, context, text)
            
            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            self.stats['messages_processed'] += 1
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†ØµÙŠØ©: {e}")
            await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©")
    
    async def _process_text_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE, text: str):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†ØµÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰"""
        try:
            user_id = update.effective_user.id
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            user_state = ui_manager.get_user_state(user_id)
            
            if user_state:
                await self._handle_user_input_state(update, context, text, user_state)
                return
            
            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            if text == "ğŸ”— Ø§Ù„Ø±Ø¨Ø·":
                await self._handle_api_linking(update, context)
            elif text == "âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª":
                await self._handle_settings(update, context)
            elif text == "ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯":
                await self._handle_balance_display(update, context)
            elif text == "ğŸ“Š Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©":
                await self._handle_open_orders(update, context)
            elif text == "ğŸ“ˆ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¯Ø§ÙˆÙ„":
                await self._handle_trade_history(update, context)
            elif text == "ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª":
                await self._handle_statistics(update, context)
            elif text == "â–¶ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª":
                await self._handle_start_bot(update, context)
            elif text == "â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª":
                await self._handle_stop_bot(update, context)
            else:
                await update.message.reply_text("âŒ Ø£Ù…Ø± ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…")
                
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†ØµÙŠØ©: {e}")
            await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©")
    
    async def _handle_user_input_state(self, update: Update, context: ContextTypes.DEFAULT_TYPE, 
                                     text: str, state: str):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
        try:
            user_id = update.effective_user.id
            
            if state == "waiting_for_api_keys":
                await self._process_api_keys_input(update, context, text)
            elif state == "waiting_for_trade_amount":
                await self._process_trade_amount_input(update, context, text)
            elif state == "waiting_for_leverage":
                await self._process_leverage_input(update, context, text)
            else:
                # Ù…Ø³Ø­ Ø§Ù„Ø­Ø§Ù„Ø© ØºÙŠØ± Ø§Ù„Ù…Ø¹Ø±ÙˆÙØ©
                ui_manager.clear_user_state(user_id)
                await update.message.reply_text("âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©")
                
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {e}")
            await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„")
    
    async def _process_api_keys_input(self, update: Update, context: ContextTypes.DEFAULT_TYPE, text: str):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØ§ØªÙŠØ­ API"""
        try:
            user_id = update.effective_user.id
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙŠØºØ© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            parts = text.strip().split()
            if len(parts) != 2:
                await update.message.reply_text(
                    "âŒ ØµÙŠØºØ© Ø®Ø§Ø·Ø¦Ø©!\n"
                    "Ø£Ø¯Ø®Ù„ Ù…ÙØ§ØªÙŠØ­ API Ø¨Ø§Ù„ØµÙŠØºØ©:\n"
                    "API_KEY API_SECRET"
                )
                return
            
            api_key, api_secret = parts
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
            if api_manager.validate_api_keys(api_key, api_secret):
                # Ø±Ø¨Ø· Ø§Ù„Ù…ÙØ§ØªÙŠØ­
                if api_manager.add_user_api(user_id, api_key, api_secret):
                    # ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    user_manager.set_user_api_keys(user_id, api_key, api_secret)
                    
                    # Ù…Ø³Ø­ Ø§Ù„Ø­Ø§Ù„Ø©
                    ui_manager.clear_user_state(user_id)
                    
                    await update.message.reply_text(
                        "âœ… ØªÙ… Ø±Ø¨Ø· Ù…ÙØ§ØªÙŠØ­ API Ø¨Ù†Ø¬Ø§Ø­!\n"
                        "ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª Ù„Ù„ØªØ¯Ø§ÙˆÙ„"
                    )
                else:
                    await update.message.reply_text("âŒ ÙØ´Ù„ ÙÙŠ Ø±Ø¨Ø· Ù…ÙØ§ØªÙŠØ­ API")
            else:
                await update.message.reply_text("âŒ Ù…ÙØ§ØªÙŠØ­ API ØºÙŠØ± ØµØ­ÙŠØ­Ø©")
                
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…ÙØ§ØªÙŠØ­ API: {e}")
            await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…ÙØ§ØªÙŠØ­ API")
    
    async def _process_trade_amount_input(self, update: Update, context: ContextTypes.DEFAULT_TYPE, text: str):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº Ø§Ù„ØªØ¯Ø§ÙˆÙ„"""
        try:
            user_id = update.effective_user.id
            
            try:
                amount = float(text)
                if amount > 0:
                    # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                    settings = user_manager.get_user_settings(user_id)
                    settings['trade_amount'] = amount
                    user_manager.update_user_settings(user_id, settings)
                    
                    # Ù…Ø³Ø­ Ø§Ù„Ø­Ø§Ù„Ø©
                    ui_manager.clear_user_state(user_id)
                    
                    await update.message.reply_text(f"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ù„Øº Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø¥Ù„Ù‰: {amount}")
                else:
                    await update.message.reply_text("âŒ Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±")
            except ValueError:
                await update.message.reply_text("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­")
                
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø¨Ù„Øº Ø§Ù„ØªØ¯Ø§ÙˆÙ„: {e}")
            await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø¨Ù„Øº")
    
    async def _process_leverage_input(self, update: Update, context: ContextTypes.DEFAULT_TYPE, text: str):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø§ÙØ¹Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©"""
        try:
            user_id = update.effective_user.id
            
            try:
                leverage = int(text)
                if 1 <= leverage <= 100:
                    # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                    settings = user_manager.get_user_settings(user_id)
                    settings['leverage'] = leverage
                    user_manager.update_user_settings(user_id, settings)
                    
                    # Ù…Ø³Ø­ Ø§Ù„Ø­Ø§Ù„Ø©
                    ui_manager.clear_user_state(user_id)
                    
                    await update.message.reply_text(f"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§ÙØ¹Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰: {leverage}x")
                else:
                    await update.message.reply_text("âŒ Ø§Ù„Ø±Ø§ÙØ¹Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨ÙŠÙ† 1 Ùˆ 100")
            except ValueError:
                await update.message.reply_text("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­")
                
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø§ÙØ¹Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©: {e}")
            await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø§ÙØ¹Ø©")
    
    async def _handle_api_linking(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø¨Ø· Ù…ÙØ§ØªÙŠØ­ API"""
        try:
            user_id = update.effective_user.id
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†
            authenticated, message = security_manager.authenticate_user(user_id, "api_linking")
            if not authenticated:
                await update.message.reply_text(f"âŒ {message}")
                return
            
            # ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙØ§ØªÙŠØ­
            ui_manager.set_user_state(user_id, "waiting_for_api_keys")
            
            await update.message.reply_text(
                "ğŸ”— Ø±Ø¨Ø· Ù…ÙØ§ØªÙŠØ­ API\n\n"
                "Ø£Ø¯Ø®Ù„ Ù…ÙØ§ØªÙŠØ­ API Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØªØ§Ù„ÙŠØ©:\n"
                "API_KEY API_SECRET\n\n"
                "Ù…Ø«Ø§Ù„:\n"
                "abc123def456 xyz789uvw012"
            )
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø¨Ø· API: {e}")
            await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø±Ø¨Ø· Ù…ÙØ§ØªÙŠØ­ API")
    
    async def _handle_settings(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"""
        try:
            user_id = update.effective_user.id
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†
            authenticated, message = security_manager.authenticate_user(user_id, "settings")
            if not authenticated:
                await update.message.reply_text(f"âŒ {message}")
                return
            
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            keyboard = ui_manager.get_settings_keyboard(user_id)
            
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            user_env = user_manager.get_user_environment(user_id)
            settings = user_env.get_settings()
            
            settings_text = f"""
âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª

ğŸ’° Ù…Ø¨Ù„Øº Ø§Ù„ØªØ¯Ø§ÙˆÙ„: {settings.get('trade_amount', 100)} USDT
ğŸª Ù†ÙˆØ¹ Ø§Ù„Ø³ÙˆÙ‚: {settings.get('market_type', 'spot').upper()}
âš¡ Ø§Ù„Ø±Ø§ÙØ¹Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©: {settings.get('leverage', 1)}x
ğŸ”— Ø­Ø§Ù„Ø© API: {'Ù…Ø±ØªØ¨Ø·' if user_env.has_api_keys() else 'ØºÙŠØ± Ù…Ø±ØªØ¨Ø·'}
ğŸ¤– Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª: {'Ù†Ø´Ø·' if user_env.is_active else 'Ù…ØªÙˆÙ‚Ù'}

Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„Ù‡:
            """
            
            await update.message.reply_text(settings_text, reply_markup=keyboard)
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: {e}")
            await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª")
    
    async def _handle_balance_display(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ø¹Ø±Ø¶ Ø§Ù„Ø±ØµÙŠØ¯"""
        try:
            user_id = update.effective_user.id
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†
            authenticated, message = security_manager.authenticate_user(user_id, "balance_display")
            if not authenticated:
                await update.message.reply_text(f"âŒ {message}")
                return
            
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±ØµÙŠØ¯
            balance_info = user_manager.get_user_balance(user_id)
            trading_stats = user_manager.get_user_stats(user_id)
            
            balance_text = f"""
ğŸ’° Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±ØµÙŠØ¯

ğŸ“Š Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ„ÙŠ: {balance_info['balance']:.2f} USDT
ğŸ’³ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­: {balance_info['available_balance']:.2f} USDT
ğŸ”’ Ø§Ù„Ù‡Ø§Ù…Ø´ Ø§Ù„Ù…Ø­Ø¬ÙˆØ²: {balance_info['margin_locked']:.2f} USDT
ğŸ“ˆ Ø¥Ø¬Ù…Ø§Ù„ÙŠ PnL: {balance_info['total_pnl']:.2f} USDT

ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„:
â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙ‚Ø§Øª: {trading_stats['total_trades']}
â€¢ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ø±Ø§Ø¨Ø­Ø©: {trading_stats['winning_trades']}
â€¢ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ø®Ø§Ø³Ø±Ø©: {trading_stats['losing_trades']}
â€¢ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­: {trading_stats['win_rate']:.1f}%
            """
            
            await update.message.reply_text(balance_text)
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø±ØµÙŠØ¯: {e}")
            await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø±ØµÙŠØ¯")
    
    async def _handle_open_orders(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ø¹Ø±Ø¶ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©"""
        try:
            user_id = update.effective_user.id
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†
            authenticated, message = security_manager.authenticate_user(user_id, "open_orders")
            if not authenticated:
                await update.message.reply_text(f"âŒ {message}")
                return
            
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©
            orders = order_manager.get_user_orders(user_id)
            
            if not orders:
                await update.message.reply_text("ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹")
                return
            
            # ØªÙ†Ø³ÙŠÙ‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙÙ‚Ø§Øª
            orders_text = ui_manager.format_orders_list(user_id)
            
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
            keyboard = ui_manager.get_orders_keyboard(user_id)
            
            await update.message.reply_text(orders_text, reply_markup=keyboard)
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©: {e}")
            await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ØµÙÙ‚Ø§Øª")
    
    async def _handle_trade_history(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¯Ø§ÙˆÙ„"""
        try:
            user_id = update.effective_user.id
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†
            authenticated, message = security_manager.authenticate_user(user_id, "trade_history")
            if not authenticated:
                await update.message.reply_text(f"âŒ {message}")
                return
            
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¯Ø§ÙˆÙ„
            history_text = ui_manager.format_trade_history(user_id, 10)
            
            await update.message.reply_text(history_text)
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¯Ø§ÙˆÙ„: {e}")
            await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¯Ø§ÙˆÙ„")
    
    async def _handle_statistics(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª"""
        try:
            user_id = update.effective_user.id
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†
            authenticated, message = security_manager.authenticate_user(user_id, "statistics")
            if not authenticated:
                await update.message.reply_text(f"âŒ {message}")
                return
            
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            user_info = ui_manager.format_user_info(user_id)
            
            await update.message.reply_text(user_info)
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: {e}")
            await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª")
    
    async def _handle_start_bot(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
        try:
            user_id = update.effective_user.id
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†
            authenticated, message = security_manager.authenticate_user(user_id, "start_bot")
            if not authenticated:
                await update.message.reply_text(f"âŒ {message}")
                return
            
            # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            success = bot_controller.set_user_bot_status(user_id, bot_controller.BotStatus.RUNNING)
            
            if success:
                await update.message.reply_text("âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø¨Ù†Ø¬Ø§Ø­")
            else:
                await update.message.reply_text("âŒ ÙØ´Ù„ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª")
                
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª: {e}")
            await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª")
    
    async def _handle_stop_bot(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
        try:
            user_id = update.effective_user.id
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†
            authenticated, message = security_manager.authenticate_user(user_id, "stop_bot")
            if not authenticated:
                await update.message.reply_text(f"âŒ {message}")
                return
            
            # Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            success = bot_controller.set_user_bot_status(user_id, bot_controller.BotStatus.STOPPED)
            
            if success:
                await update.message.reply_text("â¹ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª Ø¨Ù†Ø¬Ø§Ø­")
            else:
                await update.message.reply_text("âŒ ÙØ´Ù„ ÙÙŠ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª")
                
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª: {e}")
            await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª")
    
    async def _handle_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¶ØºÙˆØ·Ø©"""
        try:
            query = update.callback_query
            await query.answer()
            
            user_id = update.effective_user.id
            data = query.data
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†
            authenticated, message = security_manager.authenticate_user(user_id, "callback")
            if not authenticated:
                await query.edit_message_text(f"âŒ {message}")
                return
            
            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
            if data.startswith("set_amount_"):
                await self._handle_set_amount_callback(update, context, data)
            elif data.startswith("set_market_"):
                await self._handle_set_market_callback(update, context, data)
            elif data.startswith("set_leverage_"):
                await self._handle_set_leverage_callback(update, context, data)
            elif data.startswith("order_details_"):
                await self._handle_order_details_callback(update, context, data)
            elif data.startswith("partial_close_"):
                await self._handle_partial_close_callback(update, context, data)
            elif data.startswith("close_order_"):
                await self._handle_close_order_callback(update, context, data)
            else:
                await query.edit_message_text("âŒ Ø²Ø± ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…")
                
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±: {e}")
            await query.edit_message_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø²Ø±")
    
    async def _handle_set_amount_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE, data: str):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± ØªØ¹ÙŠÙŠÙ† Ù…Ø¨Ù„Øº Ø§Ù„ØªØ¯Ø§ÙˆÙ„"""
        try:
            user_id = int(data.split("_")[-1])
            
            # ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº
            ui_manager.set_user_state(user_id, "waiting_for_trade_amount")
            
            await update.callback_query.edit_message_text("ğŸ’° Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯:")
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± Ø§Ù„Ù…Ø¨Ù„Øº: {e}")
            await update.callback_query.edit_message_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£")
    
    async def _handle_set_market_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE, data: str):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± ØªØ¹ÙŠÙŠÙ† Ù†ÙˆØ¹ Ø§Ù„Ø³ÙˆÙ‚"""
        try:
            user_id = int(data.split("_")[-1])
            
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­ Ù†ÙˆØ¹ Ø§Ù„Ø³ÙˆÙ‚
            keyboard = ui_manager.get_market_type_keyboard(user_id)
            
            await update.callback_query.edit_message_text("ğŸª Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø³ÙˆÙ‚:", reply_markup=keyboard)
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± Ø§Ù„Ø³ÙˆÙ‚: {e}")
            await update.callback_query.edit_message_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£")
    
    async def _handle_set_leverage_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE, data: str):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø±Ø§ÙØ¹Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©"""
        try:
            user_id = int(data.split("_")[-1])
            
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø±Ø§ÙØ¹Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©
            keyboard = ui_manager.get_leverage_keyboard(user_id)
            
            await update.callback_query.edit_message_text("âš¡ Ø§Ø®ØªØ± Ø§Ù„Ø±Ø§ÙØ¹Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©:", reply_markup=keyboard)
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± Ø§Ù„Ø±Ø§ÙØ¹Ø©: {e}")
            await update.callback_query.edit_message_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£")
    
    async def _handle_order_details_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE, data: str):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµÙÙ‚Ø©"""
        try:
            order_id = data.split("_")[-1]
            
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµÙÙ‚Ø©
            order_text = ui_manager.format_order_info(order_id)
            
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
            keyboard = ui_manager.get_order_details_keyboard(order_id)
            
            await update.callback_query.edit_message_text(order_text, reply_markup=keyboard)
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµÙÙ‚Ø©: {e}")
            await update.callback_query.edit_message_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµÙÙ‚Ø©")
    
    async def _handle_partial_close_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE, data: str):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ø²Ø¦ÙŠ"""
        try:
            order_id = data.split("_")[-1]
            
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ø²Ø¦ÙŠ
            keyboard = ui_manager.get_partial_close_keyboard(order_id)
            
            await update.callback_query.edit_message_text("ğŸ’° Ø§Ø®ØªØ± Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ø²Ø¦ÙŠ:", reply_markup=keyboard)
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ø²Ø¦ÙŠ: {e}")
            await update.callback_query.edit_message_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ø²Ø¦ÙŠ")
    
    async def _handle_close_order_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE, data: str):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙÙ‚Ø©"""
        try:
            order_id = data.split("_")[-1]
            
            # Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙÙ‚Ø©
            success = order_manager.close_order(order_id, "manual")
            
            if success:
                await update.callback_query.edit_message_text("âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙÙ‚Ø© Ø¨Ù†Ø¬Ø§Ø­")
            else:
                await update.callback_query.edit_message_text("âŒ ÙØ´Ù„ ÙÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙÙ‚Ø©")
                
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙÙ‚Ø©: {e}")
            await update.callback_query.edit_message_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙÙ‚Ø©")
    
    async def _handle_error(self, update: object, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡"""
        try:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙˆØª: {context.error}")
            
            # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ ÙÙŠ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ù…Ø§Ù†
            if update and hasattr(update, 'effective_user') and update.effective_user:
                user_id = update.effective_user.id
                security_manager.record_failed_attempt(user_id, f"bot_error: {context.error}")
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø®Ø·Ø£: {e}")
    
    def get_bot_stats(self) -> Dict:
        """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª"""
        try:
            uptime = 0
            if self.start_time:
                uptime = (datetime.now() - self.start_time).total_seconds()
            
            return {
                'is_running': self.is_running,
                'uptime': uptime,
                'start_time': self.start_time.isoformat() if self.start_time else None,
                'stats': self.stats.copy(),
                'timestamp': datetime.now().isoformat()
            }
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª: {e}")
            return {'error': str(e)}

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø«ÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
smart_bot = SmartTradingBot()

async def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    try:
        await smart_bot.start()
    except KeyboardInterrupt:
        logger.info("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª: {e}")
    finally:
        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
        try:
            security_manager.stop_security_monitoring()
            bot_controller.stop_monitoring()
            order_manager.stop_price_monitoring()
            logger.info("ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯")
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯: {e}")

if __name__ == "__main__":
    asyncio.run(main())
