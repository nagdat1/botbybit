# 🤖 دليل البوت متعدد المستخدمين - Bybit Trading Bot

## 📊 نظرة عامة

هذا بوت Telegram متعدد المستخدمين للتداول الآلي على منصة Bybit مع دعم كامل لـ:

### ✅ الميزات الأساسية
- **تعدد المستخدمين** - كل مستخدم له بيئة مستقلة تماماً
- **عزل كامل للبيانات** - لا يمكن لأي مستخدم الوصول إلى بيانات مستخدم آخر
- **ربط API آمن** - كل مستخدم يربط مفاتيح API الخاصة به
- **تشغيل/إيقاف مستقل** - كل مستخدم يتحكم في حالة بوته
- **دعم Spot و Futures** - تداول على جميع أنواع الأسواق
- **إدارة متقدمة للصفقات** - TP/SL/Partial Close لكل صفقة
- **حسابات تجريبية وحقيقية** - اختبر استراتيجياتك بأمان

---

## 🚀 كيفية التشغيل

### على Railway (موصى به)

1. **نشر المشروع على Railway**
   ```bash
   git clone https://github.com/yourusername/botbybit.git
   cd botbybit
   railway login
   railway init
   railway up
   ```

2. **تعيين متغيرات البيئة**
   ```bash
   railway variables set TELEGRAM_TOKEN=your_telegram_bot_token
   railway variables set ADMIN_USER_ID=your_telegram_user_id
   ```

3. **التشغيل التلقائي**
   - البوت سيبدأ تلقائياً على Railway
   - ملف `run_with_server.py` هو المسؤول عن التشغيل

### محلياً

```bash
# تثبيت المتطلبات
pip install -r requirements.txt

# إعداد متغيرات البيئة
cp env.example .env
# عدل الملف .env بمعلوماتك

# تشغيل البوت
python run_with_server.py
```

---

## 📱 كيفية استخدام البوت

### للمستخدمين الجدد

#### الخطوة 1: بدء المحادثة
1. ابحث عن البوت على Telegram
2. أرسل `/start`
3. سترى رسالة ترحيب مع زر "🔗 ربط API"

#### الخطوة 2: ربط API
1. اضغط على زر "🔗 ربط API"
2. أدخل `API_KEY` من Bybit
3. أدخل `API_SECRET` من Bybit
4. سيتم حفظ المفاتيح بشكل آمن

⚠️ **كيفية الحصول على مفاتيح API:**
- اذهب إلى https://api.bybit.com
- سجل الدخول إلى حسابك
- انتقل إلى API Management
- أنشئ مفتاح API جديد
- احفظ API_KEY و API_SECRET

#### الخطوة 3: إعداد البوت
1. افتح قسم "⚙️ الإعدادات"
2. قم بتعيين:
   - مبلغ التداول (مثل 100 USDT)
   - نوع السوق (Spot أو Futures)
   - نوع الحساب (تجريبي أو حقيقي)
   - الرافعة المالية (للـ Futures)

#### الخطوة 4: تشغيل البوت
1. في قسم الإعدادات، اضغط على "▶️ تشغيل البوت"
2. البوت الآن نشط ويمكنه معالجة الإشارات

---

## 🎮 الأوامر والأزرار

### القائمة الرئيسية

| الزر | الوظيفة |
|------|---------|
| ⚙️ الإعدادات | إعدادات البوت الشخصية |
| 📊 حالة الحساب | عرض معلومات حسابك |
| 🔄 الصفقات المفتوحة | عرض جميع صفقاتك المفتوحة |
| 📈 تاريخ التداول | سجل الصفقات السابقة |
| 💰 المحفظة | رصيدك وإحصائياتك |
| 📊 إحصائيات | إحصائيات التداول الشاملة |
| ▶️ تشغيل البوت | تفعيل البوت |
| ⏹️ إيقاف البوت | إيقاف البوت |

### قسم الإعدادات

| الزر | الوظيفة |
|------|---------|
| 💰 مبلغ التداول | تحديد مبلغ كل صفقة |
| 🏪 نوع السوق | اختيار Spot أو Futures |
| 👤 نوع الحساب | اختيار تجريبي أو حقيقي |
| ⚡ الرافعة المالية | تحديد الرافعة (للـ Futures) |
| 💳 رصيد الحساب التجريبي | تعديل رصيد الحساب التجريبي |
| 🔗 تحديث API | تحديث مفاتيح API |
| ▶️/⏹️ تشغيل/إيقاف | تبديل حالة البوت |

---

## 🔄 إدارة الصفقات

### عرض الصفقات المفتوحة

عند فتح قائمة "🔄 الصفقات المفتوحة"، سترى:

**لصفقات Spot:**
```
🟢💰 BTCUSDT
🔄 النوع: BUY
💲 سعر الدخول: 30000.00
💲 السعر الحالي: 30500.00
💰 المبلغ: 100.00
⬆️ الربح/الخسارة: 1.67 (1.67%) - رابح
🆔 رقم الصفقة: BTCUSDT_123456789

[❌ إغلاق BTCUSDT (+1.67)]
```

**لصفقات Futures:**
```
🟢💰 ETHUSDT
🔄 النوع: BUY
💲 سعر الدخول: 2000.00
💲 السعر الحالي: 2050.00
💰 الهامش المحجوز: 100.00
📈 حجم الصفقة: 1000.00
⬆️ الربح/الخسارة: 50.00 (50.00%) - رابح
⚡ الرافعة: 10x
⚠️ سعر التصفية: 1800.00
📊 عدد العقود: 0.5
🆔 رقم الصفقة: ETHUSDT_987654321

[❌ إغلاق ETHUSDT (+50.00)]
```

### إغلاق الصفقات

1. اضغط على زر "❌ إغلاق" للصفقة المطلوبة
2. سيتم إغلاق الصفقة بالسعر الحالي
3. سيتم تحديث رصيدك تلقائياً
4. سترى ملخص الصفقة المغلقة

---

## 💰 إدارة الرصيد

### الحساب التجريبي (Demo)
- رصيد افتراضي: 10,000 USDT
- يمكنك تعديله من قسم الإعدادات
- مثالي لاختبار الاستراتيجيات

### الحساب الحقيقي (Real)
- يتطلب ربط API من Bybit
- يستخدم رصيدك الحقيقي على المنصة
- جميع الصفقات حقيقية

---

## 🔒 الأمان والخصوصية

### عزل المستخدمين
- كل مستخدم له `user_id` فريد
- جميع البيانات مرتبطة بـ `user_id`
- لا يمكن لأي مستخدم الوصول إلى:
  - مفاتيح API الخاصة بمستخدم آخر
  - صفقات مستخدم آخر
  - رصيد مستخدم آخر
  - إعدادات مستخدم آخر

### تخزين API Keys
- يتم تخزين المفاتيح في قاعدة بيانات SQLite
- كل مستخدم له مفاتيح منفصلة
- الاتصال دائماً عبر HTTPS إلى Bybit Live API

### حماية الأوامر
- التحقق من `is_active` قبل تنفيذ أي أمر
- إذا كان البوت متوقفاً، لن يتم معالجة الإشارات
- يمكنك إيقاف البوت في أي وقت من قسم الإعدادات

---

## 🗄️ قاعدة البيانات

### جدول `users`
يحتوي على معلومات كل مستخدم:
- `user_id` - المعرف الفريد (من Telegram)
- `api_key` - مفتاح API
- `api_secret` - سر API
- `balance` - الرصيد الحالي
- `is_active` - حالة البوت (TRUE/FALSE)
- `market_type` - نوع السوق (spot/futures)
- `account_type` - نوع الحساب (demo/real)
- `trade_amount` - مبلغ التداول
- `leverage` - الرافعة المالية
- `partial_percents` - نسب الإغلاق الجزئي (JSON)
- `tps_percents` - نسب أهداف الربح (JSON)
- `notifications` - تفعيل الإشعارات
- `preferred_symbols` - الأزواج المفضلة (JSON)
- `created_at` - تاريخ الإنشاء
- `updated_at` - تاريخ آخر تحديث

### جدول `orders`
يحتوي على جميع الصفقات:
- `order_id` - معرف الصفقة الفريد
- `user_id` - معرف المستخدم (ربط بجدول users)
- `symbol` - الزوج (مثل BTCUSDT)
- `side` - نوع الصفقة (BUY/SELL)
- `entry_price` - سعر الدخول
- `quantity` - الكمية
- `open_time` - وقت الفتح
- `close_time` - وقت الإغلاق (NULL إذا مفتوحة)
- `tps` - أهداف الربح (JSON)
- `sl` - وقف الخسارة
- `partial_close` - نسب الإغلاق الجزئي (JSON)
- `status` - الحالة (OPEN/CLOSED/CANCELLED)
- `notes` - ملاحظات إضافية

### جدول `user_settings`
إعدادات إضافية لكل مستخدم:
- `user_id` - معرف المستخدم
- `market_type` - نوع السوق
- `trade_amount` - مبلغ التداول
- `leverage` - الرافعة المالية
- `account_type` - نوع الحساب

---

## 🏗️ بنية المشروع

```
botbybit/
├── bybit_trading_bot.py   # البوت الرئيسي مع جميع الأوامر
├── user_manager.py         # إدارة المستخدمين والعزل
├── database.py             # قاعدة بيانات SQLite
├── config.py               # ملف الإعدادات
├── web_server.py           # سيرفر الويب لاستقبال الإشارات
├── run_with_server.py      # ملف التشغيل الرئيسي
├── app.py                  # تطبيق Flask الإضافي
├── health.py               # صحة التطبيق
├── requirements.txt        # المتطلبات البرمجية
├── Dockerfile              # لحاويات Docker
├── railway.toml            # إعدادات Railway
├── railway_start.sh        # سكريبت بدء Railway
└── README.md               # الدليل الرئيسي
```

---

## 🔧 الإعدادات المتقدمة

### ملف `config.py`

```python
# إعدادات Telegram
TELEGRAM_TOKEN = "your_telegram_bot_token"
ADMIN_USER_ID = your_telegram_user_id

# إعدادات Bybit (اختيارية - كل مستخدم يربط مفاتيحه)
BYBIT_API_KEY = "optional_default_key"
BYBIT_API_SECRET = "optional_default_secret"
BYBIT_BASE_URL = "https://api.bybit.com"  # دائماً Live

# إعدادات افتراضية
DEFAULT_SETTINGS = {
    'account_type': 'demo',
    'market_type': 'spot',
    'trade_amount': 100.0,
    'leverage': 10,
    'tp1_percent': 1.5,
    'tp2_percent': 3.0,
    'tp3_percent': 6.0,
    'stop_loss_percent': 2.0
}

# إعدادات الحساب التجريبي
DEMO_ACCOUNT_SETTINGS = {
    'initial_balance_spot': 10000.0,
    'initial_balance_futures': 10000.0
}
```

---

## 📊 أمثلة الاستخدام

### مثال 1: مستخدم جديد - تداول تجريبي

1. أرسل `/start`
2. اختر "تخطي" ربط API (للحساب التجريبي)
3. افتح "⚙️ الإعدادات"
4. اختر "👤 نوع الحساب" → "تجريبي داخلي"
5. اختر "💰 مبلغ التداول" → أدخل 100
6. اضغط "▶️ تشغيل البوت"
7. أرسل إشارة تداول من TradingView
8. افتح "🔄 الصفقات المفتوحة" لمشاهدة الصفقة

### مثال 2: مستخدم متقدم - تداول حقيقي على Futures

1. أرسل `/start`
2. اضغط "🔗 ربط API"
3. أدخل API_KEY و API_SECRET من Bybit
4. افتح "⚙️ الإعدادات"
5. اختر "🏪 نوع السوق" → "Futures"
6. اختر "👤 نوع الحساب" → "حقيقي"
7. اختر "⚡ الرافعة المالية" → أدخل 10
8. اختر "💰 مبلغ التداول" → أدخل 100
9. اضغط "▶️ تشغيل البوت"
10. أرسل إشارات من TradingView
11. تابع صفقاتك في الوقت الحقيقي

### مثال 3: إيقاف البوت مؤقتاً

1. افتح "⚙️ الإعدادات"
2. اضغط "⏹️ إيقاف البوت"
3. البوت الآن متوقف ولن يعالج أي إشارات
4. لإعادة التشغيل: "▶️ تشغيل البوت"

---

## 🌐 استقبال الإشارات من TradingView

### على Railway

1. بعد النشر على Railway، سيرسل البوت رابط Webhook تلقائياً
2. استخدم هذا الرابط في TradingView Alert
3. مثال: `https://your-app.railway.app/webhook`

### الإعداد في TradingView

1. افتح الرسم البياني
2. أنشئ تنبيه (Alert)
3. اختر Webhook URL
4. أدخل الرابط من Railway
5. أضف JSON Body:
```json
{
  "symbol": "BTCUSDT",
  "action": "buy"
}
```
6. احفظ التنبيه

---

## 🐛 استكشاف الأخطاء

### البوت لا يستجيب
- تحقق من أن `is_active = TRUE` في قاعدة البيانات
- تأكد من أن البوت يعمل على Railway
- تحقق من صحة TELEGRAM_TOKEN

### لا يمكن ربط API
- تحقق من صحة المفاتيح
- تأكد من أن API له صلاحيات التداول
- جرب إنشاء مفاتيح جديدة

### الصفقات لا تُنفذ
- تحقق من حالة `is_active` للمستخدم
- تأكد من نوع الحساب (تجريبي/حقيقي)
- تحقق من الرصيد المتاح

---

## 📧 الدعم

للمساعدة أو الاستفسارات:
- افتح Issue على GitHub
- راسلنا على Telegram
- راجع الوثائق في `README.md`

---

## 📝 ملاحظات مهمة

⚠️ **تحذيرات:**
1. التداول ينطوي على مخاطر - استخدم الحساب التجريبي أولاً
2. لا تشارك مفاتيح API مع أي شخص
3. ابدأ بمبالغ صغيرة عند التداول الحقيقي
4. راجع إعداداتك قبل تفعيل البوت

✅ **أفضل الممارسات:**
1. اختبر استراتيجيتك على الحساب التجريبي
2. ابدأ بمبلغ تداول صغير
3. راقب صفقاتك بانتظام
4. استخدم وقف الخسارة دائماً
5. احتفظ بنسخة احتياطية من قاعدة البيانات

---

## 📜 الترخيص

هذا المشروع مفتوح المصدر ويمكن استخدامه بحرية. لا تتحمل الأداة أي مسؤولية عن خسائر التداول.

---

**آخر تحديث:** أكتوبر 2025
**الإصدار:** 2.0.0 (Multi-User)

