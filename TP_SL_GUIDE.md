# دليل نظام Take Profit و Stop Loss المتقدم

## نظرة عامة

تم إضافة نظام متقدم لإدارة Take Profit (TP) و Stop Loss (SL) المتعدد مع دعم الإغلاقات الجزئية إلى بوت التداول على Bybit.

## المميزات الرئيسية

### 1. Take Profit المتعدد
- إمكانية إضافة عدة مستويات Take Profit لكل صفقة (TP1, TP2, TP3, ...)
- تحديد السعر المستهدف بطريقتين:
  - **نسبة مئوية**: مثل +5% من سعر الدخول
  - **سعر محدد**: مثل 50000 USDT
- تحديد نسبة الإغلاق لكل مستوى (25%, 50%, 75%, 100%)

### 2. Stop Loss الذكي
- تحديد Stop Loss بطريقتين:
  - **نسبة مئوية**: مثل -2% من سعر الدخول
  - **سعر محدد**: مثل 48000 USDT
- دعم **Trailing Stop** (قيد التطوير المستقبلي)
- تحديث تلقائي للـ SL حسب حركة السعر

### 3. الإغلاقات الجزئية
- إمكانية إغلاق جزء من الصفقة عند كل مستوى TP
- تتبع الكمية المتبقية من الصفقة
- حساب دقيق للأرباح/الخسائر لكل إغلاق جزئي

### 4. المراقبة التلقائية
- نظام مراقبة مستمر للأسعار (كل 10 ثواني)
- تفعيل تلقائي لـ TP/SL عند الوصول للسعر المستهدف
- إشعارات فورية عند التنفيذ

## بنية الملفات

```
botbybit/
├── order_manager.py         # إدارة الصفقات وTP/SL
├── trade_interface.py       # واجهة المستخدم التفاعلية
├── bot_integration.py       # ربط النظام مع البوت
├── database.py              # قاعدة البيانات (محدّثة)
└── bybit_trading_bot.py     # البوت الرئيسي (سيتم تحديثه)
```

## كيفية الاستخدام

### 1. فتح صفقة جديدة مع TP/SL

#### الخطوة 1: فتح الصفقة
عند فتح صفقة جديدة، سيظهر لك قائمة خيارات:
```
📊 إعداد صفقة جديدة
🔸 الرمز: BTCUSDT
🔸 النوع: BUY
🔸 السعر: 50000.000000
🔸 الكمية: 0.1

[📈 إضافة Take Profit]
[🛡️ إضافة Stop Loss]
[✅ فتح الصفقة الآن]
[❌ إلغاء]
```

#### الخطوة 2: إضافة Take Profit
1. اضغط على "📈 إضافة Take Profit"
2. اختر طريقة تحديد السعر:
   - **نسبة مئوية (%)**: مثل 5 (يعني +5%)
   - **سعر محدد**: مثل 52500
3. أدخل القيمة
4. اختر نسبة الإغلاق:
   - 25% - 50% - 75% - 100%
5. يمكنك إضافة عدة مستويات TP

#### الخطوة 3: إضافة Stop Loss
1. اضغط على "🛡️ إضافة Stop Loss"
2. اختر طريقة تحديد السعر:
   - **نسبة مئوية (%)**: مثل 2 (يعني -2%)
   - **سعر محدد**: مثل 49000
3. أدخل القيمة

#### الخطوة 4: تأكيد الصفقة
اضغط على "✅ فتح الصفقة الآن" لتأكيد وفتح الصفقة مع TP/SL

### 2. إدارة الصفقات المفتوحة

عند عرض الصفقات المفتوحة، ستظهر تفاصيل TP/SL:
```
📊 تفاصيل الصفقة

🔸 الرمز: BTCUSDT
🔸 النوع: BUY
🔸 سعر الدخول: 50000.000000
🔸 السعر الحالي: 51000.000000
🔸 PnL غير محقق: +100.00

📈 Take Profit Levels:
⏳ TP1: 51250.000000 (50%)
⏳ TP2: 52500.000000 (50%)

🛡️ Stop Loss:
⏳ SL: 49000.000000

[📈 إضافة TP]
[🛡️ تعديل SL]
[📊 إغلاق جزئي]
[❌ إغلاق كامل]
[🔄 تحديث]
[🔙 العودة]
```

### 3. التفاعل مع TP/SL

#### عند تفعيل Take Profit:
```
✅ Take Profit 1 مُفعّل!

📊 الصفقة: BTCUSDT
💲 سعر الدخول: 50000.000000
💲 سعر التنفيذ: 51250.000000
💰 الكمية المُغلقة: 0.05 (50%)
🟢 PnL: +62.50

الكمية المتبقية: 0.05
```

#### عند تفعيل Stop Loss:
```
⚠️ Stop Loss مُفعّل!

📊 الصفقة: BTCUSDT
💲 سعر الدخول: 50000.000000
💲 سعر التنفيذ: 49000.000000
💰 الكمية: 0.1
🔴 PnL: -100.00

تم إغلاق الصفقة بالكامل.
```

## أمثلة عملية

### مثال 1: استراتيجية Conservative
```
صفقة: شراء BTC عند 50000$
الكمية: 0.1 BTC

TP1: +2% (50% من الصفقة) = 51000$
TP2: +5% (50% من الصفقة) = 52500$
SL: -2% = 49000$

النتيجة المحتملة:
- عند TP1: إغلاق 0.05 BTC بربح +50$
- عند TP2: إغلاق 0.05 BTC بربح +125$
- إجمالي الربح: +175$
```

### مثال 2: استراتيجية Aggressive
```
صفقة: شراء ETH عند 3000$
الكمية: 1 ETH

TP1: +5% (25%) = 3150$
TP2: +10% (25%) = 3300$
TP3: +15% (50%) = 3450$
SL: -3% = 2910$

النتيجة المحتملة:
- عند TP1: إغلاق 0.25 ETH بربح +37.5$
- عند TP2: إغلاق 0.25 ETH بربح +75$
- عند TP3: إغلاق 0.5 ETH بربح +225$
- إجمالي الربح: +337.5$
```

### مثال 3: Futures مع رافعة مالية
```
صفقة: شراء BTC Futures عند 50000$
الهامش: 1000$
الرافعة: 10x
حجم الصفقة: 10000$

TP1: +2% (50%) = 51000$ → ربح +100$
TP2: +4% (50%) = 52000$ → ربح +200$
SL: -5% = 47500$ → خسارة -250$
```

## الربط مع البوت الحالي

لتفعيل النظام في البوت الحالي، أضف الأسطر التالية في `bybit_trading_bot.py`:

```python
# في بداية الملف
from order_manager import order_manager, PriceType
from trade_interface import trade_interface
from bot_integration import bot_integration

# في دالة main() بعد إعداد application
# بدء نظام مراقبة الأسعار
async def start_monitoring():
    await bot_integration.load_managed_orders_from_db()
    await bot_integration.start_price_monitoring(trading_bot.bybit_api)

# إضافة إلى application
application.post_init = start_monitoring

# في معالج الأزرار (handle_callback)
# إضافة معالجات لأزرار TP/SL
if data.startswith("trade_"):
    # معالجة أزرار واجهة التداول
    await handle_trade_interface(update, context, data)
```

## قاعدة البيانات

### جداول جديدة:

#### 1. `take_profit_levels`
- id (PRIMARY KEY)
- order_id (FOREIGN KEY)
- level_number
- price_type ('percentage' أو 'price')
- value
- close_percentage
- target_price
- executed
- executed_time
- executed_price
- pnl

#### 2. `stop_losses`
- id (PRIMARY KEY)
- order_id (FOREIGN KEY)
- price_type ('percentage' أو 'price')
- value
- target_price
- trailing
- trailing_distance
- trailing_activated_price
- executed
- executed_time
- executed_price
- pnl

#### 3. `partial_closes`
- id (PRIMARY KEY)
- order_id (FOREIGN KEY)
- close_type ('TAKE_PROFIT' أو 'STOP_LOSS' أو 'MANUAL')
- level
- price
- quantity
- percentage
- pnl
- close_time

## استراتيجيات TP/SL الموصى بها

### 1. Fixed Ratio (1:2)
```
Risk: 2%
Reward: 4%
Example: Entry 50000, SL 49000 (-2%), TP 52000 (+4%)
```

### 2. Scaled Take Profit
```
TP1: +2% (33%)
TP2: +5% (33%)
TP3: +10% (34%)
SL: -2%
```

### 3. Break-even Strategy
```
TP1: +2% (50%) → رفع SL إلى نقطة الدخول
TP2: +5% (50%)
SL: -2% (يصبح 0% بعد TP1)
```

### 4. Trailing Stop
```
Entry: 50000
Initial SL: 49000 (-2%)
Trailing Distance: 1%

إذا وصل السعر إلى 51000:
New SL: 50490 (-1% من السعر الحالي)
```

## الأخطاء الشائعة وحلولها

### 1. "الصفقة غير موجودة"
**الحل**: تأكد من فتح الصفقة أولاً قبل إضافة TP/SL

### 2. "فشل في حساب السعر المستهدف"
**الحل**: تأكد من إدخال قيمة صحيحة (رقم موجب)

### 3. "نسبة الإغلاق غير صحيحة"
**الحل**: يجب أن تكون النسبة بين 0 و 100

### 4. "TP/SL لم يتم تفعيله"
**الحل**: 
- تأكد من أن نظام المراقبة نشط
- تحقق من أن السعر المستهدف صحيح
- راجع logs البوت للأخطاء

## التطويرات المستقبلية

- [ ] دعم Trailing Stop بالكامل
- [ ] واجهة ويب لإدارة TP/SL
- [ ] تحليلات متقدمة للأداء
- [ ] إشارات ذكية لاقتراح TP/SL
- [ ] دعم OCO (One-Cancels-Other)
- [ ] Break-even تلقائي

## الدعم

للمساعدة أو الإبلاغ عن مشاكل:
- راجع logs البوت في `trading_bot.log`
- افتح issue على GitHub
- استخدم أمر `/start` للعودة إلى القائمة الرئيسية

## الخلاصة

نظام TP/SL المتقدم يوفر:
- ✅ إدارة احترافية للمخاطر
- ✅ تنفيذ تلقائي دقيق
- ✅ مرونة في التخصيص
- ✅ تتبع شامل للأداء
- ✅ دعم كامل لـ Spot و Futures

استمتع بتداول آمن واحترافي! 🚀

