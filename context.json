{
  "context_extension": "multi_user_wallet_and_trade_management",
  "description": "نظام إدارة شامل لعزل حسابات المستخدمين وربط الصفقات بمحافظهم الشخصية داخل البوت، مشابه تمامًا لتصميم 3Commas.",
  
  "1_user_accounts": {
    "description": "كل مستخدم يملك حساب مستقل تمامًا داخل النظام.",
    "data_model": {
      "user_id": "معرّف المستخدم داخل تيليجرام أو النظام",
      "exchange": "اسم المنصة المرتبطة (Bybit, Binance, OKX, ...)",
      "api_key": "المفتاح العام لحساب المستخدم في المنصة",
      "api_secret": "المفتاح السري لحساب المستخدم",
      "connected_wallets": [
        {
          "wallet_id": "UUID مميز لكل محفظة",
          "wallet_type": "spot أو futures أو margin",
          "base_currency": "USDT أو BTC أو ETH",
          "balance": 1530.75,
          "leverage": 10,
          "is_active": true
        }
      ],
      "settings": {
        "risk_limit_percent": 2,
        "max_concurrent_trades": 5,
        "default_sl_percent": 1.5,
        "default_tp_percent": [1.5, 3.0, 5.0],
        "auto_trailing": true,
        "auto_break_even": true
      },
      "permissions": {
        "can_trade": true,
        "can_withdraw": false,
        "can_link_other_wallets": true
      }
    },
    "rules": [
      "كل مستخدم يُخزن في JSON أو قاعدة بيانات SQLite مستقلة.",
      "لا يمكن لأي مستخدم رؤية أو التفاعل مع بيانات مستخدم آخر.",
      "كل أوامر التداول تُنسب لحساب user_id + wallet_id فقط.",
      "الإيجنت يجب أن يعالج كل عملية داخل سياق المستخدم النشط فقط."
    ]
  },
  
  "2_wallet_trade_linkage": {
    "description": "ربط الصفقات مباشرة بالمحفظة الخاصة بكل مستخدم مع تتبع الرصيد الفعلي.",
    "mechanism": {
      "trade_execution_flow": [
        "استقبال الإشارة أو أمر المستخدم",
        "تحديد wallet_id المناسب بناءً على نوع التداول (spot/futures)",
        "التحقق من الرصيد المتاح",
        "تحديد حجم الصفقة بناءً على نسبة المخاطرة أو المبلغ الثابت",
        "فتح الصفقة وتخزينها في سجل المحفظة"
      ],
      "wallet_update_flow": [
        "عند فتح صفقة: خصم المبلغ المحجوز من balance.available",
        "عند تحقق TP أو SL: إعادة تحديث balance.total",
        "عند الإغلاق الجزئي: إعادة النسبة المنفذة إلى الرصيد الحر"
      ]
    },
    "data_example": {
      "trade_id": "TRD-2025-1001",
      "user_id": 123456789,
      "wallet_id": "WLT-001-BTCUSDT-SPOT",
      "symbol": "BTCUSDT",
      "type": "spot",
      "side": "buy",
      "entry_price": 30000.0,
      "amount": 100.0,
      "tps": [30450.0, 30900.0, 31500.0],
      "sl": 29400.0,
      "status": "open",
      "allocated_balance": 100.0,
      "linked_wallet": {
        "balance_before": 1530.75,
        "balance_after": 1430.75
      }
    }
  },
  
  "3_multi_exchange_support": {
    "description": "إدارة حسابات متعددة لكل مستخدم عبر منصات مختلفة.",
    "capabilities": {
      "supported_exchanges": ["Bybit", "Binance", "MEXC", "OKX", "KuCoin"],
      "per_user_exchange_limit": 3,
      "exchange_connection_model": {
        "exchange_id": "EXG-UUID",
        "user_id": "مرتبط بالمستخدم",
        "api_credentials": {
          "key": "API_KEY",
          "secret": "API_SECRET"
        },
        "connected_wallets": ["WLT-001", "WLT-002"],
        "status": "connected"
      }
    },
    "auto_selection_logic": "النظام يختار المنصة الأنسب للصفقة حسب السيولة أو الفوليوم أو التوصية."
  },
  
  "4_trade_routing_system": {
    "description": "آلية توزيع وتنفيذ الصفقات بين محافظ المستخدمين ومنصاتهم.",
    "process": [
      "تحديد الإشارة (Buy/Sell)",
      "فلترة المستخدمين النشطين (is_active = true)",
      "لكل مستخدم، اختيار المنصة والمحفظة الأنسب",
      "تنفيذ الصفقة عبر واجهة API الخاصة بالمنصة",
      "تحديث سجل الصفقات والمحفظة في JSON"
    ],
    "routing_modes": [
      "manual": "ينفذ فقط عند أمر المستخدم.",
      "auto": "ينفذ تلقائيًا بناءً على الإشارات.",
      "copy": "ينسخ صفقة مستخدم رئيسي إلى المحافظ المرتبطة."
    ]
  },
  
  "5_trade_wallet_linked_reporting": {
    "description": "كل صفقة تكون مرتبطة بمحفظة معينة لتتبع الأداء والرصيد بدقة.",
    "report_data": {
      "wallet_id": "المحفظة المنفذة عليها الصفقة",
      "total_open_trades": 3,
      "total_profit_usd": 120.5,
      "total_loss_usd": -45.3,
      "net_balance": 1605.95,
      "active_orders": ["TRD-2025-1001", "TRD-2025-1002"],
      "closed_orders": ["TRD-2025-0999"]
    },
    "analysis_logic": "يتم حساب الأداء اليومي والأسبوعي لكل محفظة على حدة، وليس للمستخدم ككل."
  },
  
  "6_isolation_security_layer": {
    "description": "طبقة الأمان والعزل الكامل بين المستخدمين والمحافظ.",
    "rules": [
      "تشفير مفاتيح API باستخدام AES256 أو RSA.",
      "تخزين المفاتيح في بيئة آمنة (Environment Variables).",
      "التحقق من هوية المستخدم قبل كل عملية.",
      "منع أي عمليات متزامنة على نفس المحفظة.",
      "كل العمليات تتم داخل Thread أو Session مستقل."
    ],
    "session_management": {
      "user_sessions": "جلسة لكل مستخدم.",
      "wallet_contexts": "سياق عمليات مستقل لكل محفظة داخل الجلسة."
    }
  },
  
  "7_inter_wallet_relations": {
    "description": "التحكم في العلاقات بين المحافظ داخل نفس الحساب.",
    "relations": [
      "main_wallet": "المحفظة الرئيسية التي يتم تحويل الأرباح إليها.",
      "trading_wallet": "المحفظة المستخدمة فعليًا في الصفقات.",
      "reserve_wallet": "محفظة احتياطية تستخدم في DCA أو تعزيز الصفقات.",
      "linking_rules": "يجب أن تكون جميع المحافظ بنفس العملة الأساسية (Base Currency)."
    ],
    "sync_behavior": "يتم تحديث جميع المحافظ التابعة تلقائيًا بعد كل صفقة."
  },
  
  "8_copy_trading_logic": {
    "description": "نظام نسخ الصفقات بين محافظ المستخدمين المتصلين.",
    "structure": {
      "leader_user_id": 111111,
      "followers": [222222, 333333],
      "copy_ratio": 0.5,
      "delay_seconds": 2,
      "rules": [
        "الصفقات تُنسخ فقط إذا توافرت السيولة في محفظة المتابع.",
        "النسخ يشمل TP/SL/Partial بنفس النسب المئوية.",
        "يتم تجاهل أوامر Futures إذا كانت المحفظة Spot والعكس."
      ]
    }
  }
}
