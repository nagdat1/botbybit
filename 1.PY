# Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ API
async def verify_api_connection(api_key: str, api_secret: str) -> tuple[bool, str]:
    """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§ØªØµØ§Ù„ API"""
    try:
        # Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† API Ù…Ø¤Ù‚Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        test_api = BybitAPI(api_key, api_secret)
        
        # Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„ØªØ­Ù‚Ù‚
        response = test_api.get_account_balance()
        
        if response.get("retCode") == 0:
            return True, "âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­"
        else:
            error_msg = response.get("retMsg", "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø­Ø¯Ø¯")
            return False, f"âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: {error_msg}"
            
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† API: {e}")
        return False, f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: {str(e)}"

def mask_api_credentials(api_key: str, api_secret: str) -> tuple[str, str]:
    """Ø¥Ø®ÙØ§Ø¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª API Ø¬Ø²Ø¦ÙŠØ§Ù‹ Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¢Ù…Ù†"""
    if not api_key or not api_secret:
        return "ØºÙŠØ± Ù…Ø­Ø¯Ø¯", "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"
    
    # Ø¥Ø¸Ù‡Ø§Ø± Ø£ÙˆÙ„ 4 ÙˆØ¢Ø®Ø± 4 Ø£Ø­Ø±Ù ÙÙ‚Ø·
    masked_key = f"{api_key[:4]}...{api_key[-4:]}" if len(api_key) > 8 else "****"
    masked_secret = f"{api_secret[:4]}...{api_secret[-4:]}" if len(api_secret) > 8 else "****"
    
    return masked_key, masked_secret

# ØªØ­Ø¯ÙŠØ« ÙˆØ¸ÙŠÙØ© start Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª API
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª Ù…Ø¹ Ø¯Ø¹Ù… ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"""
    if update.effective_user is None:
        return
    
    user_id = update.effective_user.id
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    user_data = user_manager.get_user(user_id)
    
    if not user_data:
        # Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ - Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
        user_manager.create_user(user_id)
        user_data = user_manager.get_user(user_id)
        
        # Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        welcome_message = f"""
ğŸ¤– Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Bybit Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†

ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ {update.effective_user.first_name}!

ğŸ”— Ù„Ù„Ø¨Ø¯Ø¡ØŒ ÙŠØ±Ø¬Ù‰ Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨Ùƒ Ø¹Ù„Ù‰ Bybit:
â€¢ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "ğŸ”— Ø±Ø¨Ø· API" Ø£Ø¯Ù†Ø§Ù‡
â€¢ Ø³ÙŠØ·Ù„Ø¨ Ù…Ù†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ API_KEY Ùˆ API_SECRET
â€¢ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù…Ù†: https://api.bybit.com

âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¨ÙˆØª ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ÙˆØ§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ
        """
        
        keyboard = [
            [InlineKeyboardButton("ğŸ”— Ø±Ø¨Ø· API", callback_data="link_api")],
            [InlineKeyboardButton("â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª", callback_data="info")]
        ]
        
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        if update.message is not None:
            await update.message.reply_text(welcome_message, reply_markup=reply_markup)
        return
    
    # Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ - Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    keyboard = [
        [KeyboardButton("âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"), KeyboardButton("ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨")],
        [KeyboardButton("ğŸ”„ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©"), KeyboardButton("ğŸ“ˆ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¯Ø§ÙˆÙ„")],
        [KeyboardButton("ğŸ’° Ø§Ù„Ù…Ø­ÙØ¸Ø©"), KeyboardButton("ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª")]
    ]
    
    # Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø¥Ø¶Ø§ÙÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø´Ø·Ø§Ù‹
    if user_data.get('is_active'):
        keyboard.append([KeyboardButton("â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª")])
    else:
        keyboard.append([KeyboardButton("â–¶ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª")])
    
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    market_type = user_data.get('market_type', 'spot')
    account = user_manager.get_user_account(user_id, market_type)
    
    if account:
        account_info = account.get_account_info()
    else:
        account_info = {
            'balance': user_data.get('balance', 10000.0),
            'available_balance': user_data.get('balance', 10000.0),
            'open_positions': 0
        }
    
    # Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª
    bot_status = "ğŸŸ¢ Ù†Ø´Ø·" if user_data.get('is_active') else "ğŸ”´ Ù…ØªÙˆÙ‚Ù"
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© API
    api_key = user_data.get('api_key')
    api_secret = user_data.get('api_secret')
    
    if api_key and api_secret:
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        is_connected, connection_msg = await verify_api_connection(api_key, api_secret)
        api_status = "ğŸŸ¢ Ù…ØªØµÙ„" if is_connected else "ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„"
        
        # Ø¥Ø®ÙØ§Ø¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª API Ø¬Ø²Ø¦ÙŠØ§Ù‹
        masked_key, masked_secret = mask_api_credentials(api_key, api_secret)
        api_info = f"""
ğŸ”‘ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª API:
â€¢ API Key: {masked_key}
â€¢ API Secret: {masked_secret}
â€¢ Ø§Ù„Ø­Ø§Ù„Ø©: {api_status}
        """
    else:
        api_status = "ğŸ”´ ØºÙŠØ± Ù…Ø±ØªØ¨Ø·"
        api_info = "ğŸ”— API ØºÙŠØ± Ù…Ø±ØªØ¨Ø· - Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù„Ø±Ø¨Ø·"
    
    welcome_message = f"""
ğŸ¤– Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ {update.effective_user.first_name}

ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª: {bot_status}
ğŸ”— Ø­Ø§Ù„Ø© API: {api_status}

{api_info}

ğŸ’° Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨:
â€¢ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ„ÙŠ: {account_info.get('balance', 0):.2f} USDT
â€¢ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­: {account_info.get('available_balance', 0):.2f} USDT
â€¢ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©: {account_info.get('open_positions', 0)}

Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„Ù„ØªÙ†Ù‚Ù„ ÙÙŠ Ø§Ù„Ø¨ÙˆØª
    """
    
    if update.message is not None:
        await update.message.reply_text(welcome_message, reply_markup=reply_markup)

# ØªØ­Ø¯ÙŠØ« ÙˆØ¸ÙŠÙØ© settings_menu Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ø­Ø§Ù„Ø© API
async def settings_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…"""
    if update.effective_user is None:
        return
    
    user_id = update.effective_user.id
    user_data = user_manager.get_user(user_id)
    
    if not user_data:
        if update.message is not None:
            await update.message.reply_text("âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… /start Ø£ÙˆÙ„Ø§Ù‹")
        return
    
    keyboard = [
        [InlineKeyboardButton("ğŸ’° Ù…Ø¨Ù„Øº Ø§Ù„ØªØ¯Ø§ÙˆÙ„", callback_data="set_amount")],
        [InlineKeyboardButton("ğŸª Ù†ÙˆØ¹ Ø§Ù„Ø³ÙˆÙ‚", callback_data="set_market")],
        [InlineKeyboardButton("ğŸ‘¤ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨", callback_data="set_account")],
        [InlineKeyboardButton("âš¡ Ø§Ù„Ø±Ø§ÙØ¹Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©", callback_data="set_leverage")],
        [InlineKeyboardButton("ğŸ’³ Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ", callback_data="set_demo_balance")],
        [InlineKeyboardButton("ğŸ”— ØªØ­Ø¯ÙŠØ« API", callback_data="link_api")]
    ]
    
    # Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª
    if user_data.get('is_active'):
        keyboard.append([InlineKeyboardButton("â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª", callback_data="toggle_bot")])
    else:
        keyboard.append([InlineKeyboardButton("â–¶ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª", callback_data="toggle_bot")])
    
    keyboard.append([InlineKeyboardButton("ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©", callback_data="main_menu")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    market_type = user_data.get('market_type', 'spot')
    account = user_manager.get_user_account(user_id, market_type)
    
    if account:
        account_info = account.get_account_info()
    else:
        account_info = {
            'balance': user_data.get('balance', 10000.0),
            'available_balance': user_data.get('balance', 10000.0),
            'margin_locked': 0,
            'unrealized_pnl': 0
        }
    
    # Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª
    bot_status = "ğŸŸ¢ Ù†Ø´Ø·" if user_data.get('is_active') else "ğŸ”´ Ù…ØªÙˆÙ‚Ù"
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© API ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
    api_key = user_data.get('api_key')
    api_secret = user_data.get('api_secret')
    
    if api_key and api_secret:
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        is_connected, connection_msg = await verify_api_connection(api_key, api_secret)
        api_status = "ğŸŸ¢ Ù…ØªØµÙ„ ÙˆÙØ¹Ø§Ù„" if is_connected else "ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„"
        
        # Ø¥Ø®ÙØ§Ø¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª API Ø¬Ø²Ø¦ÙŠØ§Ù‹
        masked_key, masked_secret = mask_api_credentials(api_key, api_secret)
        api_details = f"""
ğŸ”‘ ØªÙØ§ØµÙŠÙ„ API:
â€¢ Key: {masked_key}
â€¢ Secret: {masked_secret}
â€¢ Ø§Ù„Ø­Ø§Ù„Ø©: {api_status}
        """
    else:
        api_status = "ğŸ”´ ØºÙŠØ± Ù…Ø±ØªØ¨Ø·"
        api_details = "âš ï¸ Ù„Ù… ÙŠØªÙ… Ø±Ø¨Ø· API Ø¨Ø¹Ø¯"
    
    account_type = user_data.get('account_type', 'demo')
    trade_amount = user_data.get('trade_amount', 100.0)
    leverage = user_data.get('leverage', 10)
    
    settings_text = f"""
âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:

ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª: {bot_status}
ğŸ”— Ø­Ø§Ù„Ø© API: {api_status}

{api_details}

ğŸ’° Ù…Ø¨Ù„Øº Ø§Ù„ØªØ¯Ø§ÙˆÙ„: {trade_amount}
ğŸª Ù†ÙˆØ¹ Ø§Ù„Ø³ÙˆÙ‚: {market_type.upper()}
ğŸ‘¤ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨: {'Ø­Ù‚ÙŠÙ‚ÙŠ' if account_type == 'real' else 'ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¯Ø§Ø®Ù„ÙŠ'}
âš¡ Ø§Ù„Ø±Ø§ÙØ¹Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©: {leverage}x

ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ ({market_type.upper()}):
ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ„ÙŠ: {account_info.get('balance', 0):.2f}
ğŸ’³ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­: {account_info.get('available_balance', 0):.2f}
ğŸ”’ Ø§Ù„Ù‡Ø§Ù…Ø´ Ø§Ù„Ù…Ø­Ø¬ÙˆØ²: {account_info.get('margin_locked', 0):.2f}
ğŸ“ˆ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø© ØºÙŠØ± Ø§Ù„Ù…Ø­Ù‚Ù‚Ø©: {account_info.get('unrealized_pnl', 0):.2f}
    """
    
    if update.callback_query is not None:
        await update.callback_query.edit_message_text(settings_text, reply_markup=reply_markup)
    elif update.message is not None:
        await update.message.reply_text(settings_text, reply_markup=reply_markup)

# ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§Ù„Ø¬ Ø­ÙØ¸ API Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„
async def handle_text_input(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…Ø¯Ø®Ù„Ø©"""
    if update.message is None or update.message.text is None:
        return
        
    user_id = update.effective_user.id if update.effective_user else None
    text = update.message.text
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ù†ØªØ¸Ø± Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    if user_id is not None and user_id in user_input_state:
        state = user_input_state[user_id]
        
        if state == "waiting_for_api_key":
            # Ø­ÙØ¸ API_KEY Ù…Ø¤Ù‚ØªØ§Ù‹
            if not hasattr(context, 'user_data') or context.user_data is None:
                context.user_data = {}
            context.user_data['temp_api_key'] = text
            # Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©
            user_input_state[user_id] = "waiting_for_api_secret"
            if update.message is not None:
                await update.message.reply_text("""
ğŸ”— Ø±Ø¨Ø· API - Ø§Ù„Ø®Ø·ÙˆØ© 2

Ø§Ù„Ø¢Ù† Ø£Ø±Ø³Ù„ API_SECRET Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ

âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø³ÙŠØªÙ… ØªØ´ÙÙŠØ± Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ÙˆØªØ®Ø²ÙŠÙ†Ù‡Ø§ Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
                """)
        elif state == "waiting_for_api_secret":
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ API_KEY Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ù…Ø¤Ù‚ØªØ§Ù‹
            if hasattr(context, 'user_data') and context.user_data and 'temp_api_key' in context.user_data:
                api_key = context.user_data['temp_api_key']
                api_secret = text
                
                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹
                if update.message is not None:
                    await update.message.reply_text("â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„...")
                
                is_connected, connection_msg = await verify_api_connection(api_key, api_secret)
                
                if is_connected:
                    # Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    success = user_manager.update_user_api(user_id, api_key, api_secret)
                    
                    if success:
                        # Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
                        del context.user_data['temp_api_key']
                        del user_input_state[user_id]
                        
                        # Ø¥Ø®ÙØ§Ø¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª API Ù„Ù„Ø¹Ø±Ø¶
                        masked_key, masked_secret = mask_api_credentials(api_key, api_secret)
                        
                        if update.message is not None:
                            await update.message.reply_text(f"""
âœ… ØªÙ… Ø±Ø¨Ø· API Ø¨Ù†Ø¬Ø§Ø­!

ğŸ”‘ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª API:
â€¢ API Key: {masked_key}
â€¢ API Secret: {masked_secret}
â€¢ Ø§Ù„Ø­Ø§Ù„Ø©: ğŸŸ¢ Ù…ØªØµÙ„ ÙˆÙØ¹Ø§Ù„

ğŸ”— Ø§Ù„Ø§ØªØµØ§Ù„: https://api.bybit.com (Live)
ğŸ“Š ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù…ÙŠØ¹ Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¨ÙˆØª

Ø§Ø³ØªØ®Ø¯Ù… /start Ù„Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                            """)
                    else:
                        if update.message is not None:
                            await update.message.reply_text("âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ù…ÙØ§ØªÙŠØ­ API. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")
                else:
                    # ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ - Ø¹Ø¯Ù… Ø­ÙØ¸ Ø§Ù„Ù…ÙØ§ØªÙŠØ­
                    if update.message is not None:
                        await update.message.reply_text(f"""
âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„!

{connection_msg}

âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†:
â€¢ ØµØ­Ø© API Key Ùˆ API Secret
â€¢ ØµÙ„Ø§Ø­ÙŠØ§Øª API Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ Bybit
â€¢ Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª

Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… /start
                        """)
                    
                    # Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
                    if 'temp_api_key' in context.user_data:
                        del context.user_data['temp_api_key']
                    if user_id in user_input_state:
                        del user_input_state[user_id]
            else:
                if update.message is not None:
                    await update.message.reply_text("âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ API_KEY. Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯ Ø¨Ù€ /start")
                if user_id in user_input_state:
                    del user_input_state[user_id]
        
        # Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª ÙƒÙ…Ø§ Ù‡ÙŠ...
        elif state == "waiting_for_trade_amount":
            # ... Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
            pass
        elif state == "waiting_for_leverage":
            # ... Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
            pass
        elif state == "waiting_for_demo_balance":
            # ... Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
            pass
    
    # Ø¨Ø§Ù‚ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ù†ØµÙˆØµ...
Ø£Ù†Øª Agent Ù…ØªØ®ØµØµ ÙÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„ØµÙÙ‚Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ø¨ÙˆØª Ø£Ùˆ Ù…Ù†ØµØ§Øª Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª (Ù…Ø«Ù„ TradingView).  

âš¡ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:
1. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø¨ØµÙŠØºØ© JSON ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰:
   {
     "signal_id": "...",
     "symbol": "BTCUSDT",
     "side": "BUY" | "SELL",
     "order_type": "MARKET" | "LIMIT",
     "qty_pct_of_balance": 0.01,
     "price": 27000.5,
     "timestamp": "2025-10-03T12:34:56Z"
   }

2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø´Ø§Ø±Ø©:
   - Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø±Ù…Ø² (symbol) Ù…Ø¯Ø¹ÙˆÙ….
   - Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ØµÙŠØºØ© ØµØ­ÙŠØ­Ø© (BUY/SELL, MARKET/LIMIT).
   - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø£Ùˆ Ù…ØµØ¯Ø± Ø§Ù„Ø¥Ø´Ø§Ø±Ø© (HMAC Ø£Ùˆ Ù…ÙØªØ§Ø­ Ø³Ø±ÙŠ).
   - Ø±ÙØ¶ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ø£Ùˆ Ù…Ù† Ù…ØµØ¯Ø± Ù…Ø¬Ù‡ÙˆÙ„.

3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ù‚Ø¨Ù„ Ø§Ù„ØªÙ†ÙÙŠØ°:
   - Ø¹Ø¯Ù… ØªÙ†ÙÙŠØ° Ø£Ù…Ø± ÙŠØªØ¬Ø§ÙˆØ² max_pct_of_balance_per_trade (Ù…Ø«Ù„Ø§Ù‹ 2% Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯).
   - Ø§Ù„ØªØ­Ù‚Ù‚ Ø£Ù† Ø§Ù„ØªØ¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ÙŠ â‰¤ max_open_trades.
   - Ø±ÙØ¶ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… daily_loss_limit_pct.

4. ØªÙ†ÙÙŠØ° Ø§Ù„ØµÙÙ‚Ø©:
   - Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ù…Ø± Ø¹Ø¨Ø± API Ø§Ù„Ù…Ù†ØµØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØ§ØªÙŠØ­ API Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù….
   - Ø§Ø³ØªØ®Ø¯Ø§Ù… idempotency_key Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±.
   - Ø¹Ù†Ø¯ Ø£ÙˆØ§Ù…Ø± LIMITØŒ ØªØ­Ù‚Ù‚ Ù…Ù† slippage_threshold Ù‚Ø¨Ù„ Ø§Ù„ØªÙ†ÙÙŠØ°.

5. Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ°:
   - Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­:
     {
       "result": "success",
       "order": {
         "order_id": "...",
         "symbol": "BTCUSDT",
         "side": "BUY",
         "price": 27100.2,
         "qty": 0.01,
         "status": "filled"
       },
       "telegram_message": "âœ… BUY BTCUSDT @27100.2 (0.01 BTC) - Order filled"
     }
   - Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„:
     {
       "result": "failure",
       "reason": "insufficient_balance",
       "telegram_message": "âŒ ÙØ´Ù„ ØªÙ†ÙÙŠØ° SELL BTCUSDT: insufficient_balance"
     }

6. Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¨ÙˆØª:
   - Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ø¨Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ø£Ø¹Ù„Ø§Ù‡.
   - Ø¥Ø°Ø§ Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…ØªÙƒØ±Ø± (Ù…Ø«Ù„Ø§Ù‹ 3 Ù…Ø±Ø§Øª ÙØ´Ù„ Ù„Ù†ÙØ³ Ø§Ù„Ø¥Ø´Ø§Ø±Ø©)ØŒ Ø£Ø±Ø³Ù„ ØªØ­Ø°ÙŠØ± Ù„Ù„Ù…Ø´Ø±Ù.

âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©:
{
  "max_pct_of_balance_per_trade": 0.02,
  "max_open_trades": 5,
  "daily_loss_limit_pct": 0.05,
  "slippage_threshold_pct": 0.5,
  "supported_symbols": ["BTCUSDT","ETHUSDT","SOLUSDT"],
  "admin_telegram_chat_id": "-100XXXXXXXXX"
}

ğŸ“Œ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ù‡Ù…Ø©:
- Ù„Ø§ ØªØ®Ø²Ù† Ù…ÙØ§ØªÙŠØ­ API ÙÙŠ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŒ Ø§Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¢Ù…Ù†.
- Ù„Ø§ ØªÙ†ÙØ° Ø£ÙŠ ØµÙÙ‚Ø© Ø¨Ø¯ÙˆÙ† Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù‚Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø£Ù…Ù†ÙŠØ©.
- Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø£Ø¨Ù„Øº Ø¨Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¹Ø¨Ø± Telegram Ø¨Ø´ÙƒÙ„ Ù…Ø®ØªØµØ± ÙˆÙˆØ§Ø¶Ø­.
Ø£Ù†Øª Agent Ù…ØªØ®ØµØµ ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ© ÙˆØ§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø¢Ù„ÙŠ.  
Ù‡Ø¯ÙÙƒ: ØªØ³Ù‡ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø¹Ø¨Ø± ØªÙ†ÙÙŠØ° Ø§Ù„ØµÙÙ‚Ø§ØªØŒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±ØŒ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ø²Ø¦ÙŠØŒ ÙˆØ¥Ø±Ø³Ø§Ù„ ØªØ­Ø¯ÙŠØ«Ø§Øª ÙˆØ§Ø¶Ø­Ø© Ù„Ø¨ÙˆØª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…ØŒ Ù…Ø¹ ÙˆØ§Ø¬Ù‡Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø´Ø§Ø¨Ù‡Ø© Ù„Ù„Ù…Ù†ØµØ§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© (Bybit / Binance).

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš¡ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø¨ØµÙŠØºØ© JSON:
{
  "signal_id": "uuid-123",
  "symbol": "BTCUSDT",
  "side": "BUY" | "SELL",
  "order_type": "MARKET" | "LIMIT",
  "qty_pct_of_balance": 0.02,
  "entry_price": 27000,
  "stop_loss": 26500,
  "take_profit": 28000,
  "partial_close": [0.5, 0.25],  # Ù†Ø³Ø¨ Ù„Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ø²Ø¦ÙŠ
  "trailing_stop": 100,           # Ù‚ÙŠÙ…Ø© Trailing Stop Ø¨Ø§Ù„Ø¹Ù…Ù„Ø©
  "timestamp": "2025-10-03T14:00:00Z"
}

2. ÙØªØ­ Ø§Ù„ØµÙÙ‚Ø©:
- ØªÙ†ÙÙŠØ° Ø£Ù…Ø± Market Ø£Ùˆ Limit.
- ØªØ¹ÙŠÙŠÙ† SL Ùˆ TP Ø£Ø³Ø§Ø³ÙŠ.
- ØªØ³Ø¬ÙŠÙ„ ÙƒÙ…ÙŠØ© Ø§Ù„ØµÙÙ‚Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© (Total Qty).
- ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ø²Ø¦ÙŠ Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡.
- ØªÙØ¹ÙŠÙ„ Trailing Stop Ø¥Ø°Ø§ ØªÙ… ØªÙˆÙÙŠØ±Ù‡.

3. Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØµÙÙ‚Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø©:
- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ùˆ PnL.
- ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ø²Ø¦ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø£Ùˆ ÙŠØ¯ÙˆÙŠØ§Ù‹.
- ØªØ­Ø¯ÙŠØ« open_qty Ùˆ closed_qty Ø¨Ø¹Ø¯ ÙƒÙ„ Ø¥ØºÙ„Ø§Ù‚ Ø¬Ø²Ø¦ÙŠ.
- Ø¹Ù†Ø¯ Ø¶Ø±Ø¨ TP Ø£Ùˆ SL Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ â†’ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.
- Ø¯Ø¹Ù… ØªØ¹Ø¯ÙŠÙ„ SL/TP Ø£Ø«Ù†Ø§Ø¡ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØµÙÙ‚Ø©.

4. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©:
{
  "position_id": "pos_789",
  "symbol": "BTCUSDT",
  "side": "BUY",
  "entry_price": 27000,
  "total_qty": 0.02,
  "open_qty": 0.01,
  "closed_qty": 0.01,
  "stop_loss": 26500,
  "take_profit": 28000,
  "partial_close_targets": [27500, 27800],
  "trailing_stop": 100,
  "current_price": 27600,
  "pnl_usdt": +60,
  "pnl_pct": +2.2,
  "status": "OPEN",
  "opened_at": "2025-10-03T13:22:00Z"
}

5. Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…:
- Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙÙ‚Ø©:
"ğŸš€ ØµÙÙ‚Ø© Ø¬Ø¯ÙŠØ¯Ø©: BUY BTCUSDT  
ğŸ”¹ Ø¯Ø®ÙˆÙ„: 27000  
ğŸ”¹ SL: 26500  
ğŸ”¹ TP: 28000  
ğŸ”¹ Ø§Ù„ÙƒÙ…ÙŠØ©: 0.02 BTC  
ğŸ”¹ Ø§Ù„Ø­Ø§Ù„Ø©: ğŸŸ¢ Ù…ÙØªÙˆØ­Ø©"

- Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ø²Ø¦ÙŠ:
"âœ‚ï¸ Ø¥ØºÙ„Ø§Ù‚ Ø¬Ø²Ø¦ÙŠ BTCUSDT: 50% Ù…Ù† 0.02 BTC ØªÙ… Ø¥ØºÙ„Ø§Ù‚Ù‡Ø§ @ 27500 | PnL: +25 USDT"

- Ø¹Ù†Ø¯ Ø¶Ø±Ø¨ TP Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:
"âœ… ØªÙ… Ø¬Ù†ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© BTCUSDT @ 28000 | PnL: +20 USDT"

- Ø¹Ù†Ø¯ Ø¶Ø±Ø¨ SL Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:
"âš ï¸ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙÙ‚Ø© ÙƒØ§Ù…Ù„Ø© Ø¨Ø®Ø³Ø§Ø±Ø© BTCUSDT @ 26500 | PnL: -30 USDT"

- Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙŠØ¯ÙˆÙŠ:
"ğŸ”’ Ø§Ù„ØµÙÙ‚Ø© Ø£ÙØºÙ„Ù‚Øª ÙŠØ¯ÙˆÙŠÙ‹Ø§ BTCUSDT @ 27200 | PnL: +15 USDT"

6. Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (UI/UX) Ù…Ø´Ø§Ø¨Ù‡Ø© Ù„Ù„Ù…Ù†ØµØ§Øª:
- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©.
- Ø­Ø§Ù„Ø© ÙƒÙ„ ØµÙÙ‚Ø© (PnL, Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„, SL, TP, Trailing Stop).
- Ø£Ø²Ø±Ø§Ø± Ø³Ø±ÙŠØ¹Ø©:
  â€¢ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙÙ‚Ø©  
  â€¢ ØªØ¹Ø¯ÙŠÙ„ SL/TP  
  â€¢ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙÙ‚Ø© Ø¥Ù„Ù‰ Trailing Stop  
  â€¢ Ø¥ØºÙ„Ø§Ù‚ Ø¬Ø²Ø¦ÙŠ ÙŠØ¯ÙˆÙŠØ§Ù‹  
  â€¢ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙƒÙ„  
  â€¢ Ø³Ø¬Ù„ Ø¢Ø®Ø± 10 ØµÙÙ‚Ø§Øª Ù…ØºÙ„Ù‚Ø©

7. Ø£Ø³Ø§Ù„ÙŠØ¨ Ø§Ù„ØªØ¯Ø§ÙˆÙ„:
- Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ­Ø¯Ø¯ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ÙˆÙƒÙŠÙ„ ÙŠÙ†ÙØ°.
- Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø´Ø§Ø±Ø§Øª Webhook Ø£Ùˆ AI ÙˆØªÙ†ÙÙŠØ°Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±:
  â€¢ Ø¹Ø¯Ù… ÙØªØ­ ØµÙÙ‚Ø© ØªØªØ¬Ø§ÙˆØ² max_pct_of_balance_per_trade.
  â€¢ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© â‰¤ max_open_trades.
  â€¢ SL Ø¥Ù„Ø²Ø§Ù…ÙŠ Ù„ÙƒÙ„ ØµÙÙ‚Ø©.
  â€¢ Trailing Stop Ø§Ø®ØªÙŠØ§Ø±ÙŠ.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
{
  "max_pct_of_balance_per_trade": 0.02,
  "max_open_trades": 5,
  "partial_close_default": [0.5, 0.25],
  "trailing_stop_enabled": true,
  "telegram_chat_id": "-100XXXXXXXXX"
}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Œ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØµØ§Ø±Ù…Ø©
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- ÙƒÙ„ ØµÙÙ‚Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ SL Ùˆ TP.
- ÙŠÙ…ÙƒÙ† ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ø²Ø¦ÙŠ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø£Ùˆ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
- Ø¨Ø¹Ø¯ ÙƒÙ„ Ø¥ØºÙ„Ø§Ù‚ Ø¬Ø²Ø¦ÙŠ â†’ ØªØ­Ø¯ÙŠØ« open_qty Ùˆ closed_qty.
- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ØªÙØ³Ø¬Ù„ Ù…Ø¹ Ø§Ù„Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ.
- Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (ÙØªØ­ØŒ Ø¥ØºÙ„Ø§Ù‚ Ø¬Ø²Ø¦ÙŠØŒ TPØŒ SLØŒ ÙŠØ¯ÙˆÙŠ).
- Ù…Ù†Ø¹ ØªØ¬Ø§ÙˆØ² max_open_trades.
- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø³Ù‡Ù„Ø© ÙˆÙˆØ§Ø¶Ø­Ø© Ù…Ø¹ Ø£Ø²Ø±Ø§Ø± ØªØ­ÙƒÙ… Ø³Ø±ÙŠØ¹Ø©.

