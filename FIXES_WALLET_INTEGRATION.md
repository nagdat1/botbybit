# ุฅุตูุงุญ ุชูุงูู ุงููุญูุธุฉ ูุงูุฅุบูุงู ุงูุฌุฒุฆู ๐ง

## ุงููุดููุฉ ุงูุฃุณุงุณูุฉ โ

ูุงูุช ุงููุดููุฉ ุงูุฑุฆูุณูุฉ ูู **ุนุฏู ุชุฑุงุจุท ุฃุฏูุงุช ุงููุดุฑูุน** ุนูุฏ ุฅุบูุงู ุงูุตููุงุช:

1. **ุงูุฅุบูุงู ุงูุฌุฒุฆู ูุง ููุญุฏูุซ ุงููุญูุธุฉ**: ุนูุฏ ุฅุบูุงู ุฌุฒุก ูู ุงูุตููุฉุ ูู ููู ุงููุจูุบ ูุฑุฌุน ูููุญูุธุฉ
2. **ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุง ุชูุญุฏูุซ**: ูู ูุชู ุชุณุฌูู ุงูุฅุบูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
3. **ุนุฏู ุชุฑุงุจุท ุจูู ุงูุฃูุธูุฉ**: ูุงู ููุงู ุงููุตุงู ุจูู:
   - `TradingAccount` (ุงูุญุณุงุจุงุช ุงูุชุฌุฑูุจูุฉ)
   - `position_manager.py` (ุงููุธุงู ุงููุธุฑู)
   - `database.py` (ุงูุชุฎุฒูู)

## ุงูุญููู ุงูููุทุจูุฉ โ

### 1. ุฅุถุงูุฉ ุฏูุงู ุงูุฅุบูุงู ุงูุฌุฒุฆู ูู `TradingAccount` ๐ฆ

**ุงูููู**: `bybit_trading_bot.py`

#### ุฃ) `partial_close_spot_position()`
```python
def partial_close_spot_position(self, position_id: str, percentage: float, closing_price: float):
    """ุฅุบูุงู ุฌุฒุฆู ูุตููุฉ ุณุจูุช"""
    # โ ุญุณุงุจ ุงููุจูุบ ุงูููุบูู
    close_amount = (current_amount * percentage) / 100
    close_contracts = close_amount / entry_price
    
    # โ ุญุณุงุจ ุงูุฑุจุญ/ุงูุฎุณุงุฑุฉ
    if side.lower() == "buy":
        self.balance += close_contracts * closing_price  # ๐ฐ ูุฑุฌุน ูููุญูุธุฉ
        pnl = close_contracts * closing_price - close_amount
    
    # โ ุชุญุฏูุซ ุงูุตููุฉ
    remaining_amount = current_amount - close_amount
    position['amount'] = remaining_amount
    
    return True, partial_record
```

**ูุง ุชู ุฅุตูุงุญู**:
- โ ุงูุฑุตูุฏ ููุญุฏูุซ ุชููุงุฆูุงู: `self.balance += ...`
- โ ุงููููุฉ ุงููุชุจููุฉ ุชูุญูุธ: `position['amount'] = remaining_amount`
- โ ุงูุฑุจุญ/ุงูุฎุณุงุฑุฉ ููุญุณุจ ุจุฏูุฉ

#### ุจ) `partial_close_futures_position()`
```python
def partial_close_futures_position(self, position_id: str, percentage: float, closing_price: float):
    """ุฅุบูุงู ุฌุฒุฆู ูุตููุฉ ูููุชุดุฑ"""
    # โ ุญุณุงุจ ุงููุงูุด ุงูููุบูู
    close_margin = (position.margin_amount * percentage) / 100
    
    # โ ุชุญุฏูุซ ุงูุฑุตูุฏ: ุฅุฑุฌุงุน ุงููุงูุด + ุงูุฑุจุญ/ุงูุฎุณุงุฑุฉ
    self.margin_locked -= close_margin  # ๐ ูู ุญุฌุฒ ุงููุงูุด
    self.balance += close_margin + pnl  # ๐ฐ ูุฑุฌุน ูููุญูุธุฉ
    
    # โ ุชุญุฏูุซ ุงูุตููุฉ
    position.contracts -= close_contracts
    position.margin_amount -= close_margin
    
    return True, partial_record
```

**ูุง ุชู ุฅุตูุงุญู**:
- โ ุงููุงูุด ุงููุญุฌูุฒ ูููู: `self.margin_locked -= close_margin`
- โ ุงููุจูุบ ูุฑุฌุน ูููุญูุธุฉ: `self.balance += close_margin + pnl`
- โ ุงูุนููุฏ ุงููุชุจููุฉ ุชูุญุฏูุซ

---

### 2. ุฑุจุท ุงูุฅุบูุงู ุงููุนูู ูุน ุงููุงุฌูุฉ ๐

**ุงูููู**: `bybit_trading_bot.py` - `execute_partial_close_percentage()`

```python
# โ ุชูููุฐ ุงูุฅุบูุงู ุงูุฌุฒุฆู ุงููุนูู
if market_type == 'futures':
    success, result = account.partial_close_futures_position(position_id, percentage, current_price)
else:
    success, result = account.partial_close_spot_position(position_id, percentage, current_price)

# โ ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช
db_success = db_manager.record_partial_close(
    order_id=position_id,
    percentage=percentage,
    closing_price=current_price,
    pnl=result.get('pnl', 0),
    remaining_quantity=remaining_quantity
)

# โ ุชุญุฏูุซ ุงููุนูููุงุช ูู ุงูุฐุงูุฑุฉ
if result['status'] == 'CLOSED':
    del trading_bot.open_positions[position_id]
else:
    # ุชุญุฏูุซ ุงููููุฉ ุงููุชุจููุฉ
    position_info['amount'] = result['remaining_amount']
```

**ูุง ุชู ุฅุตูุงุญู**:
- โ ุงูุฅุบูุงู ููููุฐ ูุนููุงู ุนูู ุงูุญุณุงุจ
- โ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุชูุญุฏูุซ
- โ ุงูุฐุงูุฑุฉ (open_positions) ุชูุญุฏูุซ

---

### 3. ุฅุถุงูุฉ ุฏูุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช ๐พ

**ุงูููู**: `database.py` - `DatabaseManager` class

#### ุฃ) `record_partial_close()`
```python
def record_partial_close(self, order_id: str, percentage: float, closing_price: float, 
                        pnl: float, remaining_quantity: float):
    """ุชุณุฌูู ุฅุบูุงู ุฌุฒุฆู ูุตููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช"""
    
    # โ ุฅุถุงูุฉ ุณุฌู ุฌุฏูุฏ ููุฅุบูุงูุงุช ุงูุฌุฒุฆูุฉ
    partial_closes.append({
        'percentage': percentage,
        'closing_price': closing_price,
        'pnl': pnl,
        'timestamp': datetime.now().isoformat()
    })
    
    # โ ุชุญุฏูุซ ุงูุญุงูุฉ
    status = 'CLOSED' if total_closed >= 100 else 'PARTIAL_CLOSED'
    
    # โ ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช
    cursor.execute("""
        UPDATE orders 
        SET current_quantity = ?,
            partial_closes = ?,
            realized_pnl = realized_pnl + ?,
            status = ?,
            notes = notes || ' | ุฅุบูุงู ุฌุฒุฆู...'
        WHERE order_id = ?
    """, (...))
```

**ูุง ุชู ุฅุตูุงุญู**:
- โ ุฌููุน ุงูุฅุบูุงูุงุช ุงูุฌุฒุฆูุฉ ุชูุณุฌู ุจุชูุตูู
- โ ุงููููุฉ ุงููุชุจููุฉ ุชูุญุฏูุซ: `current_quantity`
- โ ุงูุฑุจุญ/ุงูุฎุณุงุฑุฉ ุงููุญููุฉ ุชูุฌูุน: `realized_pnl + pnl`
- โ ุงูุญุงูุฉ ุชูุญุฏูุซ ุชููุงุฆูุงู: `PARTIAL_CLOSED` ุฃู `CLOSED`

#### ุจ) `close_order()`
```python
def close_order(self, order_id: str, closing_price: float, realized_pnl: float):
    """ุฅุบูุงู ุตููุฉ ูุชุญุฏูุซ ุญุงูุชูุง ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช"""
    
    cursor.execute("""
        UPDATE orders 
        SET status = 'CLOSED', 
            realized_pnl = ?, 
            close_time = CURRENT_TIMESTAMP,
            notes = notes || ' | ุฅุบูุงู ูุงูู...'
        WHERE order_id = ?
    """, (realized_pnl, closing_price, order_id))
```

**ูุง ุชู ุฅุตูุงุญู**:
- โ ุงูุฅุบูุงู ุงููุงูู ููุณุฌู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ููุช ุงูุฅุบูุงู ููุญูุธ: `close_time`
- โ ุงูุฑุจุญ/ุงูุฎุณุงุฑุฉ ุงูููุงุฆู ููุญูุธ

---

### 4. ุฑุจุท ุงูุฅุบูุงู ุงููุงูู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช ๐

**ุงูููู**: `bybit_trading_bot.py` - `close_position()`

```python
if success:
    trade_record = result
    
    # โ ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช
    if isinstance(trade_record, dict) and 'pnl' in trade_record:
        db_success = db_manager.close_order(
            order_id=position_id,
            closing_price=current_price,
            realized_pnl=trade_record['pnl']
        )
```

**ูุง ุชู ุฅุตูุงุญู**:
- โ ุงูุฅุบูุงู ุงููุงูู ููุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุฌููุน ุงูุจูุงูุงุช ุชูุญูุธ ุจุดูู ุฏุงุฆู

---

## ุณูุฑ ุงูุนูููุฉ ุงููุงูู ๐

### ูุซุงู: ุฅุบูุงู 50% ูู ุตููุฉ ุณุจูุช

```
ุงููุณุชุฎุฏู ูุถุบุท "ุฅุบูุงู ุฌุฒุฆู 50%"
         โ
manage_partial_close() โ ุนุฑุถ ุงููุงุฆูุฉ
         โ
execute_partial_close_percentage(50%)
         โ
account.partial_close_spot_position()
    โโโ ุญุณุงุจ ุงููุจูุบ: 50% ูู ุงูุตููุฉ
    โโโ ุญุณุงุจ PnL: (ุงูุณุนุฑ ุงูุญุงูู - ุณุนุฑ ุงูุฏุฎูู) ร ุงููููุฉ
    โโโ ุชุญุฏูุซ ุงููุญูุธุฉ: balance += ุงููุจูุบ + PnL โ
    โโโ ุชุญุฏูุซ ุงูุตููุฉ: amount = ุงููุชุจูู
         โ
db_manager.record_partial_close()
    โโโ ุญูุธ ุณุฌู ุงูุฅุบูุงู ูู partial_closes โ
    โโโ ุชุญุฏูุซ current_quantity โ
    โโโ ุชุญุฏูุซ realized_pnl โ
    โโโ ุชุญุฏูุซ status (PARTIAL_CLOSED ุฃู CLOSED)
         โ
ุชุญุฏูุซ open_positions ูู ุงูุฐุงูุฑุฉ
         โ
ุฅุฑุณุงู ุฑุณุงูุฉ ูููุณุชุฎุฏู:
    โโโ ุงููุณุจุฉ ุงูููุบููุฉ
    โโโ ุงูุฑุจุญ/ุงูุฎุณุงุฑุฉ
    โโโ ุงูุฑุตูุฏ ุงูุฌุฏูุฏ โ
    โโโ ุงููุชุจูู ูู ุงูุตููุฉ
```

---

## ุงูุชุญุณููุงุช ุงููุทุจูุฉ ๐

### 1. **ุงูุชุฑุงุจุท ุงููุงูู**
- โ ุงูุญุณุงุจุงุช (`TradingAccount`)
- โ ูุงุนุฏุฉ ุงูุจูุงูุงุช (`database.py`)
- โ ุงููุงุฌูุฉ (`bybit_trading_bot.py`)
- โ ุงูุฐุงูุฑุฉ (`open_positions`)

### 2. **ุฏูุฉ ุงูุญุณุงุจุงุช**
- โ ุงูุฑุจุญ/ุงูุฎุณุงุฑุฉ ููุญุณุจ ุจุฏูุฉ
- โ ุงููููุงุช ุชูุญุฏูุซ ุจุดูู ุตุญูุญ
- โ ุงููุญูุธุฉ ุชูุญุฏูุซ ููุฑุงู

### 3. **ุงูุญูุธ ุงูุฏุงุฆู**
- โ ุฌููุน ุงูุฅุบูุงูุงุช ุงูุฌุฒุฆูุฉ ุชูุณุฌู
- โ ุงูุชูุงุฑูุฎ ูุงูุฃููุงุช ุชูุญูุธ
- โ ุณุฌู ูุงูู ููู ุตููุฉ

### 4. **ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู**
- โ ุฑุณุงุฆู ูุงุถุญุฉ ุจุนุฏ ูู ุนูููุฉ
- โ ุนุฑุถ ุงูุฑุตูุฏ ุงูุฌุฏูุฏ ูุจุงุดุฑุฉ
- โ ูุนูููุงุช ููุตูุฉ ุนู ุงูุฅุบูุงู

---

## ุงููููุงุช ุงูููุนุฏูุฉ ๐

| ุงูููู | ุงูุชุนุฏููุงุช | ุงูุณุจุจ |
|------|----------|-------|
| `bybit_trading_bot.py` | โ ุฅุถุงูุฉ `partial_close_spot_position()`<br>โ ุฅุถุงูุฉ `partial_close_futures_position()`<br>โ ุฑุจุท `execute_partial_close_percentage()` ูุน ุงูุญุณุงุจุงุช<br>โ ุฑุจุท `close_position()` ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช | ุชูููุฐ ุงูุฅุบูุงู ุงููุนูู ูุชุญุฏูุซ ุงููุญูุธุฉ |
| `database.py` | โ ุฅุถุงูุฉ `record_partial_close()`<br>โ ุฅุถุงูุฉ `close_order()` | ุญูุธ ุฏุงุฆู ูุฌููุน ุงูุนูููุงุช |

---

## ุงูุงุฎุชุจุงุฑุงุช ุงูููุตู ุจูุง ๐งช

### 1. ุงุฎุชุจุงุฑ ุงูุฅุบูุงู ุงูุฌุฒุฆู - ุณุจูุช
```
1. ูุชุญ ุตููุฉ ุณุจูุช ุจูุจูุบ 100 USDT
2. ุฅุบูุงู 25%
   โ ุงููุชููุน: ุงูุฑุตูุฏ += 25 + PnL
   โ ุงููุชููุน: ุงููุชุจูู = 75 USDT
3. ุฅุบูุงู 50% ูู ุงููุชุจูู
   โ ุงููุชููุน: ุงูุฑุตูุฏ += 37.5 + PnL
   โ ุงููุชููุน: ุงููุชุจูู = 37.5 USDT
```

### 2. ุงุฎุชุจุงุฑ ุงูุฅุบูุงู ุงูุฌุฒุฆู - ูููุชุดุฑ
```
1. ูุชุญ ุตููุฉ ูููุชุดุฑ ุจูุงูุด 100 USDT ูุฑุงูุนุฉ 10x
2. ุฅุบูุงู 50%
   โ ุงููุชููุน: margin_locked -= 50
   โ ุงููุชููุน: balance += 50 + PnL
   โ ุงููุชููุน: contracts ุชูุญุฏูุซ
```

### 3. ุงุฎุชุจุงุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช
```
1. ุฅุบูุงู ุฌุฒุฆู 30%
2. ุงูุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:
   โ current_quantity ูุญุฏูุซุฉ
   โ partial_closes ูุญุชูู ุนูู ุงูุณุฌู
   โ realized_pnl ูุญุฏูุซ
   โ status = 'PARTIAL_CLOSED'
```

---

## ุงููุชูุฌุฉ ุงูููุงุฆูุฉ ๐ฏ

### ูุจู ุงูุฅุตูุงุญ โ
```
ุฅุบูุงู ุฌุฒุฆู โ ูุง ููุญุฏูุซ ุงููุญูุธุฉ
ุฅุบูุงู ูุงูู โ ูุง ููุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช
ุนุฏู ุชุฑุงุจุท ุจูู ุงูุฃูุธูุฉ
```

### ุจุนุฏ ุงูุฅุตูุงุญ โ
```
ุฅุบูุงู ุฌุฒุฆู โ ๐ฐ ุชุญุฏูุซ ุงููุญูุธุฉ ููุฑุงู
              โ ๐พ ุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
              โ ๐ ุชุญุฏูุซ ุงูุตููุฉ
              โ ๐ฑ ุฑุณุงูุฉ ูุงุถุญุฉ ูููุณุชุฎุฏู

ุฅุบูุงู ูุงูู  โ ๐ฐ ุชุญุฏูุซ ุงููุญูุธุฉ ููุฑุงู
              โ ๐พ ุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
              โ ๐ ุญุฐู ูู ุงูุฐุงูุฑุฉ
              โ ๐ฑ ุฑุณุงูุฉ ููุตูุฉ
```

---

## ูุจุงุฏุฆ ุงูุชุตููู ุงูููุชุจุนุฉ ๐๏ธ

1. **ุงูุชุฑุงุจุท ุงููุงูู**: ูู ุฌุฒุก ูู ุงููุธุงู ูุชูุงุตู ูุน ุงูุขุฎุฑ
2. **ุงูุฏูุฉ**: ุงูุญุณุงุจุงุช ุงููุงููุฉ ุฏูููุฉ ูููุญุฏูุซุฉ
3. **ุงูุญูุธ ุงูุฏุงุฆู**: ูู ุนูููุฉ ุชูุณุฌู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
4. **ุนุฒู ุงููุณุชุฎุฏููู**: ูู ูุณุชุฎุฏู ูู ุจูุฆุชู ุงูุฎุงุตุฉ
5. **ุงููุถูุญ**: ุฑุณุงุฆู ูุงุถุญุฉ ูููุตูุฉ

---

## ููุงุญุธุงุช ูุงูุฉ โ๏ธ

1. **ุงูุชูุงูู ูุน ุงูุฅุตุฏุงุฑุงุช ุงููุฏููุฉ**: ุงููุธุงู ูุฏุนู ูุฑุงุกุฉ ุงูุจูุงูุงุช ุงููุฏููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
2. **ุงูุฃูุงู**: ุฌููุน ุงูุนูููุงุช ุชูุณุฌู ูุน ุงูุชุงุฑูุฎ ูุงูููุช
3. **ุงููุฑููุฉ**: ูููู ุฅุถุงูุฉ ูุณุจ ูุฎุตุตุฉ ููุฅุบูุงู ุงูุฌุฒุฆู
4. **ุงูุฃุฏุงุก**: ุฌููุน ุงูุนูููุงุช ุชุชู ุจุดูู ุบูุฑ ูุชุฒุงูู (async)

---

## ุงูุฎูุงุตุฉ ๐

ุชู ุฅุตูุงุญ **ุงูุชุฑุงุจุท ุงููุงูู** ุจูู ุฌููุน ุฃุฏูุงุช ุงููุดุฑูุน:
- โ ุงูุญุณุงุจุงุช ุชูุญุฏูุซ ุงููุญูุธุฉ ููุฑุงู
- โ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุชูุญูุธ ูู ุดูุก
- โ ุงููุงุฌูุฉ ุชุนุฑุถ ุงููุนูููุงุช ุงูุตุญูุญุฉ
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุณูุณุฉ ููุซู ููุตุงุช ุงูุชุฏุงูู ุงูุญููููุฉ

**ุงูุขู ุงูุจูุช ูุนูู ุจุดูู ูุชูุงูู ููุชุฑุงุจุท! ๐**
