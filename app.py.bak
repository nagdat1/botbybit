#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ØªØ·Ø¨ÙŠÙ‚ Flask Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ø¨ÙˆØª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø¹Ù„Ù‰ Railway
"""

import os
import sys
import asyncio
import logging
from datetime import datetime
from flask import Flask, jsonify, request
from telegram import Update
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    filters
)

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)# Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³Ø§Ø± webhook Ù„Ù„Ù€ Telegram
@app.route('/telegram', methods=['POST'])
def telegram_webhook():
    """Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ­Ø¯ÙŠØ«Ø§Øª Telegram webhook"""
    if request.method == 'POST':
        update = Update.de_json(request.get_json(force=True), bot.bot)
        bot.process_update(update)
        return 'OK'

if __name__ == "__main__":
    try:
        # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†ÙØ° Ù…Ù† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
        port = int(os.environ.get("PORT", 8080))
        
        # Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª
        asyncio.run(start_bot())
        
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: {e}")
        import traceback
        traceback.print_exc()ort Flask, render_template, jsonify, request

# Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø±Ø§Øª Python
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
from bybit_trading_bot import trading_bot
from web_server import WebServer

# Ø¥Ù†Ø´Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ Flask
app = Flask(__name__)

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
app.config['SECRET_KEY'] = 'trading_bot_secret_key_2024'

# Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
web_server = None
bot_thread = None

@app.route('/')
def index():
    """Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    return jsonify({
        "status": "running",
        "message": "Ø¨ÙˆØª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø¹Ù„Ù‰ Bybit ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­",
        "timestamp": datetime.now().isoformat(),
        "version": "1.0.0"
    })

@app.route('/health')
def health_check():
    """ÙØ­Øµ ØµØ­Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"""
    return jsonify({
        "status": "healthy",
        "timestamp": datetime.now().isoformat()
    })

@app.route('/webhook', methods=['POST'])
def webhook():
    """Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø´Ø§Ø±Ø§Øª TradingView"""
    try:
        data = request.get_json()
        
        if not data:
            return jsonify({"status": "error", "message": "No data received"}), 400
        
        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø´Ø§Ø±Ø© ÙÙŠ thread Ù…Ù†ÙØµÙ„
        def process_signal_async():
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            loop.run_until_complete(trading_bot.process_signal(data))
            loop.close()
        
        threading.Thread(target=process_signal_async, daemon=True).start()
        
        return jsonify({"status": "success", "message": "Signal processed"}), 200
        
    except Exception as e:
        return jsonify({"status": "error", "message": str(e)}), 500

def start_bot():
    """Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª"""
    global bot_thread

    async def run_bot_async():
        """ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø¨Ø´ÙƒÙ„ ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†"""
        try:
            # Ø¥Ø¹Ø¯Ø§Ø¯ Telegram bot
            from telegram.ext import Application
            from bybit_trading_bot import (
                start, settings_menu, account_status, open_positions,
                trade_history, wallet_overview, handle_callback, 
                handle_text_input, error_handler, TELEGRAM_TOKEN
            )
            
            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆÙŠØ¨ Ù‡ÙˆÙƒ Ù…Ù† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
            WEBHOOK_URL = os.environ.get('WEBHOOK_URL', f"https://{os.environ.get('RAILWAY_STATIC_URL')}")
            if not WEBHOOK_URL:
                raise ValueError("WEBHOOK_URL environment variable is not set")
            
            # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¹ Ø§Ù„ÙˆÙŠØ¨ Ù‡ÙˆÙƒ
            application = (
                Application.builder()
                .token(TELEGRAM_TOKEN)
                .webhook(
                    webhook_url=f"{WEBHOOK_URL}/telegram",
                    allowed_updates=['message', 'callback_query']
                )
                .build()
            )
            
            # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª
            from telegram.ext import CommandHandler, MessageHandler, CallbackQueryHandler, filters
            application.add_handler(CommandHandler("start", start))
            application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text_input))
            application.add_handler(CallbackQueryHandler(handle_callback))
            application.add_error_handler(error_handler)
            
            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
            await trading_bot.update_available_pairs()
            
            # Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±ÙŠ Ù„Ù„Ø£Ø³Ø¹Ø§Ø±
            async def price_update_loop():
                while True:
                    try:
                        await trading_bot.update_open_positions_prices()
                        await asyncio.sleep(30)
                    except Exception as e:
                        print(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±ÙŠ: {e}")
                        await asyncio.sleep(60)
            
            # ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±ÙŠ ÙÙŠ Ù…Ù‡Ù…Ø© Ù…Ù†ÙØµÙ„Ø©
            asyncio.create_task(price_update_loop())
            
            print("ğŸ¤– Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ÙˆÙŠØ¨ Ù‡ÙˆÙƒ...")
            
            # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ù…Ø¹ Ø§Ù„ÙˆÙŠØ¨ Ù‡ÙˆÙƒ
            async with application:
                await application.start()
                print(f"âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆÙŠØ¨ Ù‡ÙˆÙƒ Ø¹Ù„Ù‰: {WEBHOOK_URL}/telegram")
                await application.updater.start_webhook(
                    listen="0.0.0.0",
                    port=int(os.environ.get("PORT", 8080)),
                    webhook_url=f"{WEBHOOK_URL}/telegram"
                )
                await application.updater.bot.set_webhook(
                    url=f"{WEBHOOK_URL}/telegram"
                )
                await application.idle()
                
        except Exception as e:
            print(f"Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª: {e}")
            import traceback
            traceback.print_exc()
            raise
    
# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ÙÙŠ thread Ù…Ù†ÙØµÙ„
async def init_bot():
    await start_bot()

bot_thread = threading.Thread(target=lambda: asyncio.run(init_bot()), daemon=True)
bot_thread.start()
print("âœ… ØªÙ… Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ÙÙŠ thread Ù…Ù†ÙØµÙ„")def start_web_server():
    """Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„ÙˆÙŠØ¨"""
    global web_server
    
    try:
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙˆØ±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ø¨ÙˆØª
        web_server = WebServer(trading_bot)
        trading_bot.web_server = web_server
        
        # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙÙŠ thread Ù…Ù†ÙØµÙ„ Ø¹Ù„Ù‰ Ù…Ù†ÙØ° Ù…Ø®ØªÙ„Ù
        server_thread = threading.Thread(
            target=lambda: web_server.run(debug=False, port=int(os.environ.get('WEBHOOK_PORT', 5000))), 
            daemon=True
        )
        server_thread.start()
        
        print("âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„ÙˆÙŠØ¨ Ø¨Ù†Ø¬Ø§Ø­")
        
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„ÙˆÙŠØ¨: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    print("ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø¹Ù„Ù‰ Render...")
    print(f"â° Ø§Ù„ÙˆÙ‚Øª: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    
    # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†Ø§ÙØ°
    flask_port = int(os.environ.get('PORT', 8080))  # Ù…Ù†ÙØ° ØªØ·Ø¨ÙŠÙ‚ Flask Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    webhook_port = int(os.environ.get('WEBHOOK_PORT', 5000))  # Ù…Ù†ÙØ° Ø³ÙŠØ±ÙØ± Ø§Ù„ÙˆÙŠØ¨ Ù‡ÙˆÙƒ
    
    # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù†ÙØ°ÙŠÙ† Ù…Ø®ØªÙ„ÙÙŠÙ†
    if flask_port == webhook_port:
        webhook_port = flask_port + 1
    
    os.environ['WEBHOOK_PORT'] = str(webhook_port)
    
    try:
        # Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª
        bot_thread = threading.Thread(target=start_bot, daemon=True)
        bot_thread.start()
        print("âœ… ØªÙ… Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ÙÙŠ thread Ù…Ù†ÙØµÙ„")
        
        # Ø¨Ø¯Ø¡ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„ÙˆÙŠØ¨
        start_web_server()
        
        # Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø­Ø¸Ø© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ø¯Ø¡ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª
        import time
        time.sleep(2)
        
        # ØªØ´ØºÙŠÙ„ ØªØ·Ø¨ÙŠÙ‚ Flask
        app.run(host='0.0.0.0', port=flask_port, debug=False, use_reloader=False)
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: {e}")
        import traceback
        traceback.print_exc()