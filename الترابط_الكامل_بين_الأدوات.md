# ุงูุชุฑุงุจุท ุงููุงูู ุจูู ุฃุฏูุงุช ุงููุดุฑูุน ๐

## ุงููุดุงูู ุงูุชู ูุงูุช ููุฌูุฏุฉ โ

### 1. **ุงููุตุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุนู ุงูุตููุงุช**
```
โ ูุชุญ ุตููุฉ โ ุชูุญูุธ ูู ุงูุฐุงูุฑุฉ ููุท (open_positions)
โ ูุชุญ ุตููุฉ โ ูุง ุชูุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
โ ุนูุฏ ุฅุนุงุฏุฉ ุชุดุบูู ุงูุจูุช โ ุชุถูุน ุฌููุน ุงูุตููุงุช
```

### 2. **ุงููุตุงู ุงููุญูุธุฉ ุนู ุงูุฅุบูุงู**
```
โ ุฅุบูุงู ุฌุฒุฆู โ ูุง ููุญุฏูุซ ุงููุญูุธุฉ
โ ุฅุบูุงู ุฌุฒุฆู โ ูุง ููุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
โ ุงูุฑุตูุฏ โ ูุง ููุญุฏูุซ ุจุนุฏ ุงูุฅุบูุงู
```

### 3. **ุงููุตุงู user_manager ุนู ุงูุจูุช**
```
โ ุงูุจูุช ููุชุญ ุตููุงุช ูุจุงุดุฑุฉ ุจุฏูู user_manager
โ user_manager ูุง ูุญูุธ ุงูุญููู ุงูุฌุฏูุฏุฉ
โ ูุง ููุฌุฏ ุชุฒุงูู ุจูู ุงูุฐุงูุฑุฉ ููุงุนุฏุฉ ุงูุจูุงูุงุช
```

---

## ุงูุญููู ุงูููุทุจูุฉ โ

### 1๏ธโฃ **ุฑุจุท ูุชุญ ุงูุตููุงุช ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช**

#### ูู `execute_demo_trade()` - ุงููููุชุดุฑ:
```python
# ุจุนุฏ ูุชุญ ุงูุตููุฉ ูู ุงูุญุณุงุจ
if success:
    position_id = result
    
    # โ ุญูุธ ูู ุงูุฐุงูุฑุฉ
    self.open_positions[position_id] = {...}
    
    # โ ุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุน ุฌููุน ุงูุญููู
    order_data = {
        'order_id': position_id,
        'user_id': ADMIN_USER_ID,
        'symbol': symbol,
        'side': action,
        'entry_price': price,
        'quantity': margin_amount,
        'initial_quantity': margin_amount,
        'current_quantity': margin_amount,
        'take_profits': [],
        'stop_loss': None,
        'partial_closes': [],
        'status': 'OPEN',
        'market_type': 'futures',
        'leverage': leverage,
        'unrealized_pnl': 0.0,
        'realized_pnl': 0.0,
        'notes': f'ุตููุฉ ูููุชุดุฑ...'
    }
    db_manager.create_order(order_data)  # โ ุญูุธ ุฏุงุฆู
```

#### ูู `execute_demo_trade()` - ุงูุณุจูุช:
```python
# ููุณ ุงูุขููุฉ ููุณุจูุช
order_data = {
    'order_id': position_id,
    'user_id': ADMIN_USER_ID,
    'symbol': symbol,
    'side': action,
    'entry_price': price,
    'quantity': amount,
    'initial_quantity': amount,
    'current_quantity': amount,
    'market_type': 'spot',
    'leverage': 1,
    # ... ุจุงูู ุงูุญููู
}
db_manager.create_order(order_data)
```

**ุงููุชูุฌุฉ:**
- โ ูู ุตููุฉ ุชููุชุญ โ ุชูุญูุธ ููุฑุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุฌููุน ุงูุญููู ุงูุฌุฏูุฏุฉ ูุญููุธุฉ
- โ ูุง ุชุถูุน ุงูุตููุงุช ุนูุฏ ุฅุนุงุฏุฉ ุงูุชุดุบูู

---

### 2๏ธโฃ **ุฑุจุท ุงูุฅุบูุงู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงูุฑุตูุฏ**

#### ุงูุฅุบูุงู ุงููุงูู ูู `close_position()`:
```python
# ุจุนุฏ ุฅุบูุงู ุงูุตููุฉ ูู ุงูุญุณุงุจ
if success:
    trade_record = result
    
    # โ 1. ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช
    db_manager.close_order(
        order_id=position_id,
        closing_price=current_price,
        realized_pnl=trade_record['pnl']
    )
    
    # โ 2. ุชุญุฏูุซ ุฑุตูุฏ ุงููุณุชุฎุฏู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    db_manager.update_user_balance(ADMIN_USER_ID, account.balance)
    
    # โ 3. ุงููุญูุธุฉ ููุญุฏูุซุฉ ุชููุงุฆูุงู ูู TradingAccount
```

#### ุงูุฅุบูุงู ุงูุฌุฒุฆู ูู `execute_partial_close_percentage()`:
```python
# ุจุนุฏ ุงูุฅุบูุงู ุงูุฌุฒุฆู
success, result = account.partial_close_xxx_position(...)

if success:
    # โ 1. ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช
    db_manager.record_partial_close(
        order_id=position_id,
        percentage=percentage,
        closing_price=current_price,
        pnl=result['pnl'],
        remaining_quantity=remaining_quantity
    )
    
    # โ 2. ุชุญุฏูุซ ุฑุตูุฏ ุงููุณุชุฎุฏู
    db_manager.update_user_balance(ADMIN_USER_ID, account.balance)
    
    # โ 3. ุงููุญูุธุฉ ููุญุฏูุซุฉ ุชููุงุฆูุงู
```

**ุงููุชูุฌุฉ:**
- โ ุงูุฅุบูุงู ุงููุงูู โ ููุญุฏูุซ ุงููุญูุธุฉ + ูุงุนุฏุฉ ุงูุจูุงูุงุช + ุงูุฑุตูุฏ
- โ ุงูุฅุบูุงู ุงูุฌุฒุฆู โ ููุญุฏูุซ ุงููุญูุธุฉ + ูุงุนุฏุฉ ุงูุจูุงูุงุช + ุงูุฑุตูุฏ
- โ ุงูุฑุตูุฏ ูุญููุธ ููุฒุงูู ุฏุงุฆูุงู

---

### 3๏ธโฃ **ุชุญููู ุงูุจูุงูุงุช ุนูุฏ ุจุฏุก ุงูุจูุช**

#### ุชุญููู ุงูุตููุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:
```python
def load_open_positions_from_db():
    """ุชุญููู ุงูุตููุงุช ุงูููุชูุญุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช"""
    # ุฌูุจ ุฌููุน ุงูุตููุงุช ุงูููุชูุญุฉ
    open_orders = db_manager.get_user_orders(ADMIN_USER_ID, status='OPEN')
    
    for order in open_orders:
        position_id = order['order_id']
        
        # โ ุฅุถุงูุฉ ููุฐุงูุฑุฉ (open_positions)
        trading_bot.open_positions[position_id] = {
            'symbol': order['symbol'],
            'entry_price': order['entry_price'],
            'side': order['side'],
            'account_type': order.get('market_type', 'spot'),
            'leverage': order.get('leverage', 1),
            'amount': order.get('current_quantity'),
            # ... ุจุงูู ุงูุจูุงูุงุช
        }
```

#### ุชุญููู ุงูุฑุตูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:
```python
def update_balance_from_db():
    """ุชุญุฏูุซ ุฑุตูุฏ ุงููุญูุธุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช"""
    user_data = db_manager.get_user(ADMIN_USER_ID)
    
    if user_data and 'balance' in user_data:
        saved_balance = user_data['balance']
        
        # โ ุชุญุฏูุซ ุงูุฑุตูุฏ ูู ุงูุญุณุงุจุงุช
        trading_bot.demo_account_spot.balance = saved_balance
        trading_bot.demo_account_futures.balance = saved_balance
```

**ุนูุฏ ุจุฏุก ุงูุจูุช:**
```python
# ุฅูุดุงุก ุงูุจูุช
trading_bot = TradingBot()

# ุชุญููู ุงููุณุชุฎุฏููู
user_manager.load_all_users()

# โ ุชุญููู ุงูุตููุงุช ุงูููุชูุญุฉ
load_open_positions_from_db()

# โ ุชุญููู ุงูุฑุตูุฏ
update_balance_from_db()
```

**ุงููุชูุฌุฉ:**
- โ ุนูุฏ ุฅุนุงุฏุฉ ุชุดุบูู ุงูุจูุช โ ุงูุตููุงุช ุชูุญููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุงูุฑุตูุฏ ููุญููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ูุง ุชุถูุน ุฃู ุจูุงูุงุช

---

### 4๏ธโฃ **ุฅุตูุงุญ user_manager**

#### ูุจู ุงูุฅุตูุงุญ:
```python
# โ ุญูุธ ูุงูุต
order_data = {
    'order_id': position_id,
    'user_id': user_id,
    'symbol': symbol,
    'side': action,
    'entry_price': price,
    'quantity': amount,
    'status': 'OPEN'  # โ ุจููุฉ ุงูุญููู ููููุฏุฉ!
}
```

#### ุจุนุฏ ุงูุฅุตูุงุญ:
```python
# โ ุญูุธ ูุงูู
order_data = {
    'order_id': position_id,
    'user_id': user_id,
    'symbol': symbol,
    'side': action,
    'entry_price': price,
    'quantity': amount,
    'initial_quantity': amount,        # โ
    'current_quantity': amount,        # โ
    'take_profits': [],                # โ
    'stop_loss': None,                 # โ
    'partial_closes': [],              # โ
    'status': 'OPEN',
    'market_type': market_type,        # โ
    'leverage': leverage,              # โ
    'unrealized_pnl': 0.0,            # โ
    'realized_pnl': 0.0,              # โ
    'notes': f'ุชู ูุชุญ ุตููุฉ {market_type}'  # โ
}
```

**ุงููุชูุฌุฉ:**
- โ user_manager ูุญูุธ ุฌููุน ุงูุญููู ุงููุทููุจุฉ
- โ ุงูุชูุงูู ูุน ูุธุงู TP/SL/Partial Close

---

## ุณูุฑ ุงูุนูููุฉ ุงููุงูู ๐

### ุนูุฏ ูุชุญ ุตููุฉ:
```
ุงููุณุชุฎุฏู ูุฑุณู ุฅุดุงุฑุฉ TradingView
         โ
webhook ูุณุชูุจู ุงูุฅุดุงุฑุฉ
         โ
execute_demo_trade(symbol, action, price)
         โโโ 1. ูุชุญ ุตููุฉ ูู TradingAccount โ
         โ    โโโ account.open_futures_position() ุฃู open_spot_position()
         โ         โโโ ุชุญุฏูุซ self.balance (ุฎุตู ุงููุจูุบ)
         โ         โโโ ุฅุถุงูุฉ ุฅูู self.positions
         โโโ 2. ุญูุธ ูู ุงูุฐุงูุฑุฉ โ
         โ    โโโ trading_bot.open_positions[position_id] = {...}
         โโโ 3. ุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช โ
              โโโ db_manager.create_order(order_data)
                   โโโ INSERT INTO orders (...)

โ ุงููุชูุฌุฉ: ุงูุตููุฉ ููุฌูุฏุฉ ูู:
   - TradingAccount (ูุฅุฏุงุฑุฉ ุงููุญูุธุฉ)
   - open_positions (ูููุงุฌูุฉ)
   - ูุงุนุฏุฉ ุงูุจูุงูุงุช (ููุญูุธ ุงูุฏุงุฆู)
```

### ุนูุฏ ุฅุบูุงู ุตููุฉ ุฌุฒุฆูุงู:
```
ุงููุณุชุฎุฏู ูุถุบุท "ุฅุบูุงู ุฌุฒุฆู 50%"
         โ
execute_partial_close_percentage(position_id, 50%)
         โโโ 1. ุฅุบูุงู ุฌุฒุฆู ูู TradingAccount โ
         โ    โโโ account.partial_close_xxx_position()
         โ         โโโ ุญุณุงุจ ุงููุจูุบ/ุงููุงูุด ุงูููุบูู
         โ         โโโ ุญุณุงุจ ุงูุฑุจุญ/ุงูุฎุณุงุฑุฉ
         โ         โโโ ุชุญุฏูุซ self.balance += ุงููุจูุบ + PnL โ
         โ         โโโ ุชุญุฏูุซ position['amount'] ุฃู position.contracts
         โ         โโโ return success, {pnl, remaining_xxx, status}
         โโโ 2. ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช โ
         โ    โโโ db_manager.record_partial_close()
         โ         โโโ ุฅุถุงูุฉ ุณุฌู ูู partial_closes[]
         โ         โโโ ุชุญุฏูุซ current_quantity
         โ         โโโ ุชุญุฏูุซ realized_pnl += pnl
         โ         โโโ ุชุญุฏูุซ status (PARTIAL_CLOSED ุฃู CLOSED)
         โโโ 3. ุชุญุฏูุซ ุงูุฑุตูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช โ
         โ    โโโ db_manager.update_user_balance(user_id, new_balance)
         โโโ 4. ุชุญุฏูุซ ุงูุฐุงูุฑุฉ โ
              โโโ update open_positions[position_id] ุฃู delete ุฅุฐุง ููุบูู ุจุงููุงูู

โ ุงููุชูุฌุฉ: 
   - ุงููุญูุธุฉ ููุญุฏูุซุฉ โ
   - ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุญุฏูุซุฉ โ
   - ุงูุฑุตูุฏ ูุญููุธ โ
   - ุงููุณุชุฎุฏู ูุฑู ุงูุฑุตูุฏ ุงูุฌุฏูุฏ โ
```

### ุนูุฏ ุฅุนุงุฏุฉ ุชุดุบูู ุงูุจูุช:
```
ุงูุจูุช ูุจุฏุฃ
    โ
trading_bot = TradingBot()
    โโโ demo_account_spot = TradingAccount(balance=10000)
    โโโ demo_account_futures = TradingAccount(balance=10000)
    โ
load_open_positions_from_db() โ
    โโโ SELECT * FROM orders WHERE status IN ('OPEN', 'PARTIAL_CLOSED')
    โโโ ููู ุตููุฉ:
         โโโ trading_bot.open_positions[position_id] = {...}
    โ
update_balance_from_db() โ
    โโโ SELECT balance FROM users WHERE user_id = ADMIN_USER_ID
    โโโ demo_account_spot.balance = saved_balance
    โโโ demo_account_futures.balance = saved_balance

โ ุงููุชูุฌุฉ: 
   - ุฌููุน ุงูุตููุงุช ุงูููุชูุญุฉ ุชูุญููู โ
   - ุงูุฑุตูุฏ ุงูุตุญูุญ ููุญููู โ
   - ูุง ุชุถูุน ุฃู ุจูุงูุงุช โ
```

---

## ุงููููุงุช ุงูููุนุฏูุฉ ๐

| ุงูููู | ุงูุชุนุฏููุงุช | ุงูุณุจุจ |
|------|----------|-------|
| **`bybit_trading_bot.py`** | โ ุฅุถุงูุฉ ุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุนูุฏ ูุชุญ ุตููุฉ (futures)<br>โ ุฅุถุงูุฉ ุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุนูุฏ ูุชุญ ุตููุฉ (spot)<br>โ ุฅุถุงูุฉ `load_open_positions_from_db()`<br>โ ุฅุถุงูุฉ `update_balance_from_db()`<br>โ ุชุญุฏูุซ ุงูุฑุตูุฏ ุจุนุฏ ุงูุฅุบูุงู ุงููุงูู<br>โ ุชุญุฏูุซ ุงูุฑุตูุฏ ุจุนุฏ ุงูุฅุบูุงู ุงูุฌุฒุฆู | ูุฑุจุท ูุชุญ/ุฅุบูุงู ุงูุตููุงุช ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช |
| **`user_manager.py`** | โ ุชุญุฏูุซ `execute_user_trade()` ูุญูุธ ุฌููุน ุงูุญููู<br>โ ุฅุถุงูุฉ: `initial_quantity`, `current_quantity`, `take_profits`, `stop_loss`, `partial_closes`, `market_type`, `leverage`, etc. | ูุถูุงู ุญูุธ ุฌููุน ุงูุจูุงูุงุช ุงููุงุฒูุฉ |
| **`database.py`** | โ ุณุจู ุฅุถุงูุฉ `close_order()`<br>โ ุณุจู ุฅุถุงูุฉ `record_partial_close()` | ูุญูุธ ุนูููุงุช ุงูุฅุบูุงู |

---

## ุงูุชุฑุงุจุท ุงูููุงุฆู ๐

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   ุงููุณุชุฎุฏู                           โ
โ           (ูุฑุณู ุฅุดุงุฑุฉ ุฃู ูุถุบุท ุฒุฑ)                    โ
โโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                   โ
                   โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            bybit_trading_bot.py                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  execute_demo_trade() ุฃู                      โ  โ
โ  โ  execute_partial_close_percentage()          โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโ
     โ                    โ                    โ
     โผ                    โผ                    โผ
โโโโโโโโโโโโ      โโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโ
โTradingAccount    โ open_positions  โ  database.py   โ
โ                  โ   (ุงูุฐุงูุฑุฉ)     โ  (ูุงุนุฏุฉ ุงูุจูุงูุงุช) โ
โโโโโโโโโโโโค      โโโโโโโโโโโโโโโโค    โโโโโโโโโโโโโโโโค
โโ balance โ      โโ positions  โ    โโ orders      โ
โโ positions      โโ current_price   โโ users       โ
โโ PnL ุญุณุงุจุงุช     โโ pnl_percent    โโ user_settingsโ
โโโโโโโโโโโโ      โโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโ
     โ                    โ                    โ
     โโโโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโโโ
                          โ
                          โผ
                โ ุงูุชุฑุงุจุท ุงููุงูู
                โ ุงููุญูุธุฉ ููุญุฏูุซุฉ
                โ ุงูุจูุงูุงุช ูุญููุธุฉ
                โ ูุง ุชุถูุน ุฃู ูุนูููุงุช
```

---

## ุงูุฎูุงุตุฉ ุงูููุงุฆูุฉ ๐

### โ ุชู ุฅุตูุงุญ ุงูุชุฑุงุจุท ุจุงููุงูู:

1. **ูุชุญ ุงูุตููุงุช:**
   - โ ุชูุญูุธ ูู TradingAccount (ูุฅุฏุงุฑุฉ ุงููุญูุธุฉ)
   - โ ุชูุญูุธ ูู open_positions (ูููุงุฌูุฉ)
   - โ ุชูุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ููุงุณุชูุฑุงุฑูุฉ)

2. **ุงูุฅุบูุงู (ูุงูู ุฃู ุฌุฒุฆู):**
   - โ ููุญุฏูุซ ุงููุญูุธุฉ ููุฑุงู
   - โ ููุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
   - โ ููุญุฏูุซ ุงูุฑุตูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

3. **ุนูุฏ ุฅุนุงุฏุฉ ุงูุชุดุบูู:**
   - โ ุงูุตููุงุช ุชูุญููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
   - โ ุงูุฑุตูุฏ ููุญููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
   - โ ูุง ุชุถูุน ุฃู ุจูุงูุงุช

4. **user_manager:**
   - โ ูุญูุธ ุฌููุน ุงูุญููู ุงููุทููุจุฉ
   - โ ูุชูุงูู ูุน ูุธุงู TP/SL/Partial Close

### ๐ ุงูุจูุช ุงูุขู ูุชูุงูู ููุชุฑุงุจุท ุจุดูู ูุงูู!

**ูู ุชุนุฏ ููุงู ูุดุงูู ูู ุงูุชุฑุงุจุท ุจูู ุงูุฃุฏูุงุช!** ๐
