# نظام متكامل لربط إدارة المخاطر بالمحفظة

## 📋 نظرة عامة

تم إنشاء نظام متكامل يربط إدارة المخاطر بالمحفظة بشكل ديناميكي، حيث يتم احتساب الرصيد الفعلي مع الصفقات المفتوحة وإيقاف البوت تلقائياً عند الوصول للحد الأقصى للخسارة.

## 🎯 المتطلبات التي تم تنفيذها

### 1. حساب الرصيد الفعلي الديناميكي
- ✅ الرصيد الفعلي = الرصيد الحالي + الخسائر/الأرباح غير المحققة من الصفقات المفتوحة
- ✅ مثال: رصيد 1000 → خسارة محققة 100 → رصيد 900 → صفقة مفتوحة خسارة 200 → رصيد فعلي 700

### 2. إيقاف البوت التلقائي
- ✅ عند الوصول للحد الأقصى للخسارة (مثال: 300 USDT)
- ✅ إغلاق جميع الصفقات المفتوحة تلقائياً
- ✅ إرسال إشعار للمستخدم

### 3. الربط مع قاعدة البيانات
- ✅ تحديث الخسائر اليومية والأسبوعية بعد كل صفقة
- ✅ حفظ حالة المخاطر في قاعدة البيانات
- ✅ التمييز بين الحساب الحقيقي والتجريبي

## 🗂️ الملفات المعدلة والمضافة

### 1. `users/database.py` - الدوال الجديدة

#### أ) `calculate_real_balance_with_open_positions(user_id, account_type)`
```python
"""حساب الرصيد الفعلي مع احتساب الخسائر/الأرباح غير المحققة من الصفقات المفتوحة"""
```

**المخرجات:**
```python
{
    'initial_balance': 10000.0,           # الرصيد الأولي
    'current_balance': 9900.0,            # الرصيد الحالي في قاعدة البيانات
    'open_positions_count': 2,            # عدد الصفقات المفتوحة
    'unrealized_pnl': -200.0,             # الخسارة غير المحققة
    'realized_pnl': -100.0,               # الخسارة المحققة
    'real_balance': 9700.0,               # الرصيد الفعلي (9900 - 200)
    'locked_in_trades': 500.0             # الأموال المحجوزة
}
```

**مثال عملي:**
```
الرصيد الأولي: 1000 USDT
خسرت صفقة وأغلقتها: -100 USDT → الرصيد = 900 USDT
فتحت صفقة جديدة نزلت: -200 USDT (غير محققة)
الرصيد الفعلي = 900 - 200 = 700 USDT ✅
```

#### ب) `check_risk_limits_before_trade(user_id, account_type)`
```python
"""فحص حدود المخاطر قبل فتح صفقة جديدة"""
```

**المخرجات:**
```python
{
    'can_trade': False,                   # هل يمكن فتح صفقة جديدة
    'reason': 'تجاوز الحد الأقصى...',    # سبب المنع
    'risk_status': 'danger',              # safe, warning, danger
    'current_loss': 300.0,                # الخسارة الحالية
    'max_loss_allowed': 300.0,            # الحد الأقصى
    'remaining_margin': 0.0,              # الهامش المتبقي
    'daily_loss': 250.0,                  # الخسارة اليومية
    'weekly_loss': 280.0,                 # الخسارة الأسبوعية
    'real_balance': 700.0,                # الرصيد الفعلي
    'unrealized_pnl': -200.0              # الخسارة غير المحققة
}
```

**منطق الفحص:**
```
1. حساب الرصيد الفعلي (مع الصفقات المفتوحة)
2. حساب الخسارة الكلية = الرصيد الأولي - الرصيد الفعلي
3. فحص الحدود:
   - الخسارة الكلية >= الحد الأقصى → danger
   - الخسارة اليومية >= الحد اليومي → danger
   - الخسارة الأسبوعية >= الحد الأسبوعي → danger
4. إذا كان risk_status = danger و stop_trading_on_loss = true → can_trade = false
```

#### ج) `update_loss_after_trade_close(user_id, pnl)`
```python
"""تحديث الخسائر اليومية والأسبوعية بعد إغلاق صفقة"""
```

**الوظيفة:**
- تحديث `daily_loss`, `weekly_loss`, `total_loss` في قاعدة البيانات
- إعادة تعيين تلقائية للخسارة اليومية (كل يوم)
- إعادة تعيين تلقائية للخسارة الأسبوعية (كل أسبوع)
- حفظ تاريخ آخر تحديث

### 2. `systems/risk_portfolio_integration.py` - نظام المراقبة

#### أ) `check_and_close_if_limit_reached(user_id, account_type, bot_application)`
```python
"""فحص حدود المخاطر وإغلاق الصفقات إذا لزم الأمر"""
```

**السيناريوهات:**

**1. حالة الخطر (Danger):**
```
- فحص المخاطر → risk_status = 'danger'
- الحصول على جميع الصفقات المفتوحة
- إغلاق كل صفقة مفتوحة
- تحديث الرصيد
- إيقاف البوت (toggle_user_active)
- إرسال إشعار للمستخدم
```

**2. حالة التحذير (Warning):**
```
- فحص المخاطر → risk_status = 'warning'
- إرسال تحذير للمستخدم
- عدم إغلاق الصفقات
- عدم إيقاف البوت
```

**3. حالة الأمان (Safe):**
```
- فحص المخاطر → risk_status = 'safe'
- لا حاجة لأي إجراء
```

#### ب) `close_position_emergency(user_id, position, account_type)`
```python
"""إغلاق صفقة في حالة الطوارئ"""
```

**الخطوات:**
1. حساب PnL الحالي
2. تحديث حالة الصفقة في قاعدة البيانات
3. تحديث الرصيد
4. تحديث إحصائيات المخاطر

#### ج) `send_risk_alert(bot_application, user_id, risk_check, closed_count, total_pnl)`
```python
"""إرسال إشعار خطر للمستخدم"""
```

**محتوى الإشعار:**
```
🚨 **تنبيه خطر - تم إيقاف التداول!**

⚠️ السبب: تجاوز الحد الأقصى للخسارة

📊 الإحصائيات:
💰 الرصيد الفعلي: 700.00 USDT
📉 الخسارة الحالية: 300.00 USDT
🎯 الحد الأقصى: 300.00 USDT

🔒 الإجراءات المتخذة:
✅ تم إغلاق 2 صفقة مفتوحة
💵 إجمالي PnL من الإغلاق: -200.00 USDT
⏸️ تم إيقاف البوت تلقائياً
```

#### د) `monitor_user_continuously(user_id, account_type, bot_application, interval=60)`
```python
"""مراقبة مستمرة لمخاطر المستخدم"""
```

**الوظيفة:**
- فحص دوري كل 60 ثانية (افتراضياً)
- تلقائي في الخلفية
- إيقاف تلقائي عند الوصول للحد

### 3. `bybit_trading_bot.py` - التكامل مع الواجهة

#### تحديث `my_account_command`

**قبل:**
```python
balance = user_data.get('balance', 10000.0)
locked_balance = sum(...)
available_balance = balance - locked_balance
```

**بعد:**
```python
# حساب الرصيد الفعلي مع الصفقات المفتوحة
balance_info = db_manager.calculate_real_balance_with_open_positions(user_id, account_type)

real_balance = balance_info['real_balance']
unrealized_pnl = balance_info['unrealized_pnl']
locked_balance = balance_info['locked_in_trades']

# فحص حدود المخاطر
risk_check = db_manager.check_risk_limits_before_trade(user_id, account_type)
risk_indicator = "🟢 آمن" if risk_check['risk_status'] == 'safe' else ...
```

**الرسالة المحدثة:**
```
💼 **نظرة عامة على حسابك**

🎮 حساب تجريبي | 📈 Spot | 🟢 آمن

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💰 **الرصيد والأموال**
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💵 الرصيد في قاعدة البيانات: 9,900.00 USDT
💎 الرصيد الفعلي (مع الصفقات): 9,700.00 USDT
💚 الرصيد المتاح: 9,400.00 USDT
🔒 محجوز في الصفقات: 500.00 USDT
📊 ربح/خسارة غير محققة: -200.00 USDT
📈 ربح/خسارة محققة: -100.00 USDT (-1.00%)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🛡️ **إدارة المخاطر**
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 الحالة: 🟢 آمن
📉 الخسارة الحالية: 300.00 USDT
🎯 الحد الأقصى: 1,000.00 USDT
📏 الهامش المتبقي: 700.00 USDT
```

## 🔄 سير العمل الكامل

### سيناريو 1: فتح صفقة جديدة

```
1. المستخدم يستقبل إشارة
2. البوت يستدعي check_risk_limits_before_trade()
3. النظام يحسب:
   - الرصيد الفعلي (مع الصفقات المفتوحة)
   - الخسارة الكلية
   - الخسارة اليومية/الأسبوعية
4. إذا can_trade = true:
   - فتح الصفقة
   - تحديث قاعدة البيانات
5. إذا can_trade = false:
   - رفض الصفقة
   - إرسال إشعار للمستخدم
```

### سيناريو 2: إغلاق صفقة

```
1. إغلاق الصفقة (يدوياً أو تلقائياً)
2. حساب PnL
3. تحديث الرصيد في قاعدة البيانات
4. استدعاء update_loss_after_trade_close(user_id, pnl)
5. تحديث daily_loss, weekly_loss, total_loss
6. فحص المخاطر تلقائياً
7. إذا وصل للحد:
   - إغلاق جميع الصفقات المفتوحة
   - إيقاف البوت
   - إرسال إشعار
```

### سيناريو 3: المراقبة المستمرة

```
1. بدء المراقبة: monitor_user_continuously()
2. كل 60 ثانية:
   - حساب الرصيد الفعلي
   - فحص حدود المخاطر
   - إذا danger:
     * إغلاق جميع الصفقات
     * إيقاف البوت
     * إرسال إشعار
     * إيقاف المراقبة
   - إذا warning:
     * إرسال تحذير
     * الاستمرار في المراقبة
   - إذا safe:
     * لا شيء
     * الاستمرار في المراقبة
```

## 📊 أمثلة عملية

### مثال 1: الوصول للحد الأقصى

```
الإعدادات:
- الرصيد الأولي: 1000 USDT
- الحد الأقصى للخسارة: 300 USDT (30%)

الخطوات:
1. فتح صفقة 1: خسارة 100 USDT (محققة)
   → الرصيد = 900 USDT
   → الخسارة الكلية = 100 USDT
   → الحالة: 🟢 آمن

2. فتح صفقة 2: نزلت 200 USDT (غير محققة)
   → الرصيد الفعلي = 900 - 200 = 700 USDT
   → الخسارة الكلية = 1000 - 700 = 300 USDT
   → الحالة: 🔴 خطر

3. النظام يتصرف تلقائياً:
   ✅ إغلاق الصفقة 2 (خسارة 200 USDT)
   ✅ الرصيد النهائي = 700 USDT
   ✅ إيقاف البوت
   ✅ إرسال إشعار للمستخدم
```

### مثال 2: التحذير المبكر

```
الإعدادات:
- الرصيد الأولي: 1000 USDT
- الحد الأقصى للخسارة: 300 USDT

الخطوات:
1. فتح صفقة: نزلت 250 USDT (غير محققة)
   → الرصيد الفعلي = 750 USDT
   → الخسارة الكلية = 250 USDT
   → النسبة = 250 / 300 = 83%
   → الحالة: 🟡 تحذير

2. النظام يرسل تحذير:
   ⚠️ "اقتراب من حد المخاطر!"
   📏 الهامش المتبقي: 50 USDT
   💡 قلل من حجم التداول
```

## 🎛️ الإعدادات المتاحة

### في قاعدة البيانات (جدول `users`)

```sql
risk_management TEXT DEFAULT '{
    "enabled": true,                    -- تفعيل إدارة المخاطر
    "max_loss_percent": 10.0,           -- الحد الأقصى بالنسبة المئوية
    "max_loss_amount": 1000.0,          -- الحد الأقصى بالمبلغ
    "stop_trading_on_loss": true,       -- إيقاف التداول عند الوصول للحد
    "daily_loss_limit": 500.0,          -- الحد اليومي
    "weekly_loss_limit": 2000.0"        -- الحد الأسبوعي
}'
```

### حالات risk_status

| الحالة | الوصف | الإجراء |
|--------|-------|---------|
| `safe` | الخسارة < 80% من الحد | لا شيء |
| `warning` | الخسارة >= 80% من الحد | إرسال تحذير |
| `danger` | الخسارة >= 100% من الحد | إغلاق الصفقات + إيقاف البوت |

## 🔧 كيفية الاستخدام

### 1. فحص المخاطر قبل فتح صفقة

```python
from users.database import db_manager

# فحص قبل فتح الصفقة
risk_check = db_manager.check_risk_limits_before_trade(user_id, account_type)

if risk_check['can_trade']:
    # فتح الصفقة
    open_trade(...)
else:
    # رفض الصفقة
    send_message(f"❌ لا يمكن فتح صفقة: {risk_check['reason']}")
```

### 2. تحديث الخسائر بعد إغلاق صفقة

```python
# بعد إغلاق الصفقة
pnl = -150.0  # خسارة 150 USDT

# تحديث الإحصائيات
db_manager.update_loss_after_trade_close(user_id, pnl)

# فحص المخاطر
from systems.risk_portfolio_integration import risk_portfolio_integration
result = await risk_portfolio_integration.check_and_close_if_limit_reached(
    user_id, account_type, bot_application
)

if result['action_taken'] == 'closed_all_and_stopped':
    logger.warning(f"🚨 تم إيقاف البوت للمستخدم {user_id}")
```

### 3. بدء المراقبة المستمرة

```python
from systems.risk_portfolio_integration import risk_portfolio_integration

# بدء المراقبة (في الخلفية)
asyncio.create_task(
    risk_portfolio_integration.monitor_user_continuously(
        user_id=123456,
        account_type='demo',
        bot_application=application,
        interval=60  # كل 60 ثانية
    )
)
```

### 4. عرض الرصيد الفعلي

```python
# في أي مكان في البوت
balance_info = db_manager.calculate_real_balance_with_open_positions(user_id, account_type)

print(f"الرصيد الفعلي: {balance_info['real_balance']:.2f} USDT")
print(f"الخسارة غير المحققة: {balance_info['unrealized_pnl']:.2f} USDT")
```

## 🧪 الاختبار

### اختبار 1: حساب الرصيد الفعلي

```python
# إعداد
user_id = 123456
# رصيد في قاعدة البيانات: 1000 USDT
# صفقة مفتوحة 1: دخول 50 USDT، حالي 45 USDT → خسارة 5 USDT
# صفقة مفتوحة 2: دخول 100 USDT، حالي 95 USDT → خسارة 5 USDT

# تنفيذ
balance_info = db_manager.calculate_real_balance_with_open_positions(user_id, 'demo')

# التحقق
assert balance_info['current_balance'] == 1000.0
assert balance_info['unrealized_pnl'] == -10.0
assert balance_info['real_balance'] == 990.0  # 1000 - 10
```

### اختبار 2: فحص حدود المخاطر

```python
# إعداد
# رصيد فعلي: 700 USDT
# رصيد أولي: 1000 USDT
# خسارة كلية: 300 USDT
# حد أقصى: 300 USDT

# تنفيذ
risk_check = db_manager.check_risk_limits_before_trade(user_id, 'demo')

# التحقق
assert risk_check['can_trade'] == False
assert risk_check['risk_status'] == 'danger'
assert risk_check['current_loss'] == 300.0
```

## 📝 ملاحظات مهمة

1. **الرصيد الأولي**: حالياً مضبوط على 10000 USDT افتراضياً. يمكن تعديله حسب الحاجة.

2. **السعر الحالي**: في `calculate_real_balance_with_open_positions`، يتم استخدام `current_price` من قاعدة البيانات. يجب تحديثه من السوق الحقيقي.

3. **المراقبة المستمرة**: يُنصح ببدء المراقبة عند تفعيل البوت لأول مرة.

4. **الإشعارات**: تتطلب `bot_application` صالح لإرسال الرسائل.

5. **الأداء**: الفحص كل 60 ثانية مناسب. يمكن تقليله إلى 30 ثانية للحسابات الحقيقية.

## 🚀 الخطوات التالية (اختيارية)

1. ✅ **تحديث السعر الحالي**: إضافة دالة لجلب الأسعار من السوق الحقيقي
2. ✅ **لوحة تحكم**: إضافة واجهة لعرض حالة المخاطر في الوقت الفعلي
3. ✅ **إحصائيات متقدمة**: رسوم بيانية لتطور المخاطر
4. ✅ **تنبيهات مخصصة**: إرسال إشعارات على Telegram/Email/SMS
5. ✅ **سجل المخاطر**: حفظ تاريخ جميع تنبيهات المخاطر

## 📞 الدعم

إذا كان لديك أي استفسار أو مشكلة، يرجى:
1. مراجعة هذا الملف
2. فحص السجلات (logs)
3. التواصل مع فريق التطوير

---

**تاريخ الإنشاء**: 30 أكتوبر 2025  
**الإصدار**: 1.0  
**الحالة**: ✅ مكتمل ومختبر

