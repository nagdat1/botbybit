# ูุธุงู ูุชูุงูู ูุฑุจุท ุฅุฏุงุฑุฉ ุงููุฎุงุทุฑ ุจุงููุญูุธุฉ

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅูุดุงุก ูุธุงู ูุชูุงูู ูุฑุจุท ุฅุฏุงุฑุฉ ุงููุฎุงุทุฑ ุจุงููุญูุธุฉ ุจุดูู ุฏููุงููููุ ุญูุซ ูุชู ุงุญุชุณุงุจ ุงูุฑุตูุฏ ุงููุนูู ูุน ุงูุตููุงุช ุงูููุชูุญุฉ ูุฅููุงู ุงูุจูุช ุชููุงุฆูุงู ุนูุฏ ุงููุตูู ููุญุฏ ุงูุฃูุตู ููุฎุณุงุฑุฉ.

## ๐ฏ ุงููุชุทูุจุงุช ุงูุชู ุชู ุชูููุฐูุง

### 1. ุญุณุงุจ ุงูุฑุตูุฏ ุงููุนูู ุงูุฏููุงูููู
- โ ุงูุฑุตูุฏ ุงููุนูู = ุงูุฑุตูุฏ ุงูุญุงูู + ุงูุฎุณุงุฆุฑ/ุงูุฃุฑุจุงุญ ุบูุฑ ุงููุญููุฉ ูู ุงูุตููุงุช ุงูููุชูุญุฉ
- โ ูุซุงู: ุฑุตูุฏ 1000 โ ุฎุณุงุฑุฉ ูุญููุฉ 100 โ ุฑุตูุฏ 900 โ ุตููุฉ ููุชูุญุฉ ุฎุณุงุฑุฉ 200 โ ุฑุตูุฏ ูุนูู 700

### 2. ุฅููุงู ุงูุจูุช ุงูุชููุงุฆู
- โ ุนูุฏ ุงููุตูู ููุญุฏ ุงูุฃูุตู ููุฎุณุงุฑุฉ (ูุซุงู: 300 USDT)
- โ ุฅุบูุงู ุฌููุน ุงูุตููุงุช ุงูููุชูุญุฉ ุชููุงุฆูุงู
- โ ุฅุฑุณุงู ุฅุดุนุงุฑ ูููุณุชุฎุฏู

### 3. ุงูุฑุจุท ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุชุญุฏูุซ ุงูุฎุณุงุฆุฑ ุงูููููุฉ ูุงูุฃุณุจูุนูุฉ ุจุนุฏ ูู ุตููุฉ
- โ ุญูุธ ุญุงูุฉ ุงููุฎุงุทุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุงูุชูููุฒ ุจูู ุงูุญุณุงุจ ุงูุญูููู ูุงูุชุฌุฑูุจู

## ๐๏ธ ุงููููุงุช ุงููุนุฏูุฉ ูุงููุถุงูุฉ

### 1. `users/database.py` - ุงูุฏูุงู ุงูุฌุฏูุฏุฉ

#### ุฃ) `calculate_real_balance_with_open_positions(user_id, account_type)`
```python
"""ุญุณุงุจ ุงูุฑุตูุฏ ุงููุนูู ูุน ุงุญุชุณุงุจ ุงูุฎุณุงุฆุฑ/ุงูุฃุฑุจุงุญ ุบูุฑ ุงููุญููุฉ ูู ุงูุตููุงุช ุงูููุชูุญุฉ"""
```

**ุงููุฎุฑุฌุงุช:**
```python
{
    'initial_balance': 10000.0,           # ุงูุฑุตูุฏ ุงูุฃููู
    'current_balance': 9900.0,            # ุงูุฑุตูุฏ ุงูุญุงูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    'open_positions_count': 2,            # ุนุฏุฏ ุงูุตููุงุช ุงูููุชูุญุฉ
    'unrealized_pnl': -200.0,             # ุงูุฎุณุงุฑุฉ ุบูุฑ ุงููุญููุฉ
    'realized_pnl': -100.0,               # ุงูุฎุณุงุฑุฉ ุงููุญููุฉ
    'real_balance': 9700.0,               # ุงูุฑุตูุฏ ุงููุนูู (9900 - 200)
    'locked_in_trades': 500.0             # ุงูุฃููุงู ุงููุญุฌูุฒุฉ
}
```

**ูุซุงู ุนููู:**
```
ุงูุฑุตูุฏ ุงูุฃููู: 1000 USDT
ุฎุณุฑุช ุตููุฉ ูุฃุบููุชูุง: -100 USDT โ ุงูุฑุตูุฏ = 900 USDT
ูุชุญุช ุตููุฉ ุฌุฏูุฏุฉ ูุฒูุช: -200 USDT (ุบูุฑ ูุญููุฉ)
ุงูุฑุตูุฏ ุงููุนูู = 900 - 200 = 700 USDT โ
```

#### ุจ) `check_risk_limits_before_trade(user_id, account_type)`
```python
"""ูุญุต ุญุฏูุฏ ุงููุฎุงุทุฑ ูุจู ูุชุญ ุตููุฉ ุฌุฏูุฏุฉ"""
```

**ุงููุฎุฑุฌุงุช:**
```python
{
    'can_trade': False,                   # ูู ูููู ูุชุญ ุตููุฉ ุฌุฏูุฏุฉ
    'reason': 'ุชุฌุงูุฒ ุงูุญุฏ ุงูุฃูุตู...',    # ุณุจุจ ุงูููุน
    'risk_status': 'danger',              # safe, warning, danger
    'current_loss': 300.0,                # ุงูุฎุณุงุฑุฉ ุงูุญุงููุฉ
    'max_loss_allowed': 300.0,            # ุงูุญุฏ ุงูุฃูุตู
    'remaining_margin': 0.0,              # ุงููุงูุด ุงููุชุจูู
    'daily_loss': 250.0,                  # ุงูุฎุณุงุฑุฉ ุงูููููุฉ
    'weekly_loss': 280.0,                 # ุงูุฎุณุงุฑุฉ ุงูุฃุณุจูุนูุฉ
    'real_balance': 700.0,                # ุงูุฑุตูุฏ ุงููุนูู
    'unrealized_pnl': -200.0              # ุงูุฎุณุงุฑุฉ ุบูุฑ ุงููุญููุฉ
}
```

**ููุทู ุงููุญุต:**
```
1. ุญุณุงุจ ุงูุฑุตูุฏ ุงููุนูู (ูุน ุงูุตููุงุช ุงูููุชูุญุฉ)
2. ุญุณุงุจ ุงูุฎุณุงุฑุฉ ุงููููุฉ = ุงูุฑุตูุฏ ุงูุฃููู - ุงูุฑุตูุฏ ุงููุนูู
3. ูุญุต ุงูุญุฏูุฏ:
   - ุงูุฎุณุงุฑุฉ ุงููููุฉ >= ุงูุญุฏ ุงูุฃูุตู โ danger
   - ุงูุฎุณุงุฑุฉ ุงูููููุฉ >= ุงูุญุฏ ุงููููู โ danger
   - ุงูุฎุณุงุฑุฉ ุงูุฃุณุจูุนูุฉ >= ุงูุญุฏ ุงูุฃุณุจูุนู โ danger
4. ุฅุฐุง ูุงู risk_status = danger ู stop_trading_on_loss = true โ can_trade = false
```

#### ุฌ) `update_loss_after_trade_close(user_id, pnl)`
```python
"""ุชุญุฏูุซ ุงูุฎุณุงุฆุฑ ุงูููููุฉ ูุงูุฃุณุจูุนูุฉ ุจุนุฏ ุฅุบูุงู ุตููุฉ"""
```

**ุงููุธููุฉ:**
- ุชุญุฏูุซ `daily_loss`, `weekly_loss`, `total_loss` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุฅุนุงุฏุฉ ุชุนููู ุชููุงุฆูุฉ ููุฎุณุงุฑุฉ ุงูููููุฉ (ูู ููู)
- ุฅุนุงุฏุฉ ุชุนููู ุชููุงุฆูุฉ ููุฎุณุงุฑุฉ ุงูุฃุณุจูุนูุฉ (ูู ุฃุณุจูุน)
- ุญูุธ ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ

### 2. `systems/risk_portfolio_integration.py` - ูุธุงู ุงููุฑุงูุจุฉ

#### ุฃ) `check_and_close_if_limit_reached(user_id, account_type, bot_application)`
```python
"""ูุญุต ุญุฏูุฏ ุงููุฎุงุทุฑ ูุฅุบูุงู ุงูุตููุงุช ุฅุฐุง ูุฒู ุงูุฃูุฑ"""
```

**ุงูุณููุงุฑูููุงุช:**

**1. ุญุงูุฉ ุงูุฎุทุฑ (Danger):**
```
- ูุญุต ุงููุฎุงุทุฑ โ risk_status = 'danger'
- ุงูุญุตูู ุนูู ุฌููุน ุงูุตููุงุช ุงูููุชูุญุฉ
- ุฅุบูุงู ูู ุตููุฉ ููุชูุญุฉ
- ุชุญุฏูุซ ุงูุฑุตูุฏ
- ุฅููุงู ุงูุจูุช (toggle_user_active)
- ุฅุฑุณุงู ุฅุดุนุงุฑ ูููุณุชุฎุฏู
```

**2. ุญุงูุฉ ุงูุชุญุฐูุฑ (Warning):**
```
- ูุญุต ุงููุฎุงุทุฑ โ risk_status = 'warning'
- ุฅุฑุณุงู ุชุญุฐูุฑ ูููุณุชุฎุฏู
- ุนุฏู ุฅุบูุงู ุงูุตููุงุช
- ุนุฏู ุฅููุงู ุงูุจูุช
```

**3. ุญุงูุฉ ุงูุฃูุงู (Safe):**
```
- ูุญุต ุงููุฎุงุทุฑ โ risk_status = 'safe'
- ูุง ุญุงุฌุฉ ูุฃู ุฅุฌุฑุงุก
```

#### ุจ) `close_position_emergency(user_id, position, account_type)`
```python
"""ุฅุบูุงู ุตููุฉ ูู ุญุงูุฉ ุงูุทูุงุฑุฆ"""
```

**ุงูุฎุทูุงุช:**
1. ุญุณุงุจ PnL ุงูุญุงูู
2. ุชุญุฏูุซ ุญุงูุฉ ุงูุตููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
3. ุชุญุฏูุซ ุงูุฑุตูุฏ
4. ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงููุฎุงุทุฑ

#### ุฌ) `send_risk_alert(bot_application, user_id, risk_check, closed_count, total_pnl)`
```python
"""ุฅุฑุณุงู ุฅุดุนุงุฑ ุฎุทุฑ ูููุณุชุฎุฏู"""
```

**ูุญุชูู ุงูุฅุดุนุงุฑ:**
```
๐จ **ุชูุจูู ุฎุทุฑ - ุชู ุฅููุงู ุงูุชุฏุงูู!**

โ๏ธ ุงูุณุจุจ: ุชุฌุงูุฒ ุงูุญุฏ ุงูุฃูุตู ููุฎุณุงุฑุฉ

๐ ุงูุฅุญุตุงุฆูุงุช:
๐ฐ ุงูุฑุตูุฏ ุงููุนูู: 700.00 USDT
๐ ุงูุฎุณุงุฑุฉ ุงูุญุงููุฉ: 300.00 USDT
๐ฏ ุงูุญุฏ ุงูุฃูุตู: 300.00 USDT

๐ ุงูุฅุฌุฑุงุกุงุช ุงููุชุฎุฐุฉ:
โ ุชู ุฅุบูุงู 2 ุตููุฉ ููุชูุญุฉ
๐ต ุฅุฌูุงูู PnL ูู ุงูุฅุบูุงู: -200.00 USDT
โธ๏ธ ุชู ุฅููุงู ุงูุจูุช ุชููุงุฆูุงู
```

#### ุฏ) `monitor_user_continuously(user_id, account_type, bot_application, interval=60)`
```python
"""ูุฑุงูุจุฉ ูุณุชูุฑุฉ ููุฎุงุทุฑ ุงููุณุชุฎุฏู"""
```

**ุงููุธููุฉ:**
- ูุญุต ุฏูุฑู ูู 60 ุซุงููุฉ (ุงูุชุฑุงุถูุงู)
- ุชููุงุฆู ูู ุงูุฎูููุฉ
- ุฅููุงู ุชููุงุฆู ุนูุฏ ุงููุตูู ููุญุฏ

### 3. `bybit_trading_bot.py` - ุงูุชูุงูู ูุน ุงููุงุฌูุฉ

#### ุชุญุฏูุซ `my_account_command`

**ูุจู:**
```python
balance = user_data.get('balance', 10000.0)
locked_balance = sum(...)
available_balance = balance - locked_balance
```

**ุจุนุฏ:**
```python
# ุญุณุงุจ ุงูุฑุตูุฏ ุงููุนูู ูุน ุงูุตููุงุช ุงูููุชูุญุฉ
balance_info = db_manager.calculate_real_balance_with_open_positions(user_id, account_type)

real_balance = balance_info['real_balance']
unrealized_pnl = balance_info['unrealized_pnl']
locked_balance = balance_info['locked_in_trades']

# ูุญุต ุญุฏูุฏ ุงููุฎุงุทุฑ
risk_check = db_manager.check_risk_limits_before_trade(user_id, account_type)
risk_indicator = "๐ข ุขูู" if risk_check['risk_status'] == 'safe' else ...
```

**ุงูุฑุณุงูุฉ ุงููุญุฏุซุฉ:**
```
๐ผ **ูุธุฑุฉ ุนุงูุฉ ุนูู ุญุณุงุจู**

๐ฎ ุญุณุงุจ ุชุฌุฑูุจู | ๐ Spot | ๐ข ุขูู

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฐ **ุงูุฑุตูุฏ ูุงูุฃููุงู**
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ต ุงูุฑุตูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช: 9,900.00 USDT
๐ ุงูุฑุตูุฏ ุงููุนูู (ูุน ุงูุตููุงุช): 9,700.00 USDT
๐ ุงูุฑุตูุฏ ุงููุชุงุญ: 9,400.00 USDT
๐ ูุญุฌูุฒ ูู ุงูุตููุงุช: 500.00 USDT
๐ ุฑุจุญ/ุฎุณุงุฑุฉ ุบูุฑ ูุญููุฉ: -200.00 USDT
๐ ุฑุจุญ/ุฎุณุงุฑุฉ ูุญููุฉ: -100.00 USDT (-1.00%)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ก๏ธ **ุฅุฏุงุฑุฉ ุงููุฎุงุทุฑ**
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุงูุญุงูุฉ: ๐ข ุขูู
๐ ุงูุฎุณุงุฑุฉ ุงูุญุงููุฉ: 300.00 USDT
๐ฏ ุงูุญุฏ ุงูุฃูุตู: 1,000.00 USDT
๐ ุงููุงูุด ุงููุชุจูู: 700.00 USDT
```

## ๐ ุณูุฑ ุงูุนูู ุงููุงูู

### ุณููุงุฑูู 1: ูุชุญ ุตููุฉ ุฌุฏูุฏุฉ

```
1. ุงููุณุชุฎุฏู ูุณุชูุจู ุฅุดุงุฑุฉ
2. ุงูุจูุช ูุณุชุฏุนู check_risk_limits_before_trade()
3. ุงููุธุงู ูุญุณุจ:
   - ุงูุฑุตูุฏ ุงููุนูู (ูุน ุงูุตููุงุช ุงูููุชูุญุฉ)
   - ุงูุฎุณุงุฑุฉ ุงููููุฉ
   - ุงูุฎุณุงุฑุฉ ุงูููููุฉ/ุงูุฃุณุจูุนูุฉ
4. ุฅุฐุง can_trade = true:
   - ูุชุญ ุงูุตููุฉ
   - ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช
5. ุฅุฐุง can_trade = false:
   - ุฑูุถ ุงูุตููุฉ
   - ุฅุฑุณุงู ุฅุดุนุงุฑ ูููุณุชุฎุฏู
```

### ุณููุงุฑูู 2: ุฅุบูุงู ุตููุฉ

```
1. ุฅุบูุงู ุงูุตููุฉ (ูุฏููุงู ุฃู ุชููุงุฆูุงู)
2. ุญุณุงุจ PnL
3. ุชุญุฏูุซ ุงูุฑุตูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
4. ุงุณุชุฏุนุงุก update_loss_after_trade_close(user_id, pnl)
5. ุชุญุฏูุซ daily_loss, weekly_loss, total_loss
6. ูุญุต ุงููุฎุงุทุฑ ุชููุงุฆูุงู
7. ุฅุฐุง ูุตู ููุญุฏ:
   - ุฅุบูุงู ุฌููุน ุงูุตููุงุช ุงูููุชูุญุฉ
   - ุฅููุงู ุงูุจูุช
   - ุฅุฑุณุงู ุฅุดุนุงุฑ
```

### ุณููุงุฑูู 3: ุงููุฑุงูุจุฉ ุงููุณุชูุฑุฉ

```
1. ุจุฏุก ุงููุฑุงูุจุฉ: monitor_user_continuously()
2. ูู 60 ุซุงููุฉ:
   - ุญุณุงุจ ุงูุฑุตูุฏ ุงููุนูู
   - ูุญุต ุญุฏูุฏ ุงููุฎุงุทุฑ
   - ุฅุฐุง danger:
     * ุฅุบูุงู ุฌููุน ุงูุตููุงุช
     * ุฅููุงู ุงูุจูุช
     * ุฅุฑุณุงู ุฅุดุนุงุฑ
     * ุฅููุงู ุงููุฑุงูุจุฉ
   - ุฅุฐุง warning:
     * ุฅุฑุณุงู ุชุญุฐูุฑ
     * ุงูุงุณุชูุฑุงุฑ ูู ุงููุฑุงูุจุฉ
   - ุฅุฐุง safe:
     * ูุง ุดูุก
     * ุงูุงุณุชูุฑุงุฑ ูู ุงููุฑุงูุจุฉ
```

## ๐ ุฃูุซูุฉ ุนูููุฉ

### ูุซุงู 1: ุงููุตูู ููุญุฏ ุงูุฃูุตู

```
ุงูุฅุนุฏุงุฏุงุช:
- ุงูุฑุตูุฏ ุงูุฃููู: 1000 USDT
- ุงูุญุฏ ุงูุฃูุตู ููุฎุณุงุฑุฉ: 300 USDT (30%)

ุงูุฎุทูุงุช:
1. ูุชุญ ุตููุฉ 1: ุฎุณุงุฑุฉ 100 USDT (ูุญููุฉ)
   โ ุงูุฑุตูุฏ = 900 USDT
   โ ุงูุฎุณุงุฑุฉ ุงููููุฉ = 100 USDT
   โ ุงูุญุงูุฉ: ๐ข ุขูู

2. ูุชุญ ุตููุฉ 2: ูุฒูุช 200 USDT (ุบูุฑ ูุญููุฉ)
   โ ุงูุฑุตูุฏ ุงููุนูู = 900 - 200 = 700 USDT
   โ ุงูุฎุณุงุฑุฉ ุงููููุฉ = 1000 - 700 = 300 USDT
   โ ุงูุญุงูุฉ: ๐ด ุฎุทุฑ

3. ุงููุธุงู ูุชุตุฑู ุชููุงุฆูุงู:
   โ ุฅุบูุงู ุงูุตููุฉ 2 (ุฎุณุงุฑุฉ 200 USDT)
   โ ุงูุฑุตูุฏ ุงูููุงุฆู = 700 USDT
   โ ุฅููุงู ุงูุจูุช
   โ ุฅุฑุณุงู ุฅุดุนุงุฑ ูููุณุชุฎุฏู
```

### ูุซุงู 2: ุงูุชุญุฐูุฑ ุงููุจูุฑ

```
ุงูุฅุนุฏุงุฏุงุช:
- ุงูุฑุตูุฏ ุงูุฃููู: 1000 USDT
- ุงูุญุฏ ุงูุฃูุตู ููุฎุณุงุฑุฉ: 300 USDT

ุงูุฎุทูุงุช:
1. ูุชุญ ุตููุฉ: ูุฒูุช 250 USDT (ุบูุฑ ูุญููุฉ)
   โ ุงูุฑุตูุฏ ุงููุนูู = 750 USDT
   โ ุงูุฎุณุงุฑุฉ ุงููููุฉ = 250 USDT
   โ ุงููุณุจุฉ = 250 / 300 = 83%
   โ ุงูุญุงูุฉ: ๐ก ุชุญุฐูุฑ

2. ุงููุธุงู ูุฑุณู ุชุญุฐูุฑ:
   โ๏ธ "ุงูุชุฑุงุจ ูู ุญุฏ ุงููุฎุงุทุฑ!"
   ๐ ุงููุงูุด ุงููุชุจูู: 50 USDT
   ๐ก ููู ูู ุญุฌู ุงูุชุฏุงูู
```

## ๐๏ธ ุงูุฅุนุฏุงุฏุงุช ุงููุชุงุญุฉ

### ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุฌุฏูู `users`)

```sql
risk_management TEXT DEFAULT '{
    "enabled": true,                    -- ุชูุนูู ุฅุฏุงุฑุฉ ุงููุฎุงุทุฑ
    "max_loss_percent": 10.0,           -- ุงูุญุฏ ุงูุฃูุตู ุจุงููุณุจุฉ ุงููุฆููุฉ
    "max_loss_amount": 1000.0,          -- ุงูุญุฏ ุงูุฃูุตู ุจุงููุจูุบ
    "stop_trading_on_loss": true,       -- ุฅููุงู ุงูุชุฏุงูู ุนูุฏ ุงููุตูู ููุญุฏ
    "daily_loss_limit": 500.0,          -- ุงูุญุฏ ุงููููู
    "weekly_loss_limit": 2000.0"        -- ุงูุญุฏ ุงูุฃุณุจูุนู
}'
```

### ุญุงูุงุช risk_status

| ุงูุญุงูุฉ | ุงููุตู | ุงูุฅุฌุฑุงุก |
|--------|-------|---------|
| `safe` | ุงูุฎุณุงุฑุฉ < 80% ูู ุงูุญุฏ | ูุง ุดูุก |
| `warning` | ุงูุฎุณุงุฑุฉ >= 80% ูู ุงูุญุฏ | ุฅุฑุณุงู ุชุญุฐูุฑ |
| `danger` | ุงูุฎุณุงุฑุฉ >= 100% ูู ุงูุญุฏ | ุฅุบูุงู ุงูุตููุงุช + ุฅููุงู ุงูุจูุช |

## ๐ง ููููุฉ ุงูุงุณุชุฎุฏุงู

### 1. ูุญุต ุงููุฎุงุทุฑ ูุจู ูุชุญ ุตููุฉ

```python
from users.database import db_manager

# ูุญุต ูุจู ูุชุญ ุงูุตููุฉ
risk_check = db_manager.check_risk_limits_before_trade(user_id, account_type)

if risk_check['can_trade']:
    # ูุชุญ ุงูุตููุฉ
    open_trade(...)
else:
    # ุฑูุถ ุงูุตููุฉ
    send_message(f"โ ูุง ูููู ูุชุญ ุตููุฉ: {risk_check['reason']}")
```

### 2. ุชุญุฏูุซ ุงูุฎุณุงุฆุฑ ุจุนุฏ ุฅุบูุงู ุตููุฉ

```python
# ุจุนุฏ ุฅุบูุงู ุงูุตููุฉ
pnl = -150.0  # ุฎุณุงุฑุฉ 150 USDT

# ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
db_manager.update_loss_after_trade_close(user_id, pnl)

# ูุญุต ุงููุฎุงุทุฑ
from systems.risk_portfolio_integration import risk_portfolio_integration
result = await risk_portfolio_integration.check_and_close_if_limit_reached(
    user_id, account_type, bot_application
)

if result['action_taken'] == 'closed_all_and_stopped':
    logger.warning(f"๐จ ุชู ุฅููุงู ุงูุจูุช ูููุณุชุฎุฏู {user_id}")
```

### 3. ุจุฏุก ุงููุฑุงูุจุฉ ุงููุณุชูุฑุฉ

```python
from systems.risk_portfolio_integration import risk_portfolio_integration

# ุจุฏุก ุงููุฑุงูุจุฉ (ูู ุงูุฎูููุฉ)
asyncio.create_task(
    risk_portfolio_integration.monitor_user_continuously(
        user_id=123456,
        account_type='demo',
        bot_application=application,
        interval=60  # ูู 60 ุซุงููุฉ
    )
)
```

### 4. ุนุฑุถ ุงูุฑุตูุฏ ุงููุนูู

```python
# ูู ุฃู ููุงู ูู ุงูุจูุช
balance_info = db_manager.calculate_real_balance_with_open_positions(user_id, account_type)

print(f"ุงูุฑุตูุฏ ุงููุนูู: {balance_info['real_balance']:.2f} USDT")
print(f"ุงูุฎุณุงุฑุฉ ุบูุฑ ุงููุญููุฉ: {balance_info['unrealized_pnl']:.2f} USDT")
```

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ 1: ุญุณุงุจ ุงูุฑุตูุฏ ุงููุนูู

```python
# ุฅุนุฏุงุฏ
user_id = 123456
# ุฑุตูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช: 1000 USDT
# ุตููุฉ ููุชูุญุฉ 1: ุฏุฎูู 50 USDTุ ุญุงูู 45 USDT โ ุฎุณุงุฑุฉ 5 USDT
# ุตููุฉ ููุชูุญุฉ 2: ุฏุฎูู 100 USDTุ ุญุงูู 95 USDT โ ุฎุณุงุฑุฉ 5 USDT

# ุชูููุฐ
balance_info = db_manager.calculate_real_balance_with_open_positions(user_id, 'demo')

# ุงูุชุญูู
assert balance_info['current_balance'] == 1000.0
assert balance_info['unrealized_pnl'] == -10.0
assert balance_info['real_balance'] == 990.0  # 1000 - 10
```

### ุงุฎุชุจุงุฑ 2: ูุญุต ุญุฏูุฏ ุงููุฎุงุทุฑ

```python
# ุฅุนุฏุงุฏ
# ุฑุตูุฏ ูุนูู: 700 USDT
# ุฑุตูุฏ ุฃููู: 1000 USDT
# ุฎุณุงุฑุฉ ูููุฉ: 300 USDT
# ุญุฏ ุฃูุตู: 300 USDT

# ุชูููุฐ
risk_check = db_manager.check_risk_limits_before_trade(user_id, 'demo')

# ุงูุชุญูู
assert risk_check['can_trade'] == False
assert risk_check['risk_status'] == 'danger'
assert risk_check['current_loss'] == 300.0
```

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุงูุฑุตูุฏ ุงูุฃููู**: ุญุงููุงู ูุถุจูุท ุนูู 10000 USDT ุงูุชุฑุงุถูุงู. ูููู ุชุนุฏููู ุญุณุจ ุงูุญุงุฌุฉ.

2. **ุงูุณุนุฑ ุงูุญุงูู**: ูู `calculate_real_balance_with_open_positions`ุ ูุชู ุงุณุชุฎุฏุงู `current_price` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช. ูุฌุจ ุชุญุฏูุซู ูู ุงูุณูู ุงูุญูููู.

3. **ุงููุฑุงูุจุฉ ุงููุณุชูุฑุฉ**: ูููุตุญ ุจุจุฏุก ุงููุฑุงูุจุฉ ุนูุฏ ุชูุนูู ุงูุจูุช ูุฃูู ูุฑุฉ.

4. **ุงูุฅุดุนุงุฑุงุช**: ุชุชุทูุจ `bot_application` ุตุงูุญ ูุฅุฑุณุงู ุงูุฑุณุงุฆู.

5. **ุงูุฃุฏุงุก**: ุงููุญุต ูู 60 ุซุงููุฉ ููุงุณุจ. ูููู ุชููููู ุฅูู 30 ุซุงููุฉ ููุญุณุงุจุงุช ุงูุญููููุฉ.

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ (ุงุฎุชูุงุฑูุฉ)

1. โ **ุชุญุฏูุซ ุงูุณุนุฑ ุงูุญุงูู**: ุฅุถุงูุฉ ุฏุงูุฉ ูุฌูุจ ุงูุฃุณุนุงุฑ ูู ุงูุณูู ุงูุญูููู
2. โ **ููุญุฉ ุชุญูู**: ุฅุถุงูุฉ ูุงุฌูุฉ ูุนุฑุถ ุญุงูุฉ ุงููุฎุงุทุฑ ูู ุงูููุช ุงููุนูู
3. โ **ุฅุญุตุงุฆูุงุช ูุชูุฏูุฉ**: ุฑุณูู ุจูุงููุฉ ูุชุทูุฑ ุงููุฎุงุทุฑ
4. โ **ุชูุจููุงุช ูุฎุตุตุฉ**: ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ุนูู Telegram/Email/SMS
5. โ **ุณุฌู ุงููุฎุงุทุฑ**: ุญูุธ ุชุงุฑูุฎ ุฌููุน ุชูุจููุงุช ุงููุฎุงุทุฑ

## ๐ ุงูุฏุนู

ุฅุฐุง ูุงู ูุฏูู ุฃู ุงุณุชูุณุงุฑ ุฃู ูุดููุฉุ ูุฑุฌู:
1. ูุฑุงุฌุนุฉ ูุฐุง ุงูููู
2. ูุญุต ุงูุณุฌูุงุช (logs)
3. ุงูุชูุงุตู ูุน ูุฑูู ุงูุชุทููุฑ

---

**ุชุงุฑูุฎ ุงูุฅูุดุงุก**: 30 ุฃูุชูุจุฑ 2025  
**ุงูุฅุตุฏุงุฑ**: 1.0  
**ุงูุญุงูุฉ**: โ ููุชูู ููุฎุชุจุฑ

