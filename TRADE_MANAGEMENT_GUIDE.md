# 🚀 نظام إدارة الصفقات المتقدم - Bybit Multi-User Bot

## ✨ الميزات الجديدة المضافة

### 🎯 نظام إدارة الصفقات المتقدم
- **رسالة منفصلة لكل صفقة** مع معلومات مفصلة
- **أزرار ديناميكية** لجميع عمليات الصفقة
- **تحديث تلقائي** لمعلومات الصفقة
- **إشعارات فورية** لجميع العمليات

### 🎯 أهداف الربح (TP)
- أزرار سريعة للنسب: **1%**, **2%**, **5%**
- إمكانية **تخصيص النسب** حسب الحاجة
- تنفيذ **فوري** عند الضغط
- رسائل تأكيد واضحة

### 🛑 وقف الخسارة (SL)
- أزرار سريعة للنسب: **1%**, **2%**, **3%**
- إمكانية **تخصيص النسب** حسب الحاجة
- مراقبة **تلقائية** للسعر
- إغلاق **فوري** عند الوصول للنسبة

### ✂️ الإغلاق الجزئي
- أزرار سريعة للنسب: **25%**, **50%**, **75%**
- إمكانية **تخصيص النسب** حسب الحاجة
- تنفيذ **تدريجي** للصفقة
- تتبع الكمية المتبقية

### 🔒 الإغلاق الكامل
- زر واحد لإغلاق **كامل الصفقة**
- تنفيذ **فوري** بدون تأخير
- رسالة تأكيد نهائية

### ⚙️ تعديل النسب
- زر لتغيير **نسب TP/SL/Partial**
- إعدادات **مرنة** لكل مستخدم
- حفظ **تلقائي** للإعدادات

---

## 📱 كيفية الاستخدام

### 1. عرض الصفقات المفتوحة
```
اضغط على "🔄 الصفقات المفتوحة"
```

### 2. إدارة كل صفقة
ستظهر رسالة منفصلة لكل صفقة تحتوي على:

```
📊 BTCUSDT 🟢

🔄 النوع: شراء
💰 سعر الدخول: 45000.000000
📈 السعر الحالي: 45200.000000
💰 الربح/الخسارة: 20.00 USDT (+0.44%)
📊 الكمية المتبقية: 0.010000

🆔 معرف الصفقة: trade_1234567890
```

### 3. الأزرار المتاحة

#### 🎯 أهداف الربح
- `🎯 TP 1%` - إغلاق 1% من الصفقة عند الربح
- `🎯 TP 2%` - إغلاق 2% من الصفقة عند الربح  
- `🎯 TP 5%` - إغلاق 5% من الصفقة عند الربح

#### 🛑 وقف الخسارة
- `🛑 SL 1%` - إغلاق عند خسارة 1%
- `🛑 SL 2%` - إغلاق عند خسارة 2%
- `🛑 SL 3%` - إغلاق عند خسارة 3%

#### ✂️ الإغلاق الجزئي
- `✂️ 25%` - إغلاق 25% من الصفقة فوراً
- `✂️ 50%` - إغلاق 50% من الصفقة فوراً
- `✂️ 75%` - إغلاق 75% من الصفقة فوراً

#### 🔒 التحكم الإضافي
- `🔒 إغلاق كامل` - إغلاق الصفقة بالكامل
- `⚙️ تعديل النسب` - تغيير النسب الافتراضية

#### 🔄 التحديث والتنقل
- `🔄 تحديث` - تحديث معلومات الصفقة
- `🔙 العودة` - العودة لقائمة الصفقات

---

## ⚙️ تخصيص النسب

### تعديل نسب TP
1. اضغط `⚙️ تعديل النسب`
2. اضغط `🎯 تعديل TP`
3. أدخل النسب الجديدة (مثال: `1,3,5`)
4. سيتم تطبيق النسب الجديدة

### تعديل نسب SL
1. اضغط `⚙️ تعديل النسب`
2. اضغط `🛑 تعديل SL`
3. أدخل النسب الجديدة (مثال: `1,2,4`)
4. سيتم تطبيق النسب الجديدة

### تعديل نسب الإغلاق الجزئي
1. اضغط `⚙️ تعديل النسب`
2. اضغط `✂️ تعديل Partial`
3. أدخل النسب الجديدة (مثال: `20,40,60`)
4. سيتم تطبيق النسب الجديدة

---

## 🔔 الإشعارات

### عند تنفيذ TP
```
✅ تم تنفيذ هدف الربح!

📊 BTCUSDT
🎯 TP: 2%
💰 السعر: 45900.000000
💵 الربح: 9.00 USDT

🔄 الصفقة لا تزال مفتوحة للجزء المتبقي
```

### عند تنفيذ SL
```
⚠️ تم تنفيذ وقف الخسارة!

📊 BTCUSDT
🛑 SL: 2%
💰 السعر: 44100.000000
💸 الخسارة: -18.00 USDT

🔒 تم إغلاق الصفقة بالكامل
```

### عند الإغلاق الجزئي
```
✂️ تم تنفيذ الإغلاق الجزئي!

📊 BTCUSDT
📉 الإغلاق: 50%
💰 السعر: 45200.000000
💵 الربح/الخسارة: 10.00 USDT

🔄 الصفقة لا تزال مفتوحة للجزء المتبقي
```

### عند الإغلاق الكامل
```
🔒 تم إغلاق الصفقة بالكامل!

📊 BTCUSDT
💰 السعر النهائي: 45200.000000
💵 الربح/الخسارة النهائي: 20.00 USDT

✅ الصفقة مكتملة
```

---

## 🛠️ الملفات الجديدة

### `trade_manager.py`
- إدارة الصفقات المتقدمة
- تنفيذ TP/SL/Partial Close
- تتبع حالة الصفقات

### `trade_notifications.py`
- نظام الإشعارات المتقدم
- رسائل مفصلة لكل عملية
- إشعارات فورية

### `trade_messages.py`
- رسائل موحدة للنجاح والأخطاء
- قوالب جاهزة للاستخدام
- رسائل واضحة ومفهومة

### `trade_error_manager.py`
- إدارة الأخطاء المتقدمة
- تتبع تكرار الأخطاء
- تقليل الإشعارات المكررة

---

## 🚀 البدء السريع

### 1. تشغيل البوت
```bash
python run_with_server.py
```

### 2. استخدام البوت
1. أرسل `/start` للبوت
2. اضغط `🔄 الصفقات المفتوحة`
3. ستظهر الصفقة التجريبية تلقائياً
4. جرب الأزرار المختلفة

### 3. اختبار النظام
- اضغط `🎯 TP 2%` لاختبار هدف الربح
- اضغط `✂️ 50%` لاختبار الإغلاق الجزئي
- اضغط `🔄 تحديث` لتحديث السعر
- اضغط `⚙️ تعديل النسب` لتخصيص الإعدادات

---

## 📊 مثال على الاستخدام

### سيناريو: صفقة BTCUSDT
1. **فتح الصفقة**: شراء 0.01 BTC بسعر 45000
2. **السعر الحالي**: 45200 (+0.44%)
3. **الربح الحالي**: +20 USDT

#### العمليات المتاحة:
- `🎯 TP 1%` → إغلاق عند 45450 (+1%)
- `🎯 TP 2%` → إغلاق عند 45900 (+2%)
- `🛑 SL 2%` → إغلاق عند 44100 (-2%)
- `✂️ 25%` → إغلاق 25% فوراً
- `🔒 إغلاق كامل` → إغلاق كل شيء

---

## 🔧 التخصيص المتقدم

### تغيير النسب الافتراضية
```python
# في trade_manager.py
self.trade_settings = {
    'tp_percentages': [1.0, 2.0, 5.0],      # أهداف الربح
    'sl_percentages': [1.0, 2.0, 3.0],       # وقف الخسارة
    'partial_close_percentages': [25.0, 50.0, 75.0]  # الإغلاق الجزئي
}
```

### إضافة نسب جديدة
```python
# مثال: إضافة نسب مخصصة
tp_percentages = [0.5, 1.5, 3.0, 7.0]  # نسب أكثر دقة
sl_percentages = [0.5, 1.0, 2.0, 4.0]  # نسب أكثر حذراً
partial_percentages = [10.0, 30.0, 60.0, 90.0]  # نسب أكثر مرونة
```

---

## 🎯 المميزات الرئيسية

### ✅ سهولة الاستخدام
- واجهة **بديهية** وواضحة
- أزرار **سريعة** للعمليات الشائعة
- رسائل **مفهومة** لكل عملية

### ✅ مرونة التخصيص
- نسب **قابلة للتعديل** حسب الحاجة
- إعدادات **مخصصة** لكل مستخدم
- حفظ **تلقائي** للإعدادات

### ✅ أمان عالي
- التحقق من **ملكية الصفقة**
- منع **التلاعب** بالصفقات
- تسجيل **مفصل** لجميع العمليات

### ✅ أداء محسن
- تحديث **فوري** للمعلومات
- إشعارات **سريعة** وموثوقة
- إدارة **ذكية** للأخطاء

---

## 📞 الدعم والمساعدة

### للمساعدة التقنية:
- راجع ملفات `trade_*.py` للتفاصيل التقنية
- تحقق من السجلات في `trading_bot.log`
- استخدم `/start` لإعادة تهيئة البوت

### للميزات الجديدة:
- جرب النظام مع الصفقة التجريبية
- اختبر جميع الأزرار والوظائف
- قم بتخصيص النسب حسب احتياجاتك

---

**🎉 النظام جاهز للاستخدام! استمتع بإدارة صفقاتك بطريقة احترافية ومتقدمة!**
