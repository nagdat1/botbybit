#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„
ÙŠÙ‚ÙˆÙ… Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø¨ØªØ´ØºÙŠÙ„ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
"""

import sys
import os
import asyncio
import logging
from datetime import datetime
import signal
import threading

# Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø±Ø§Øª Python
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
from system_initializer import SystemInitializer
from config import (
    TELEGRAM_TOKEN,
    ADMIN_USER_ID,
    WEBHOOK_URL
)

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO,
    handlers=[
        logging.FileHandler('trading_bot.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

class SystemManager:
    """Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„"""
    
    def __init__(self):
        """ØªÙ‡ÙŠØ¦Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…"""
        self.initializer = None
        self.components = {}
        self.stopping = False
        self.setup_signal_handlers()
    
    def setup_signal_handlers(self):
        """Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…"""
        signal.signal(signal.SIGINT, self.handle_shutdown)
        signal.signal(signal.SIGTERM, self.handle_shutdown)
    
    def handle_shutdown(self, signum, frame):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø¸Ø§Ù…"""
        if self.stopping:
            return
        
        self.stopping = True
        logger.info("â¹ï¸ Ø¬Ø§Ø±ÙŠ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø£Ù…Ø§Ù†...")
        
        try:
            # Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹ÙƒØ³ÙŠ
            if 'web_server' in self.components:
                self.components['web_server'].stop()
            
            if 'telegram' in self.components:
                self.components['telegram'].stop()
            
            if 'trading' in self.components:
                self.components['trading'].stop()
            
            logger.info("âœ… ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­")
            
        except Exception as e:
            logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø¸Ø§Ù…: {e}")
        
        sys.exit(0)
    
    async def start(self):
        """Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…"""
        try:
            print("ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ù„Ù„ØªØ¯Ø§ÙˆÙ„ Ø¹Ù„Ù‰ Bybit...")
            print(f"â° Ø§Ù„ÙˆÙ‚Øª: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
            
            # Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
            self.initializer = SystemInitializer()
            if not await self.initializer.initialize_system():
                raise Exception("ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…")
            
            # Ø­ÙØ¸ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            self.components = self.initializer.components
            
            # Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…
            await self.setup_server()
            
            # ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù…
            await self.setup_telegram()
            
            # ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„
            await self.setup_trading()
            
            logger.info("âœ… ØªÙ… Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­")
            
            # Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø¹Ù„Ù‰ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
            while not self.stopping:
                await asyncio.sleep(1)
            
        except KeyboardInterrupt:
            logger.info("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
            self.handle_shutdown(None, None)
            
        except Exception as e:
            logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…: {e}")
            raise
    
    async def setup_server(self):
        """Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…"""
        try:
            web_server = self.components.get('web_server')
            if not web_server:
                raise Exception("Ø®Ø§Ø¯Ù… Ø§Ù„ÙˆÙŠØ¨ ØºÙŠØ± Ù…ØªØ§Ø­")
            
            # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù… ÙÙŠ thread Ù…Ù†ÙØµÙ„
            server_thread = threading.Thread(
                target=web_server.run,
                daemon=True
            )
            server_thread.start()
            
            print("âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø®Ø§Ø¯Ù… Ø§Ù„ÙˆÙŠØ¨ Ø¨Ù†Ø¬Ø§Ø­")
            
            # Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ·Ø¨Ø§Ø¹Ø© Ø±ÙˆØ§Ø¨Ø· Webhook
            await self.setup_webhooks()
            
        except Exception as e:
            logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø§Ø¯Ù…: {e}")
            raise
    
    async def setup_webhooks(self):
        """Ø¥Ø¹Ø¯Ø§Ø¯ Ø±ÙˆØ§Ø¨Ø· Webhook"""
        try:
            railway_url = os.getenv('RAILWAY_PUBLIC_DOMAIN') or os.getenv('RAILWAY_STATIC_URL')
            
            if railway_url:
                if not railway_url.startswith('http'):
                    railway_url = f"https://{railway_url}"
                webhook_url = f"{railway_url}/webhook"
                environment = "ğŸš‚ Railway Cloud"
            else:
                port = self.components['web_server'].port
                webhook_url = f"http://localhost:{port}/webhook"
                environment = "ğŸ’» Local Development"
            
            print("=" * 60)
            print(f"ğŸŒ Ø±Ø§Ø¨Ø· Webhook ({environment}):")
            print(f"   {webhook_url}")
            print("=" * 60)
            
            # Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ØªÙ„Ø¬Ø±Ø§Ù…
            await self.send_startup_notification(webhook_url, environment)
            
        except Exception as e:
            logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Webhook: {e}")
    
    async def setup_telegram(self):
        """Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªØ´ØºÙŠÙ„ Ø¨ÙˆØª Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù…"""
        try:
            telegram = self.components.get('telegram')
            if not telegram:
                raise Exception("Ø¨ÙˆØª Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù… ØºÙŠØ± Ù…ØªØ§Ø­")
            
            print("ğŸ¤– Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„...")
            
            # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù€ event loop
            asyncio.create_task(
                telegram.run_polling(
                    allowed_updates=["message", "callback_query"],
                    drop_pending_updates=True
                )
            )
            
        except Exception as e:
            logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙˆØª Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù…: {e}")
            raise
    
    async def setup_trading(self):
        """Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„"""
        try:
            trading = self.components.get('trading')
            if not trading:
                raise Exception("Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„ ØºÙŠØ± Ù…ØªØ§Ø­")
            
            # ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„
            await trading.start()
            
            print("ğŸ“ˆ ØªÙ… Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­")
            
        except Exception as e:
            logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„: {e}")
            raise
    
    async def send_startup_notification(self, webhook_url, environment):
        """Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„"""
        try:
            telegram = self.components.get('telegram')
            if not telegram or not ADMIN_USER_ID:
                return
            
            message = f"""
ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„

ğŸŒ Ø§Ù„Ø¨ÙŠØ¦Ø©: {environment}
ğŸŒ Ø±Ø§Ø¨Ø· Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª:
`{webhook_url}`

ğŸ“‹ ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:
1. Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ø¹Ù„Ø§Ù‡
2. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ TradingView
3. Ø£Ø¶Ù Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Webhook
4. Ø£Ø±Ø³Ù„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø¨Ø§Ù„ØµÙŠØºØ©:
   {{"symbol": "BTCUSDT", "action": "buy"}}

â° Ø§Ù„ÙˆÙ‚Øª: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„!
            """
            
            await telegram.bot.send_message(
                chat_id=ADMIN_USER_ID,
                text=message,
                parse_mode='Markdown'
            )
            
        except Exception as e:
            logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„: {e}")

async def main():
    """Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    try:
        # Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªØ´ØºÙŠÙ„ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…
        manager = SystemManager()
        await manager.start()
        
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)

if __name__ == "__main__":
    # Ù„ØªÙˆØ§ÙÙ‚ Windows
    if sys.platform == 'win32':
        asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
    
    # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
    asyncio.run(main())