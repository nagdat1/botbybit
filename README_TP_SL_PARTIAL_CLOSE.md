# دليل نظام إدارة الصفقات المتقدم
## Take Profit / Stop Loss / Partial Close

---

## 📋 نظرة عامة

تم إضافة نظام متقدم لإدارة الصفقات المفتوحة في بوت Bybit متعدد المستخدمين. يتيح هذا النظام للمستخدمين:

- ✅ تحديد **Take Profit** متعدد (أكثر من TP واحد)
- ✅ تحديد **Stop Loss** واحد
- ✅ تحديد الأهداف بـ **النسبة المئوية** أو **السعر المحدد**
- ✅ **الإغلاق الجزئي** للصفقات بنسب مختلفة
- ✅ **العزل الكامل** بين المستخدمين
- ✅ **التكامل الكامل** مع نظام البوت الحالي

---

## 🏗️ البنية المعمارية

### 1. الملفات الأساسية

#### `position_manager.py`
- **الدور**: إدارة الصفقات المتقدمة
- **الفئات الرئيسية**:
  - `PositionTarget`: تمثيل هدف TP أو SL
  - `ManagedPosition`: صفقة مدارة مع TP/SL/Partial Close
  - `PositionManager`: مدير عام لجميع الصفقات

#### `database.py` (محدّث)
- تم إضافة حقول جديدة لجدول `orders`:
  ```sql
  - initial_quantity: الكمية الأولية
  - current_quantity: الكمية الحالية (بعد الإغلاقات الجزئية)
  - take_profits: قائمة أهداف TP (JSON)
  - stop_loss: هدف SL (JSON)
  - partial_closes: سجل الإغلاقات الجزئية (JSON)
  - market_type: نوع السوق (spot/futures)
  - leverage: الرافعة المالية
  - unrealized_pnl: الربح/الخسارة غير المحققة
  - realized_pnl: الربح/الخسارة المحققة
  ```

#### `bybit_trading_bot.py` (محدّث)
- إضافة وظائف إدارة TP/SL/Partial Close
- إضافة أزرار تفاعلية في واجهة التيليجرام
- معالجة الأحداث والإدخالات

---

## 🎯 كيفية الاستخدام

### 1. عرض الصفقات المفتوحة

اضغط على زر **"🔄 الصفقات المفتوحة"** من القائمة الرئيسية.

ستظهر لك قائمة بجميع الصفقات المفتوحة مع الأزرار التالية لكل صفقة:

```
┌─────────────────────────────┐
│  🟢💰 BTCUSDT                │
│  🔄 النوع: BUY              │
│  💲 سعر الدخول: 50000.00   │
│  💲 السعر الحالي: 51000.00 │
│  ⬆️ الربح/الخسارة: +100.00 │
└─────────────────────────────┘
   [🎯 TP] [🛑 SL] [📊 إغلاق جزئي]
   [❌ إغلاق BTCUSDT (+100.00)]
```

---

### 2. إدارة Take Profit (TP)

#### الخطوات:
1. اضغط على زر **"🎯 TP"** للصفقة المطلوبة
2. اختر من القائمة:
   - **➕ إضافة TP جديد**: إضافة هدف جديد
   - **📝 TP بنسبة مئوية**: مثال: 5% ربح
   - **💲 TP بسعر محدد**: مثال: 52000 USDT
   - **📋 عرض TPs الحالية**: عرض جميع الأهداف

#### مثال عملي:
```
✅ إضافة TP بنسبة مئوية:
- TP1: 3% → سيُحقق عند ربح 3%
- TP2: 5% → سيُحقق عند ربح 5%
- TP3: 10% → سيُحقق عند ربح 10%

✅ إضافة TP بسعر محدد:
- TP1: 51000 USDT
- TP2: 52000 USDT
- TP3: 55000 USDT
```

#### الإغلاق الجزئي عند TP:
- يمكنك تحديد نسبة إغلاق لكل TP
- مثال: TP1 → 25%, TP2 → 50%, TP3 → 100%

---

### 3. إدارة Stop Loss (SL)

#### الخطوات:
1. اضغط على زر **"🛑 SL"** للصفقة المطلوبة
2. اختر من القائمة:
   - **📝 SL بنسبة مئوية**: مثال: -5% خسارة
   - **💲 SL بسعر محدد**: مثال: 48000 USDT
   - **🗑️ حذف SL**: إزالة SL الحالي

#### مثال عملي:
```
✅ SL بنسبة مئوية:
- SL: -3% → سيُغلق الصفقة عند خسارة 3%

✅ SL بسعر محدد:
- SL: 48000 USDT
```

⚠️ **ملاحظة**: يمكن تحديد SL واحد فقط لكل صفقة

---

### 4. الإغلاق الجزئي (Partial Close)

#### الخطوات:
1. اضغط على زر **"📊 إغلاق جزئي"** للصفقة المطلوبة
2. اختر النسبة:
   - **25%**: إغلاق ربع الصفقة
   - **50%**: إغلاق نصف الصفقة
   - **75%**: إغلاق ثلاثة أرباع الصفقة
   - **📝 نسبة مخصصة**: أدخل أي نسبة من 1% إلى 99%

#### مثال عملي:
```
صفقة BTCUSDT:
- الكمية الأولية: 1.0 BTC
- إغلاق جزئي 25% → الكمية المتبقية: 0.75 BTC
- إغلاق جزئي 50% → الكمية المتبقية: 0.375 BTC
```

#### فوائد الإغلاق الجزئي:
- ✅ تأمين الأرباح تدريجياً
- ✅ تقليل المخاطر
- ✅ المرونة في إدارة الصفقات

---

## 🔧 التكامل مع النظام

### العزل بين المستخدمين

```python
# كل مستخدم له صفقاته المستقلة تماماً
user_1_positions = position_manager.get_user_positions(user_id=12345)
user_2_positions = position_manager.get_user_positions(user_id=67890)

# لا يوجد أي تداخل بين المستخدمين
```

### الربط مع قاعدة البيانات

```python
# عند فتح صفقة جديدة
order_data = {
    'order_id': position_id,
    'user_id': user_id,
    'symbol': 'BTCUSDT',
    'side': 'buy',
    'entry_price': 50000.0,
    'quantity': 1.0,
    'initial_quantity': 1.0,
    'current_quantity': 1.0,
    'take_profits': [],  # سيتم إضافتها لاحقاً
    'stop_loss': None,
    'partial_closes': [],
    'market_type': 'futures',
    'leverage': 10,
    'status': 'OPEN'
}
db_manager.create_order(order_data)
```

### الربط مع user_manager

```python
# استخدام user_manager للوصول إلى الصفقات
user_positions = user_manager.get_user_positions(user_id)

# تحديث أسعار الصفقات
prices = {'BTCUSDT': 51000.0, 'ETHUSDT': 3000.0}
user_manager.update_user_positions_prices(user_id, prices)
```

---

## 📊 أمثلة عملية

### مثال 1: صفقة شراء BTC مع TP/SL متعددة

```
1. فتح صفقة:
   - الرمز: BTCUSDT
   - النوع: شراء (BUY)
   - السعر: 50,000 USDT
   - الكمية: 1.0 BTC
   - الرافعة: 10x

2. إضافة Take Profits:
   - TP1: 51,500 USDT (3% ربح) → إغلاق 25%
   - TP2: 52,500 USDT (5% ربح) → إغلاق 50%
   - TP3: 55,000 USDT (10% ربح) → إغلاق 100%

3. إضافة Stop Loss:
   - SL: 48,500 USDT (3% خسارة) → إغلاق كامل

4. النتائج المحتملة:
   ✅ السعر يصل 51,500 → يُغلق 25% → ربح +37.5 USDT
   ✅ السعر يصل 52,500 → يُغلق 50% (من المتبقي) → ربح إضافي +75 USDT
   ❌ السعر يصل 48,500 → يُغلق الباقي → خسارة -45 USDT
```

### مثال 2: استراتيجية trailing stop

```
1. فتح صفقة ETH:
   - السعر: 3,000 USDT
   - SL الأولي: 2,850 USDT (-5%)

2. السعر يرتفع إلى 3,150 USDT:
   - تحديث SL إلى 3,000 USDT (نقطة التعادل)
   - إغلاق جزئي 30% → تأمين ربح

3. السعر يرتفع إلى 3,300 USDT:
   - تحديث SL إلى 3,135 USDT (+4.5%)
   - إغلاق جزئي 30% إضافي → تأمين مزيد من الربح

4. السعر يتراجع ويصل SL:
   - إغلاق الباقي (40%) → إجمالي ربح إيجابي
```

---

## 🔒 الأمان والعزل

### 1. عزل المستخدمين
- ✅ كل مستخدم له `user_id` فريد
- ✅ جميع الصفقات مرتبطة بـ `user_id`
- ✅ لا يمكن لأي مستخدم الوصول إلى صفقات مستخدم آخر
- ✅ التحقق من `user_id` في كل عملية

### 2. التحقق من الصلاحيات
```python
# قبل أي عملية على الصفقة
if position.user_id != current_user_id:
    return "❌ غير مصرح لك بهذه العملية"
```

### 3. حماية البيانات
- ✅ تشفير API Keys في قاعدة البيانات
- ✅ عدم مشاركة معلومات الصفقات بين المستخدمين
- ✅ سجلات منفصلة لكل مستخدم

---

## 🛠️ الصيانة والتطوير

### إضافة ميزات جديدة

#### 1. إضافة trailing stop loss:
```python
class TrailingStopLoss(PositionTarget):
    def __init__(self, trailing_percentage: float):
        super().__init__(target_type='trailing_sl', value=0)
        self.trailing_percentage = trailing_percentage
        self.highest_price = 0
    
    def update(self, current_price: float, entry_price: float):
        if current_price > self.highest_price:
            self.highest_price = current_price
            self.value = current_price * (1 - self.trailing_percentage / 100)
```

#### 2. إضافة إشعارات عند تفعيل الأهداف:
```python
async def notify_target_triggered(user_id: int, position_id: str, target_type: str):
    message = f"🎯 تم تفعيل {target_type} للصفقة {position_id}"
    await bot.send_message(chat_id=user_id, text=message)
```

---

## 📈 الإحصائيات والتقارير

### عرض إحصائيات الصفقة
```python
position_info = position_manager.get_position(position_id).get_position_info()

print(f"""
📊 إحصائيات الصفقة:
- الكمية الأولية: {position_info['initial_quantity']}
- الكمية الحالية: {position_info['current_quantity']}
- النسبة المتبقية: {position_info['remaining_percentage']}%
- عدد الإغلاقات الجزئية: {position_info['partial_closes_count']}
- الربح المحقق: {position_info['realized_pnl']}
- الربح غير المحقق: {position_info['unrealized_pnl']}
- إجمالي الربح: {position_info['total_pnl']}
""")
```

---

## ❓ الأسئلة الشائعة

### س1: هل يمكن إضافة أكثر من 3 Take Profits؟
✅ نعم، لا يوجد حد أقصى لعدد TPs

### س2: هل يمكن تحديد أكثر من Stop Loss؟
❌ لا، يمكن تحديد SL واحد فقط لكل صفقة

### س3: ماذا يحدث عند إغلاق 100% جزئياً؟
✅ تُغلق الصفقة تماماً وتُحفظ في سجل الصفقات المغلقة

### س4: هل يمكن إلغاء TP/SL بعد تحديده؟
✅ نعم، يمكن حذف أو تعديل أي TP/SL في أي وقت

### س5: كيف يتم حساب الربح/الخسارة بعد الإغلاقات الجزئية؟
```
الربح الإجمالي = الربح المحقق + الربح غير المحقق

مثال:
- إغلاق جزئي 25% بربح +50 USDT → ربح محقق
- الباقي 75% بربح غير محقق +100 USDT
- إجمالي الربح = 50 + 100 = 150 USDT
```

---

## 🔄 التحديثات المستقبلية

### مخطط له:
- [ ] Trailing Stop Loss التلقائي
- [ ] إشعارات متقدمة عبر التيليجرام
- [ ] رسوم بيانية للصفقات
- [ ] تصدير التقارير (PDF/Excel)
- [ ] استراتيجيات TP/SL المحفوظة (Templates)
- [ ] تكامل مع TradingView Alerts

---

## 📞 الدعم

للمساعدة أو الإبلاغ عن مشاكل:
1. استخدم أمر `/start` في البوت
2. راجع ملف `context.json` للمزيد من التفاصيل
3. تحقق من سجلات `trading_bot.log`

---

## 📝 ملاحظات هامة

⚠️ **تنبيهات الأمان**:
- احفظ نسخة احتياطية من قاعدة البيانات بانتظام
- لا تشارك API Keys مع أي شخص
- استخدم حسابات تجريبية للاختبار أولاً

✅ **أفضل الممارسات**:
- حدد دائماً Stop Loss لحماية رأس المال
- استخدم الإغلاق الجزئي لتأمين الأرباح
- راجع الصفقات المفتوحة بانتظام
- اختبر الاستراتيجيات على الحساب التجريبي أولاً

---

## 🎓 خاتمة

نظام إدارة الصفقات المتقدم يوفر لك:
- ✅ **تحكم كامل** في صفقاتك
- ✅ **مرونة عالية** في إدارة المخاطر
- ✅ **عزل تام** بين المستخدمين
- ✅ **تكامل سلس** مع البوت الحالي

استمتع بالتداول الآمن والمربح! 🚀📈

---

**الإصدار**: 1.0.0  
**آخر تحديث**: أكتوبر 2025  
**المطور**: Bybit Trading Bot Team
