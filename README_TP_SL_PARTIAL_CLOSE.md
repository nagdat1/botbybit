# ุฏููู ูุธุงู ุฅุฏุงุฑุฉ ุงูุตููุงุช ุงููุชูุฏู
## Take Profit / Stop Loss / Partial Close

---

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅุถุงูุฉ ูุธุงู ูุชูุฏู ูุฅุฏุงุฑุฉ ุงูุตููุงุช ุงูููุชูุญุฉ ูู ุจูุช Bybit ูุชุนุฏุฏ ุงููุณุชุฎุฏููู. ูุชูุญ ูุฐุง ุงููุธุงู ูููุณุชุฎุฏููู:

- โ ุชุญุฏูุฏ **Take Profit** ูุชุนุฏุฏ (ุฃูุซุฑ ูู TP ูุงุญุฏ)
- โ ุชุญุฏูุฏ **Stop Loss** ูุงุญุฏ
- โ ุชุญุฏูุฏ ุงูุฃูุฏุงู ุจู **ุงููุณุจุฉ ุงููุฆููุฉ** ุฃู **ุงูุณุนุฑ ุงููุญุฏุฏ**
- โ **ุงูุฅุบูุงู ุงูุฌุฒุฆู** ููุตููุงุช ุจูุณุจ ูุฎุชููุฉ
- โ **ุงูุนุฒู ุงููุงูู** ุจูู ุงููุณุชุฎุฏููู
- โ **ุงูุชูุงูู ุงููุงูู** ูุน ูุธุงู ุงูุจูุช ุงูุญุงูู

---

## ๐๏ธ ุงูุจููุฉ ุงููุนูุงุฑูุฉ

### 1. ุงููููุงุช ุงูุฃุณุงุณูุฉ

#### `position_manager.py`
- **ุงูุฏูุฑ**: ุฅุฏุงุฑุฉ ุงูุตููุงุช ุงููุชูุฏูุฉ
- **ุงููุฆุงุช ุงูุฑุฆูุณูุฉ**:
  - `PositionTarget`: ุชูุซูู ูุฏู TP ุฃู SL
  - `ManagedPosition`: ุตููุฉ ูุฏุงุฑุฉ ูุน TP/SL/Partial Close
  - `PositionManager`: ูุฏูุฑ ุนุงู ูุฌููุน ุงูุตููุงุช

#### `database.py` (ูุญุฏูุซ)
- ุชู ุฅุถุงูุฉ ุญููู ุฌุฏูุฏุฉ ูุฌุฏูู `orders`:
  ```sql
  - initial_quantity: ุงููููุฉ ุงูุฃูููุฉ
  - current_quantity: ุงููููุฉ ุงูุญุงููุฉ (ุจุนุฏ ุงูุฅุบูุงูุงุช ุงูุฌุฒุฆูุฉ)
  - take_profits: ูุงุฆูุฉ ุฃูุฏุงู TP (JSON)
  - stop_loss: ูุฏู SL (JSON)
  - partial_closes: ุณุฌู ุงูุฅุบูุงูุงุช ุงูุฌุฒุฆูุฉ (JSON)
  - market_type: ููุน ุงูุณูู (spot/futures)
  - leverage: ุงูุฑุงูุนุฉ ุงููุงููุฉ
  - unrealized_pnl: ุงูุฑุจุญ/ุงูุฎุณุงุฑุฉ ุบูุฑ ุงููุญููุฉ
  - realized_pnl: ุงูุฑุจุญ/ุงูุฎุณุงุฑุฉ ุงููุญููุฉ
  ```

#### `bybit_trading_bot.py` (ูุญุฏูุซ)
- ุฅุถุงูุฉ ูุธุงุฆู ุฅุฏุงุฑุฉ TP/SL/Partial Close
- ุฅุถุงูุฉ ุฃุฒุฑุงุฑ ุชูุงุนููุฉ ูู ูุงุฌูุฉ ุงูุชูููุฌุฑุงู
- ูุนุงูุฌุฉ ุงูุฃุญุฏุงุซ ูุงูุฅุฏุฎุงูุงุช

---

## ๐ฏ ููููุฉ ุงูุงุณุชุฎุฏุงู

### 1. ุนุฑุถ ุงูุตููุงุช ุงูููุชูุญุฉ

ุงุถุบุท ุนูู ุฒุฑ **"๐ ุงูุตููุงุช ุงูููุชูุญุฉ"** ูู ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ.

ุณุชุธูุฑ ูู ูุงุฆูุฉ ุจุฌููุน ุงูุตููุงุช ุงูููุชูุญุฉ ูุน ุงูุฃุฒุฑุงุฑ ุงูุชุงููุฉ ููู ุตููุฉ:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ข๐ฐ BTCUSDT                โ
โ  ๐ ุงูููุน: BUY              โ
โ  ๐ฒ ุณุนุฑ ุงูุฏุฎูู: 50000.00   โ
โ  ๐ฒ ุงูุณุนุฑ ุงูุญุงูู: 51000.00 โ
โ  โฌ๏ธ ุงูุฑุจุญ/ุงูุฎุณุงุฑุฉ: +100.00 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   [๐ฏ TP] [๐ SL] [๐ ุฅุบูุงู ุฌุฒุฆู]
   [โ ุฅุบูุงู BTCUSDT (+100.00)]
```

---

### 2. ุฅุฏุงุฑุฉ Take Profit (TP)

#### ุงูุฎุทูุงุช:
1. ุงุถุบุท ุนูู ุฒุฑ **"๐ฏ TP"** ููุตููุฉ ุงููุทููุจุฉ
2. ุงุฎุชุฑ ูู ุงููุงุฆูุฉ:
   - **โ ุฅุถุงูุฉ TP ุฌุฏูุฏ**: ุฅุถุงูุฉ ูุฏู ุฌุฏูุฏ
   - **๐ TP ุจูุณุจุฉ ูุฆููุฉ**: ูุซุงู: 5% ุฑุจุญ
   - **๐ฒ TP ุจุณุนุฑ ูุญุฏุฏ**: ูุซุงู: 52000 USDT
   - **๐ ุนุฑุถ TPs ุงูุญุงููุฉ**: ุนุฑุถ ุฌููุน ุงูุฃูุฏุงู

#### ูุซุงู ุนููู:
```
โ ุฅุถุงูุฉ TP ุจูุณุจุฉ ูุฆููุฉ:
- TP1: 3% โ ุณููุญูู ุนูุฏ ุฑุจุญ 3%
- TP2: 5% โ ุณููุญูู ุนูุฏ ุฑุจุญ 5%
- TP3: 10% โ ุณููุญูู ุนูุฏ ุฑุจุญ 10%

โ ุฅุถุงูุฉ TP ุจุณุนุฑ ูุญุฏุฏ:
- TP1: 51000 USDT
- TP2: 52000 USDT
- TP3: 55000 USDT
```

#### ุงูุฅุบูุงู ุงูุฌุฒุฆู ุนูุฏ TP:
- ููููู ุชุญุฏูุฏ ูุณุจุฉ ุฅุบูุงู ููู TP
- ูุซุงู: TP1 โ 25%, TP2 โ 50%, TP3 โ 100%

---

### 3. ุฅุฏุงุฑุฉ Stop Loss (SL)

#### ุงูุฎุทูุงุช:
1. ุงุถุบุท ุนูู ุฒุฑ **"๐ SL"** ููุตููุฉ ุงููุทููุจุฉ
2. ุงุฎุชุฑ ูู ุงููุงุฆูุฉ:
   - **๐ SL ุจูุณุจุฉ ูุฆููุฉ**: ูุซุงู: -5% ุฎุณุงุฑุฉ
   - **๐ฒ SL ุจุณุนุฑ ูุญุฏุฏ**: ูุซุงู: 48000 USDT
   - **๐๏ธ ุญุฐู SL**: ุฅุฒุงูุฉ SL ุงูุญุงูู

#### ูุซุงู ุนููู:
```
โ SL ุจูุณุจุฉ ูุฆููุฉ:
- SL: -3% โ ุณููุบูู ุงูุตููุฉ ุนูุฏ ุฎุณุงุฑุฉ 3%

โ SL ุจุณุนุฑ ูุญุฏุฏ:
- SL: 48000 USDT
```

โ๏ธ **ููุงุญุธุฉ**: ูููู ุชุญุฏูุฏ SL ูุงุญุฏ ููุท ููู ุตููุฉ

---

### 4. ุงูุฅุบูุงู ุงูุฌุฒุฆู (Partial Close)

#### ุงูุฎุทูุงุช:
1. ุงุถุบุท ุนูู ุฒุฑ **"๐ ุฅุบูุงู ุฌุฒุฆู"** ููุตููุฉ ุงููุทููุจุฉ
2. ุงุฎุชุฑ ุงููุณุจุฉ:
   - **25%**: ุฅุบูุงู ุฑุจุน ุงูุตููุฉ
   - **50%**: ุฅุบูุงู ูุตู ุงูุตููุฉ
   - **75%**: ุฅุบูุงู ุซูุงุซุฉ ุฃุฑุจุงุน ุงูุตููุฉ
   - **๐ ูุณุจุฉ ูุฎุตุตุฉ**: ุฃุฏุฎู ุฃู ูุณุจุฉ ูู 1% ุฅูู 99%

#### ูุซุงู ุนููู:
```
ุตููุฉ BTCUSDT:
- ุงููููุฉ ุงูุฃูููุฉ: 1.0 BTC
- ุฅุบูุงู ุฌุฒุฆู 25% โ ุงููููุฉ ุงููุชุจููุฉ: 0.75 BTC
- ุฅุบูุงู ุฌุฒุฆู 50% โ ุงููููุฉ ุงููุชุจููุฉ: 0.375 BTC
```

#### ููุงุฆุฏ ุงูุฅุบูุงู ุงูุฌุฒุฆู:
- โ ุชุฃููู ุงูุฃุฑุจุงุญ ุชุฏุฑูุฌูุงู
- โ ุชูููู ุงููุฎุงุทุฑ
- โ ุงููุฑููุฉ ูู ุฅุฏุงุฑุฉ ุงูุตููุงุช

---

## ๐ง ุงูุชูุงูู ูุน ุงููุธุงู

### ุงูุนุฒู ุจูู ุงููุณุชุฎุฏููู

```python
# ูู ูุณุชุฎุฏู ูู ุตููุงุชู ุงููุณุชููุฉ ุชูุงูุงู
user_1_positions = position_manager.get_user_positions(user_id=12345)
user_2_positions = position_manager.get_user_positions(user_id=67890)

# ูุง ููุฌุฏ ุฃู ุชุฏุงุฎู ุจูู ุงููุณุชุฎุฏููู
```

### ุงูุฑุจุท ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช

```python
# ุนูุฏ ูุชุญ ุตููุฉ ุฌุฏูุฏุฉ
order_data = {
    'order_id': position_id,
    'user_id': user_id,
    'symbol': 'BTCUSDT',
    'side': 'buy',
    'entry_price': 50000.0,
    'quantity': 1.0,
    'initial_quantity': 1.0,
    'current_quantity': 1.0,
    'take_profits': [],  # ุณูุชู ุฅุถุงูุชูุง ูุงุญูุงู
    'stop_loss': None,
    'partial_closes': [],
    'market_type': 'futures',
    'leverage': 10,
    'status': 'OPEN'
}
db_manager.create_order(order_data)
```

### ุงูุฑุจุท ูุน user_manager

```python
# ุงุณุชุฎุฏุงู user_manager ูููุตูู ุฅูู ุงูุตููุงุช
user_positions = user_manager.get_user_positions(user_id)

# ุชุญุฏูุซ ุฃุณุนุงุฑ ุงูุตููุงุช
prices = {'BTCUSDT': 51000.0, 'ETHUSDT': 3000.0}
user_manager.update_user_positions_prices(user_id, prices)
```

---

## ๐ ุฃูุซูุฉ ุนูููุฉ

### ูุซุงู 1: ุตููุฉ ุดุฑุงุก BTC ูุน TP/SL ูุชุนุฏุฏุฉ

```
1. ูุชุญ ุตููุฉ:
   - ุงูุฑูุฒ: BTCUSDT
   - ุงูููุน: ุดุฑุงุก (BUY)
   - ุงูุณุนุฑ: 50,000 USDT
   - ุงููููุฉ: 1.0 BTC
   - ุงูุฑุงูุนุฉ: 10x

2. ุฅุถุงูุฉ Take Profits:
   - TP1: 51,500 USDT (3% ุฑุจุญ) โ ุฅุบูุงู 25%
   - TP2: 52,500 USDT (5% ุฑุจุญ) โ ุฅุบูุงู 50%
   - TP3: 55,000 USDT (10% ุฑุจุญ) โ ุฅุบูุงู 100%

3. ุฅุถุงูุฉ Stop Loss:
   - SL: 48,500 USDT (3% ุฎุณุงุฑุฉ) โ ุฅุบูุงู ูุงูู

4. ุงููุชุงุฆุฌ ุงููุญุชููุฉ:
   โ ุงูุณุนุฑ ูุตู 51,500 โ ููุบูู 25% โ ุฑุจุญ +37.5 USDT
   โ ุงูุณุนุฑ ูุตู 52,500 โ ููุบูู 50% (ูู ุงููุชุจูู) โ ุฑุจุญ ุฅุถุงูู +75 USDT
   โ ุงูุณุนุฑ ูุตู 48,500 โ ููุบูู ุงูุจุงูู โ ุฎุณุงุฑุฉ -45 USDT
```

### ูุซุงู 2: ุงุณุชุฑุงุชูุฌูุฉ trailing stop

```
1. ูุชุญ ุตููุฉ ETH:
   - ุงูุณุนุฑ: 3,000 USDT
   - SL ุงูุฃููู: 2,850 USDT (-5%)

2. ุงูุณุนุฑ ูุฑุชูุน ุฅูู 3,150 USDT:
   - ุชุญุฏูุซ SL ุฅูู 3,000 USDT (ููุทุฉ ุงูุชุนุงุฏู)
   - ุฅุบูุงู ุฌุฒุฆู 30% โ ุชุฃููู ุฑุจุญ

3. ุงูุณุนุฑ ูุฑุชูุน ุฅูู 3,300 USDT:
   - ุชุญุฏูุซ SL ุฅูู 3,135 USDT (+4.5%)
   - ุฅุบูุงู ุฌุฒุฆู 30% ุฅุถุงูู โ ุชุฃููู ูุฒูุฏ ูู ุงูุฑุจุญ

4. ุงูุณุนุฑ ูุชุฑุงุฌุน ููุตู SL:
   - ุฅุบูุงู ุงูุจุงูู (40%) โ ุฅุฌูุงูู ุฑุจุญ ุฅูุฌุงุจู
```

---

## ๐ ุงูุฃูุงู ูุงูุนุฒู

### 1. ุนุฒู ุงููุณุชุฎุฏููู
- โ ูู ูุณุชุฎุฏู ูู `user_id` ูุฑูุฏ
- โ ุฌููุน ุงูุตููุงุช ูุฑุชุจุทุฉ ุจู `user_id`
- โ ูุง ูููู ูุฃู ูุณุชุฎุฏู ุงููุตูู ุฅูู ุตููุงุช ูุณุชุฎุฏู ุขุฎุฑ
- โ ุงูุชุญูู ูู `user_id` ูู ูู ุนูููุฉ

### 2. ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
```python
# ูุจู ุฃู ุนูููุฉ ุนูู ุงูุตููุฉ
if position.user_id != current_user_id:
    return "โ ุบูุฑ ูุตุฑุญ ูู ุจูุฐู ุงูุนูููุฉ"
```

### 3. ุญูุงูุฉ ุงูุจูุงูุงุช
- โ ุชุดููุฑ API Keys ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุนุฏู ูุดุงุฑูุฉ ูุนูููุงุช ุงูุตููุงุช ุจูู ุงููุณุชุฎุฏููู
- โ ุณุฌูุงุช ูููุตูุฉ ููู ูุณุชุฎุฏู

---

## ๐๏ธ ุงูุตูุงูุฉ ูุงูุชุทููุฑ

### ุฅุถุงูุฉ ููุฒุงุช ุฌุฏูุฏุฉ

#### 1. ุฅุถุงูุฉ trailing stop loss:
```python
class TrailingStopLoss(PositionTarget):
    def __init__(self, trailing_percentage: float):
        super().__init__(target_type='trailing_sl', value=0)
        self.trailing_percentage = trailing_percentage
        self.highest_price = 0
    
    def update(self, current_price: float, entry_price: float):
        if current_price > self.highest_price:
            self.highest_price = current_price
            self.value = current_price * (1 - self.trailing_percentage / 100)
```

#### 2. ุฅุถุงูุฉ ุฅุดุนุงุฑุงุช ุนูุฏ ุชูุนูู ุงูุฃูุฏุงู:
```python
async def notify_target_triggered(user_id: int, position_id: str, target_type: str):
    message = f"๐ฏ ุชู ุชูุนูู {target_type} ููุตููุฉ {position_id}"
    await bot.send_message(chat_id=user_id, text=message)
```

---

## ๐ ุงูุฅุญุตุงุฆูุงุช ูุงูุชูุงุฑูุฑ

### ุนุฑุถ ุฅุญุตุงุฆูุงุช ุงูุตููุฉ
```python
position_info = position_manager.get_position(position_id).get_position_info()

print(f"""
๐ ุฅุญุตุงุฆูุงุช ุงูุตููุฉ:
- ุงููููุฉ ุงูุฃูููุฉ: {position_info['initial_quantity']}
- ุงููููุฉ ุงูุญุงููุฉ: {position_info['current_quantity']}
- ุงููุณุจุฉ ุงููุชุจููุฉ: {position_info['remaining_percentage']}%
- ุนุฏุฏ ุงูุฅุบูุงูุงุช ุงูุฌุฒุฆูุฉ: {position_info['partial_closes_count']}
- ุงูุฑุจุญ ุงููุญูู: {position_info['realized_pnl']}
- ุงูุฑุจุญ ุบูุฑ ุงููุญูู: {position_info['unrealized_pnl']}
- ุฅุฌูุงูู ุงูุฑุจุญ: {position_info['total_pnl']}
""")
```

---

## โ ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ

### ุณ1: ูู ูููู ุฅุถุงูุฉ ุฃูุซุฑ ูู 3 Take Profitsุ
โ ูุนูุ ูุง ููุฌุฏ ุญุฏ ุฃูุตู ูุนุฏุฏ TPs

### ุณ2: ูู ูููู ุชุญุฏูุฏ ุฃูุซุฑ ูู Stop Lossุ
โ ูุงุ ูููู ุชุญุฏูุฏ SL ูุงุญุฏ ููุท ููู ุตููุฉ

### ุณ3: ูุงุฐุง ูุญุฏุซ ุนูุฏ ุฅุบูุงู 100% ุฌุฒุฆูุงูุ
โ ุชูุบูู ุงูุตููุฉ ุชูุงูุงู ูุชูุญูุธ ูู ุณุฌู ุงูุตููุงุช ุงููุบููุฉ

### ุณ4: ูู ูููู ุฅูุบุงุก TP/SL ุจุนุฏ ุชุญุฏูุฏูุ
โ ูุนูุ ูููู ุญุฐู ุฃู ุชุนุฏูู ุฃู TP/SL ูู ุฃู ููุช

### ุณ5: ููู ูุชู ุญุณุงุจ ุงูุฑุจุญ/ุงูุฎุณุงุฑุฉ ุจุนุฏ ุงูุฅุบูุงูุงุช ุงูุฌุฒุฆูุฉุ
```
ุงูุฑุจุญ ุงูุฅุฌูุงูู = ุงูุฑุจุญ ุงููุญูู + ุงูุฑุจุญ ุบูุฑ ุงููุญูู

ูุซุงู:
- ุฅุบูุงู ุฌุฒุฆู 25% ุจุฑุจุญ +50 USDT โ ุฑุจุญ ูุญูู
- ุงูุจุงูู 75% ุจุฑุจุญ ุบูุฑ ูุญูู +100 USDT
- ุฅุฌูุงูู ุงูุฑุจุญ = 50 + 100 = 150 USDT
```

---

## ๐ ุงูุชุญุฏูุซุงุช ุงููุณุชูุจููุฉ

### ูุฎุทุท ูู:
- [ ] Trailing Stop Loss ุงูุชููุงุฆู
- [ ] ุฅุดุนุงุฑุงุช ูุชูุฏูุฉ ุนุจุฑ ุงูุชูููุฌุฑุงู
- [ ] ุฑุณูู ุจูุงููุฉ ููุตููุงุช
- [ ] ุชุตุฏูุฑ ุงูุชูุงุฑูุฑ (PDF/Excel)
- [ ] ุงุณุชุฑุงุชูุฌูุงุช TP/SL ุงููุญููุธุฉ (Templates)
- [ ] ุชูุงูู ูุน TradingView Alerts

---

## ๐ ุงูุฏุนู

ูููุณุงุนุฏุฉ ุฃู ุงูุฅุจูุงุบ ุนู ูุดุงูู:
1. ุงุณุชุฎุฏู ุฃูุฑ `/start` ูู ุงูุจูุช
2. ุฑุงุฌุน ููู `context.json` ูููุฒูุฏ ูู ุงูุชูุงุตูู
3. ุชุญูู ูู ุณุฌูุงุช `trading_bot.log`

---

## ๐ ููุงุญุธุงุช ูุงูุฉ

โ๏ธ **ุชูุจููุงุช ุงูุฃูุงู**:
- ุงุญูุธ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุงูุชุธุงู
- ูุง ุชุดุงุฑู API Keys ูุน ุฃู ุดุฎุต
- ุงุณุชุฎุฏู ุญุณุงุจุงุช ุชุฌุฑูุจูุฉ ููุงุฎุชุจุงุฑ ุฃููุงู

โ **ุฃูุถู ุงูููุงุฑุณุงุช**:
- ุญุฏุฏ ุฏุงุฆูุงู Stop Loss ูุญูุงูุฉ ุฑุฃุณ ุงููุงู
- ุงุณุชุฎุฏู ุงูุฅุบูุงู ุงูุฌุฒุฆู ูุชุฃููู ุงูุฃุฑุจุงุญ
- ุฑุงุฌุน ุงูุตููุงุช ุงูููุชูุญุฉ ุจุงูุชุธุงู
- ุงุฎุชุจุฑ ุงูุงุณุชุฑุงุชูุฌูุงุช ุนูู ุงูุญุณุงุจ ุงูุชุฌุฑูุจู ุฃููุงู

---

## ๐ ุฎุงุชูุฉ

ูุธุงู ุฅุฏุงุฑุฉ ุงูุตููุงุช ุงููุชูุฏู ูููุฑ ูู:
- โ **ุชุญูู ูุงูู** ูู ุตููุงุชู
- โ **ูุฑููุฉ ุนุงููุฉ** ูู ุฅุฏุงุฑุฉ ุงููุฎุงุทุฑ
- โ **ุนุฒู ุชุงู** ุจูู ุงููุณุชุฎุฏููู
- โ **ุชูุงูู ุณูุณ** ูุน ุงูุจูุช ุงูุญุงูู

ุงุณุชูุชุน ุจุงูุชุฏุงูู ุงูุขูู ูุงููุฑุจุญ! ๐๐

---

**ุงูุฅุตุฏุงุฑ**: 1.0.0  
**ุขุฎุฑ ุชุญุฏูุซ**: ุฃูุชูุจุฑ 2025  
**ุงููุทูุฑ**: Bybit Trading Bot Team
